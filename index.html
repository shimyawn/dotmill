<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOTMILL Guestbook</title>
    
    <!-- Pretendard Web Font -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <!-- [NEW] ê·€ì—¬ìš´ ê¸€ì”¨ì²´ (Gaegu) -->
    <link href="https://fonts.googleapis.com/css2?family=Gaegu:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { 
            margin: 0; overflow: hidden; background-color: #ffffff; 
            font-family: 'Pretendard', sans-serif; 
            user-select: none; -webkit-user-select: none; 
            touch-action: none; /* ëª¨ë°”ì¼ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }
        canvas { display: block; }
        
        /* UI ë ˆì´ì•„ì›ƒ */
        #ui { position: absolute; top: 30px; left: 30px; pointer-events: none; color: #333; z-index: 10; transition: all 0.3s; display: flex; flex-direction: column; align-items: flex-start; gap: 8px; }
        
        /* ì‹œë®¬ë ˆì´ì…˜ ì»¨íŠ¸ë¡¤ */
        #sim-controls { display: flex; gap: 6px; pointer-events: auto; }
        #sim-controls button {
            background: rgba(255, 255, 255, 0.95); border: 1px solid #cbd5e1; border-radius: 8px;
            padding: 8px 14px; cursor: pointer; font-size: 0.9rem; color: #334155;
            font-weight: 700; font-family: 'Pretendard'; transition: all 0.2s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; align-items: center; justify-content: center;
            min-width: 40px;
        }
        #sim-controls button:hover { background: #fff; color: #0ea5e9; border-color: #0ea5e9; transform: translateY(-1px); }
        #sim-controls button:active { transform: translateY(0); }
        
        /* ë„ì›€ë§ ë²„íŠ¼ í™œì„± ìƒíƒœ */
        #btn-help.active { background: #e0f2fe; color: #0ea5e9; border-color: #0ea5e9; }
        /* [NEW] ì•ˆë‚´ í† ê¸€ ë²„íŠ¼ í™œì„± ìƒíƒœ */
        #btn-guide-toggle.active { background: #e0f2fe; color: #0ea5e9; border-color: #0ea5e9; }

        .warning-txt { color: #ea580c; font-weight: 600; background: #fff7ed; padding: 8px; border-radius: 8px; margin-top: 5px; font-size: 0.75rem; }

        /* ìš°í¸í•¨ ì•„ì´ì½˜ */
        #mailbox-icon {
            position: absolute; right: 30px; bottom: 210px; width: 40px; height: 50px;
            background: #ef4444; border: 4px solid #7f1d1d; border-radius: 8px 8px 0 0;
            cursor: pointer; z-index: 25; box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        #mailbox-icon:active { transform: scale(0.95); }
        #mailbox-icon::after { content: ''; position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 20px; height: 6px; background: #7f1d1d; border-radius: 2px; }
        #mailbox-icon::before { content: ''; position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); width: 8px; height: 20px; background: #333; z-index: -1; }
        #mailbox-text {
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px;
            font-size: 11px; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }
        #mailbox-icon:hover #mailbox-text { opacity: 1; }

        .green-txt { color: #00e676; font-weight: 700; }
        .blue-txt { color: #2979ff; font-weight: 700; }
        .yellow-txt { color: #ef4444; font-weight: 700; } 
        .gray-txt { color: #555; font-weight: 700; }

        /* ì•ˆë‚´ ë©˜íŠ¸ (ìš°ì¸¡ ìƒë‹¨) - PC ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        #guide-text {
            position: absolute; top: 30px; right: 30px; text-align: right; color: #444; pointer-events: auto; z-index: 10;
            background: rgba(255,255,255,0.9); padding: 18px 22px; border-radius: 16px; backdrop-filter: blur(8px); 
            box-shadow: 0 4px 20px rgba(0,0,0,0.08); letter-spacing: -0.01em; border: 1px solid rgba(255,255,255,0.5);
            cursor: pointer; user-select: none;
            transition: all 0.3s ease;
        }
        #guide-text h2 { margin: 0 0 10px 0; font-size: 1.1rem; color: #1e293b; font-weight: 800; }
        #guide-text p { margin: 0; font-size: 0.9rem; line-height: 1.6; color: #475569; font-weight: 500; word-break: keep-all; }

        /* ëª¨ë°”ì¼ ì „ìš© ë²„íŠ¼ ê¸°ë³¸ ìˆ¨ê¹€ */
        .mobile-only { display: none !important; }

        /* í”ë“¤ë¦¼ ì• ë‹ˆë©”ì´ì…˜ */
        .shake { animation: shake 0.3s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        /* ì•Œë¦¼ì°½ */
        #custom-alert { display: none; position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px 40px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 200; text-align: center; border: 1px solid #eee; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 80%; max-width: 320px; }
        #custom-alert h3 { margin: 0 0 10px 0; color: #2c3e50; font-weight: 700; font-size: 1.3rem; }
        #pc-toast { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(30, 41, 59, 0.9); color: white; padding: 12px 24px; border-radius: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 300; text-align: center; font-size: 0.9rem; pointer-events: none; animation: fadeInOut 2.5s ease forwards; }

        /* [NEW] ë¡œë”© ì˜¤ë²„ë ˆì´ & ì„œë²„ ì—ëŸ¬ ëª¨ë‹¬ */
        #loading-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.85); z-index: 2000;
            flex-direction: column; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .spinner {
            width: 50px; height: 50px; border: 5px solid #e2e8f0; border-top: 5px solid #0ea5e9;
            border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        #loading-text { font-size: 1.1rem; font-weight: 700; color: #334155; text-align: center; line-height: 1.5; }
        
        #server-error-modal {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 30px 40px; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.2);
            z-index: 2100; text-align: center; border: 1px solid #f1f1f1; flex-direction: column; align-items: center;
            width: 85%; max-width: 360px; animation: popIn 0.3s ease;
        }
        #server-error-modal h3 { margin: 0 0 10px 0; color: #ef4444; font-size: 1.3rem; }
        #server-error-modal p { color: #475569; font-size: 0.95rem; line-height: 1.6; margin-bottom: 20px; }
        #server-error-modal .sub-text { font-size: 0.85rem; color: #94a3b8; margin-top: -10px; }
        #server-error-modal button { 
            background: #1e293b; color: white; border: none; padding: 10px 20px; border-radius: 12px;
            font-weight: 700; cursor: pointer; transition: transform 0.1s; font-family: 'Pretendard';
        }
        #server-error-modal button:hover { background: #334155; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }


        /* í†µí•© ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-window { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 800px; height: 600px; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); z-index: 100; flex-direction: column; overflow: hidden; border: 1px solid #f1f1f1; animation: fadeIn 0.3s ease; max-width: 90%; max-height: 90%; }
        
        .modal-header { padding: 15px 20px; background: #fff; border-bottom: 1px solid #f1f1f1; display: flex; justify-content: space-between; align-items: center; z-index: 10; position: relative;}
        
        .main-tabs { display: flex; gap: 8px; background: #f1f5f9; padding: 4px; border-radius: 12px; }
        .tab-btn {
            border: none; background: transparent; padding: 8px 16px; border-radius: 8px;
            font-size: 0.9rem; font-weight: 600; color: #64748b; cursor: pointer; transition: all 0.2s;
            font-family: 'Pretendard';
        }
        .tab-btn.active { background: white; color: #0f172a; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .tab-btn:hover:not(.active) { color: #334155; }

        .close-modal-btn { cursor: pointer; font-size: 1.8rem; color: #94a3b8; line-height: 1; margin-left: 10px; }
        
        .tab-content { flex: 1; display: flex; flex-direction: column; overflow: hidden; height: 100%; }

        .empty-msg { text-align: center; padding: 40px; color: #94a3b8; font-size: 0.95rem; grid-column: span 3; }
        
        #my-msg-auth { padding: 20px; background: #fff; border-bottom: 1px solid #e2e8f0; display: flex; gap: 10px; z-index: 10; position: relative; }
        #my-name-input { flex: 1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; font-family: 'Pretendard'; }
        #my-msg-btn { background: #0ea5e9; color: white; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: 'Pretendard'; }
        
        #mailbox-content-area { 
            flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; height: 100%; 
            /* [NEW] ë°¤í•˜ëŠ˜ ë°°ê²½ ì ìš© */
            background: linear-gradient(to bottom, #0f172a, #1e293b);
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
        }
        #mailbox-placeholder { margin-top: 50px; text-align: center; color: #cbd5e1; line-height: 1.6; }
        
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 90; backdrop-filter: blur(4px); }

        /* [NEW] í¬ìŠ¤íŠ¸ì‡ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ */
        .post-it-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr); /* 3ì—´ */
            gap: 15px;
            padding: 20px;
            overflow-y: auto;
            align-content: flex-start;
        }

        .post-it-card {
            background-color: #fff;
            padding: 15px;
            border-radius: 2px 2px 15px 2px; /* í¬ìŠ¤íŠ¸ì‡ ëŠë‚Œ */
            box-shadow: 2px 2px 8px rgba(0,0,0,0.05);
            font-family: 'Gaegu', cursive;
            display: flex;
            flex-direction: column;
            gap: 10px;
            position: relative;
            transition: transform 0.2s;
            min-height: 140px; /* ìµœì†Œ ë†’ì´ */
            height: auto; /* ë‚´ìš©ì— ë”°ë¼ ëŠ˜ì–´ë‚¨ */
            align-self: start; /* ê·¸ë¦¬ë“œ ë‚´ì—ì„œ ë‚´ìš©ë§Œí¼ë§Œ ë†’ì´ ì°¨ì§€ */
            color: #333;
        }
        .post-it-card:hover { transform: translateY(-3px); box-shadow: 2px 6px 12px rgba(0,0,0,0.1); z-index: 5; }
        
        .post-it-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px dashed rgba(0,0,0,0.1);
            padding-bottom: 8px;
        }
        
        .sender-info { display: flex; align-items: center; gap: 8px; }
        .mini-avatar-canvas { width: 30px; height: 30px; border-radius: 50%; background: rgba(255,255,255,0.5); }
        .sender-name { font-weight: 700; font-size: 1.1rem; color: #475569; }
        .post-date { font-size: 0.8rem; color: rgba(0,0,0,0.4); }
        
        .post-body {
            font-size: 1.15rem;
            line-height: 1.4;
            word-break: break-all;
            flex: 1;
        }

        /* [NEW] ì „ì†¡ ì• ë‹ˆë©”ì´ì…˜ìš© ìš”ì†Œ (Updated Style) */
        #flying-envelope {
            position: fixed;
            z-index: 9999;
            width: 60px;
            height: 40px;
            pointer-events: none;
            display: none;
            filter: drop-shadow(2px 4px 6px rgba(0,0,0,0.15));
        }

        #input-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 620px; background: rgba(255, 255, 255, 0.95); padding: 8px 12px; border-radius: 50px; box-shadow: 0 10px 40px rgba(0,0,0,0.12); display: flex; align-items: center; gap: 8px; z-index: 30; border: 1px solid #e2e8f0; backdrop-filter: blur(10px); transition: all 0.5s ease; }
        
        /* ì…ë ¥ì°½ì´ ì ‘íˆëŠ” ì• ë‹ˆë©”ì´ì…˜ í´ë˜ìŠ¤ */
        .input-bar-folding {
            width: 50px !important;
            height: 50px !important;
            border-radius: 50% !important;
            padding: 0 !important;
            opacity: 0;
            overflow: hidden;
            transform: scale(0.1) translateX(-500%); /* ì‚¬ë¼ì§€ëŠ” íš¨ê³¼ */
        }
        .input-elements-hidden { display: none !important; }

        .to-all-wrapper { display: flex; align-items: center; white-space: nowrap; font-size: 14px; font-weight: 600; color: #475569; margin-right: 2px; cursor: pointer; user-select: none; }
        .to-all-wrapper input { margin-right: 4px; accent-color: #0ea5e9; width: 16px; height: 16px; cursor: pointer; }

        #receiver-input { width: 80px; padding: 12px; border: none; border-radius: 25px; background: #e0f2fe; text-align: center; outline: none; font-size: 15px; font-family: 'Pretendard', sans-serif; font-weight: 600; color: #0369a1; transition: all 0.2s; } 
        #receiver-input::placeholder { color: #7dd3fc; font-weight: 500; }
        #receiver-input:disabled { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; }

        #msg-input { flex: 1; padding: 12px 16px; border: none; border-radius: 25px; background: #f1f5f9; outline: none; font-size: 16px; font-family: 'Pretendard', sans-serif; color: #334155; }
        #send-btn { background: #0ea5e9; color: white; border: none; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: background 0.2s, transform 0.1s; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3); flex-shrink: 0; }
        #send-btn:hover { background: #0284c7; transform: scale(1.05); }
        #send-btn:active { transform: scale(0.95); }
        #send-btn:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; }

        #style-group { position: relative; display: flex; align-items: center; }
        #style-toggle-btn {
            width: 42px; height: 42px; border-radius: 50%; border: 1px solid #cbd5e1; background: #fff;
            color: #64748b; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        #style-toggle-btn:hover { background: #f1f5f9; color: #334155; }
        #style-toggle-btn.active { background: #e0f2fe; color: #0ea5e9; border-color: #0ea5e9; }

        #style-options {
            position: absolute; bottom: 55px; left: 0; 
            background: white; padding: 8px; border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;
            display: none; flex-direction: column; gap: 8px;
            animation: popIn 0.2s ease;
        }
        #style-options.show { display: flex; }
        
        .style-opt-btn {
            width: 40px; height: 40px; border-radius: 12px; border: 1px solid #e2e8f0;
            background: #f8fafc; cursor: pointer; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .style-opt-btn:hover { background: #f1f5f9; }
        
        .style-indicator {
            position: absolute; bottom: -2px; right: -2px;
            width: 16px; height: 16px; border-radius: 50%;
            background: #333; border: 2px solid white;
            font-size: 10px; color: white; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-family: 'Pretendard', sans-serif;
        }

        /* [NEW] íŠœí† ë¦¬ì–¼ ê´€ë ¨ ìŠ¤íƒ€ì¼ */
        #tutorial-backdrop {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7); z-index: 8000;
        }
        .tutorial-modal {
            display: none; position: fixed; /* [FIX] absolute -> fixed */
            background: white; padding: 25px; border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4); width: 280px; text-align: center;
            z-index: 10001; /* [FIX] ìµœìƒìœ„ ë ˆì´ì–´ */
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            left: 50%; top: 50%; transform: translate(-50%, -50%);
        }
        .tutorial-modal h3 { margin: 0 0 10px 0; color: #0f172a; font-size: 1.2rem; }
        .tutorial-modal p { color: #64748b; line-height: 1.5; margin-bottom: 20px; word-break: keep-all; font-size: 0.9rem; }
        .tutorial-btn {
            background: #0ea5e9; color: white; border: none; padding: 10px 24px;
            border-radius: 12px; font-weight: 700; cursor: pointer; font-family: 'Pretendard';
            transition: transform 0.1s;
        }
        .tutorial-btn:hover { background: #0284c7; transform: scale(1.05); }
        /* í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼ í´ë˜ìŠ¤ */
        .highlight-target {
            position: relative; z-index: 10000 !important; /* [FIX] íŠœí† ë¦¬ì–¼ ë°°ê²½ë³´ë‹¤ ìœ„ */
            background-color: rgba(255,255,255,0.95); /* ë°°ê²½ì´ íˆ¬ëª…í•  ê²½ìš°ë¥¼ ëŒ€ë¹„ */
            border-radius: 16px; /* ë‘¥ê·¼ ëª¨ì„œë¦¬ ë³´ì • */
            box-shadow: 0 0 0 4px #0ea5e9, 0 0 20px rgba(14, 165, 233, 0.5); /* ê°•ì¡° í…Œë‘ë¦¬ */
            transition: all 0.3s;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -45%); } to { opacity: 1; transform: translate(-50%, -50%); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translate(-50%, -40%); } 10% { opacity: 1; transform: translate(-50%, -50%); } 90% { opacity: 1; transform: translate(-50%, -50%); } 100% { opacity: 0; transform: translate(-50%, -60%); } }

        /* [FIXED] ëª¨ë°”ì¼ ì „ìš© ë°˜ì‘í˜• ìŠ¤íƒ€ì¼ */
        @media (max-width: 768px) {
            /* 1. ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë°” ìœ„ì¹˜ ë° ë ˆì´ì•„ì›ƒ ì¡°ì • */
            #ui { 
                top: 15px; 
                left: 50%; 
                transform: translateX(-50%); 
                width: 95%; 
                flex-direction: row; /* ê°€ë¡œ ë°°ì¹˜ */
                justify-content: center; /* ì¤‘ì•™ ì •ë ¬ */
                align-items: center; 
                gap: 5px;
            }
            
            /* 2. ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
            #sim-controls { 
                justify-content: center; 
                gap: 5px;
                width: auto;
            }
            #sim-controls button {
                padding: 6px 10px; 
                font-size: 0.85rem; 
                min-width: 34px; 
                height: 36px;
                box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            }

            /* 3. ëª¨ë°”ì¼ìš© ê°€ì´ë“œ í† ê¸€ ë²„íŠ¼ í‘œì‹œ */
            .mobile-only { display: flex !important; }

            /* 4. ê¸°ì¡´ ê°€ì´ë“œ í…ìŠ¤íŠ¸ ë°•ìŠ¤ ìˆ¨ê¹€ (ë²„íŠ¼ìœ¼ë¡œ í† ê¸€) */
            #guide-text { 
                display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
                top: 60px; /* ë²„íŠ¼ë“¤ ì•„ë˜ ìœ„ì¹˜ */
                left: 50%; 
                right: auto;
                transform: translateX(-50%); 
                width: 85%; 
                text-align: center;
                padding: 15px;
                font-size: 0.85rem;
                z-index: 100; /* ë‹¤ë¥¸ ìš”ì†Œë³´ë‹¤ ìœ„ì— */
            }
            #guide-text.show { display: block; animation: popIn 0.3s ease; }
            #guide-text h2 { font-size: 1rem; margin-bottom: 5px; }
            #guide-text p { font-size: 0.85rem; }

            /* 5. ìš°í¸í•¨ ì•„ì´ì½˜ ìœ„ì¹˜ ì¡°ì • */
            #mailbox-icon { right: 20px; bottom: 200px; }
            
            /* 6. ì…ë ¥ë°” ì¡°ì • */
            #input-bar { bottom: 20px; width: 95%; padding: 8px; gap: 6px; }
            .to-all-wrapper { font-size: 13px; }
            #receiver-input { width: 50px; font-size: 13px; }
            #msg-input { font-size: 14px; }
            #send-btn { width: 36px; height: 36px; font-size: 1rem; }
            #style-toggle-btn { width: 36px; height: 36px; font-size: 1.1rem; }
            
            /* 7. ëª¨ë‹¬ ì¡°ì • */
            .modal-window { width: 340px; height: 500px; }
            .post-it-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 10px; }
            .post-it-card { min-height: 120px; padding: 12px; }
            .sender-name { font-size: 0.9rem; }
            .post-body { font-size: 0.95rem; }
        }
    </style>
</head>
<body>

    <div id="ui">
        <!-- ì†ë„ ë° ì¼ì‹œì •ì§€ ì»¨íŠ¸ë¡¤ + ì˜¤ë””ì˜¤ + íŠœí† ë¦¬ì–¼ + ë¦¬ì…‹ -->
        <div id="sim-controls">
            <button onclick="togglePause()" id="btn-pause" title="ì¼ì‹œì •ì§€/ì¬ìƒ">â¸</button>
            <button onclick="toggleSpeed()" id="btn-speed" title="ì†ë„ ì¡°ì ˆ">1x</button>
            <button onclick="resetSimulation()" id="btn-reset" title="ì‘ì—… ì´ˆê¸°í™”">ğŸ”„</button>
            <button id="btn-audio" title="ë°°ê²½ìŒì•… On/Off">ğŸ”‡</button>
            <button onclick="restartTutorial()" id="btn-help" title="íŠœí† ë¦¬ì–¼ ë‹¤ì‹œë³´ê¸°">?</button>
            <!-- [NEW] ëª¨ë°”ì¼ìš© ê°€ì´ë“œ í† ê¸€ ë²„íŠ¼ -->
            <button onclick="toggleGuideText()" id="btn-guide-toggle" class="mobile-only" title="ì•ˆë‚´ ë³´ê¸°">ğŸ“œ</button>
        </div>
    </div>

    <div id="mailbox-icon" title="ë‚´ ìš°í¸í•¨ í™•ì¸í•˜ê¸°" onclick="openMyMsgModal()">
        <div id="mailbox-text">ë‚´ ìš°í¸í•¨</div>
    </div>

    <!-- ìš°ì¸¡ ìƒë‹¨ ì•ˆë‚´ í…ìŠ¤íŠ¸ (ëª¨ë°”ì¼ì—ì„œëŠ” ê¸°ë³¸ ìˆ¨ê¹€, ë²„íŠ¼ìœ¼ë¡œ í† ê¸€) -->
    <div id="guide-text" onclick="handleGuideClick()">
        <h2>2026 ë‹·ë°€ ì‹ ë…„ë§ì´ ë¡¤ë§í˜ì´í¼ ğŸ“œ</h2>
        <p>
            ì—¬ê¸°ëŠ” DOTì„ êµ´ë ¤ ë©‹ì§„ ê²ƒë“¤ì„ ë§Œë“œëŠ” ë°©ì•—ê°„, DOTMILLì…ë‹ˆë‹¤.<br>
            í™”ë©´ì— ë³´ì´ëŠ” ë™ë£Œë“¤ì„ í´ë¦­í•´ì„œ íœ´ì‹ì„ ì„ ë¬¼í•˜ì„¸ìš”.<br>
            ê·¸ë¦¬ê³  ë™ë£Œë“¤ì—ê²Œ ìµëª…ìœ¼ë¡œ ë©”ì‹œì§€ë¥¼ ì „í•˜ì„¸ìš”.
        </p>
        <!-- [FIXED] ìš°ì¸¡ ìƒë‹¨ ì•ˆë‚´ í…ìŠ¤íŠ¸ ë‚´ ê²½ê³ ë¬¸ ì‚­ì œë¨ -->
    </div>

    <div id="custom-alert">
        <span id="alert-check">âœ…</span>
        <h3>ì „ì†¡ ì™„ë£Œ!</h3>
        <p>ìµëª…ìœ¼ë¡œ ë©”ì‹œì§€ê°€ ë¬´ì‚¬íˆ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“¨</p>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ (ì‚­ì œëŠ” í•˜ì§€ ì•Šê³  ìœ ì§€í•˜ë˜, ì „ì†¡ì‹œì—ëŠ” ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ëŒ€ì²´ë¨) -->
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">ë°©ì•—ê°„ ëŒë¦¬ëŠ” ì¤‘...<br>ì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” ğŸ¹</div>
    </div>

    <!-- ì„œë²„ í­ì£¼ ì—ëŸ¬ ëª¨ë‹¬ -->
    <div id="server-error-modal">
        <h3>ë°©ì•—ê°„ì´ ë©ˆì·„ì–´ìš” ğŸ’¦</h3>
        <p>ë„ˆë¬´ ë§ì€ ì‚¬ëŒì´ ì ‘ì†í•´ì„œ<br>ë°©ì•—ê°„ì´ ì ì‹œ ë©ˆì·„ì–´ìš”... ğŸ˜µ</p>
        <p class="sub-text">5ë¶„ í›„ ìƒˆë¡œê³ ì¹¨í•´ì„œ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”!</p>
        <button onclick="location.reload()">ìƒˆë¡œê³ ì¹¨ ğŸ”„</button>
    </div>

    <div id="pc-toast">
        PCì—ì„œ ì ‘ì†í•˜ì‹œë©´ ìµœì í™”ëœ ê²½í—˜ì„ í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤ ğŸ’»
    </div>

    <div id="modal-overlay"></div>

    <!-- [NEW] íŠœí† ë¦¬ì–¼ ìš”ì†Œ -->
    <div id="tutorial-backdrop"></div>
    <div id="tutorial-modal" class="tutorial-modal">
        <h3 id="tuto-title">í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‘‹</h3>
        <p id="tuto-desc">2026 ë‹·ë°€ ì‹ ë…„ë§ì´ ë°©ëª…ë¡ì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤.</p>
        <button class="tutorial-btn" onclick="nextTutorial()">ë‹¤ìŒ</button>
    </div>

    <!-- í†µí•© ë©”ì‹œì§€ ëª¨ë‹¬ -->
    <div id="my-msg-modal" class="modal-window">
        <div class="modal-header">
            <!-- ë©”ì¸ íƒ­ -->
            <div class="main-tabs">
                <button class="tab-btn active" id="tab-my" onclick="setMailboxTab('MY')">ë‚´ ìš°í¸í•¨ ğŸ“¬</button>
                <button class="tab-btn" id="tab-all" onclick="setMailboxTab('ALL')">ì „ì²´ ë©”ì‹œì§€ ğŸ“œ</button>
            </div>
            
            <span class="close-modal-btn" data-target="my-msg-modal">Ã—</span>
        </div>

        <!-- TAB 1: ë‚´ ìš°í¸í•¨ ë‚´ìš© -->
        <div id="tab-content-my" class="tab-content">
            <div id="my-msg-auth">
                <input type="text" id="my-name-input" placeholder="ë³¸ì¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" onkeypress="if(event.key==='Enter') checkMyMessages()">
                <button id="my-msg-btn" onclick="checkMyMessages()">í™•ì¸</button>
            </div>
            <div id="mailbox-content-area">
                <div id="mailbox-placeholder">ì´ë¦„ì„ ì…ë ¥í•˜ê³  í™•ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.<br>(ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤)</div>
                <!-- [NEW] í¬ìŠ¤íŠ¸ì‡ ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ -->
                <div id="my-msg-grid" class="post-it-grid" style="display:none;"></div>
            </div>
        </div>

        <!-- TAB 2: ì „ì²´ ë©”ì‹œì§€ ë‚´ìš© -->
        <div id="tab-content-all" class="tab-content" style="display:none;">
            <!-- [NEW] ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì˜ì—­ -->
            <div style="padding: 15px; text-align: right; background: #fff; border-bottom: 1px solid #f1f5f9;">
                <button id="refresh-all-btn" onclick="renderAllMessages()" style="background: #f1f5f9; border: 1px solid #cbd5e1; padding: 6px 12px; border-radius: 8px; cursor: pointer; color: #64748b; font-weight: 600; font-size: 0.85rem; font-family: 'Pretendard'; display: inline-flex; align-items: center; gap: 4px;">
                    ğŸ”„ ìƒˆë¡œê³ ì¹¨
                </button>
            </div>
            <!-- [NEW] ì „ì²´ ë©”ì‹œì§€ ê·¸ë¦¬ë“œ ì»¨í…Œì´ë„ˆ -->
            <div id="all-msg-grid" class="post-it-grid"><div class="empty-msg">ë¡œë”© ì¤‘... â³</div></div>
        </div>
    </div>

    <!-- [NEW] ë‚ ì•„ê°€ëŠ” í¸ì§€ ìš”ì†Œ (ê°€ì‹œì„± ê°œì„ ) -->
    <div id="flying-envelope">
        <svg width="100%" height="100%" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z" fill="#fff8dc"></path>
            <polyline points="22,6 12,13 2,6"></polyline>
        </svg>
    </div>

    <div id="input-bar">
        <label class="to-all-wrapper" title="ì²´í¬í•˜ë©´ ëª¨ë‘ì—ê²Œ ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤">
            <input type="checkbox" id="to-all-check">
            <span>ëª¨ë‘</span>
        </label>
        
        <input type="text" id="receiver-input" placeholder="ë°›ëŠ”ë¶„" maxlength="5">
        
        <!-- ìŠ¤íƒ€ì¼ ì„¤ì • ë²„íŠ¼ ê·¸ë£¹ -->
        <div id="style-group">
            <button id="style-toggle-btn" title="ìºë¦­í„° ê¾¸ë¯¸ê¸°">ğŸ‘•</button>
            <div id="style-options">
                <div class="style-opt-btn" onclick="cycleStyle('hair')" title="í—¤ì–´ìŠ¤íƒ€ì¼">
                    ğŸ’‡â€â™€ï¸ <div class="style-indicator" id="ind-hair">ğŸ§‘</div>
                </div>
                <div class="style-opt-btn" onclick="cycleStyle('shirt')" title="ì˜· ìƒ‰ìƒ">
                    ğŸ¨ <div class="style-indicator" id="ind-shirt" style="background: #3b82f6;"></div>
                </div>
                <div class="style-opt-btn" onclick="cycleStyle('acc')" title="ì¥ì‹">
                    ğŸ€ <div class="style-indicator" id="ind-acc">âŒ</div>
                </div>
            </div>
        </div>

        <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ (ìµëª…)" autocomplete="off" maxlength="40">
        <button id="send-btn">â¤</button>
    </div>

    <canvas id="canvas"></canvas>

<script>
    // [ì¤‘ìš”] ì—¬ê¸°ì— ìƒˆë¡œ ë°°í¬í•˜ì‹  Google Apps Scriptì˜ URLì„ ë„£ì–´ì£¼ì„¸ìš”.
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwVUstSVxUqWBzLgxCoNUqRE02DVGa8dbjWFl6opbPqiqokuCjn9dEEf9qn6jrrW09QFA/exec";

    // --- [ì‚¬ìš´ë“œ] ---
    // [NEW] Carol, Correct ì¶”ê°€
    const audioFiles = {};
    const soundNames = ['bgm', 'sent', 'rest', 'pop', 'reset', 'carol', 'correct'];
    let isBgmOn = false; 
    
    soundNames.forEach(name => {
        const audio = new Audio(`sounds/${name}.mp3`);
        if(name === 'bgm') { audio.loop = true; audio.volume = 0.4; } 
        else if(name === 'carol') { audio.loop = true; audio.volume = 0.4; }
        else { audio.volume = name === 'reset' ? 1.0 : 0.8; if(name === 'pop') audio.volume = 0.5; }
        audioFiles[name] = audio;
    });

    // [NEW] BGM ì „í™˜ ë° ë³µêµ¬ ë¡œì§
    let fadeOutInterval = null;

    function switchBgmToCarol() {
        if (!isBgmOn) return; 

        const bgm = audioFiles['bgm'];
        const carol = audioFiles['carol'];
        const correct = audioFiles['correct'];

        // Carol ì¤€ë¹„
        carol.volume = 0.4;
        
        // 1. Correct íš¨ê³¼ìŒ ì¬ìƒ
        if (correct) {
            correct.volume = 0.8;
            correct.currentTime = 0;
            correct.play().catch(e => console.log(e));
            
            // 3. Correct ì¬ìƒì´ ëë‚œ í›„ Carol ì¬ìƒ
            correct.onended = () => {
                carol.play().catch(e => console.log(e));
            };
        } else {
            // íš¨ê³¼ìŒ ì—†ìœ¼ë©´ ë°”ë¡œ ìºë¡¤
            carol.play().catch(e => console.log(e));
        }

        // 2. ë™ì‹œì— ê¸°ì¡´ BGM í˜ì´ë“œ ì•„ì›ƒ
        if (fadeOutInterval) clearInterval(fadeOutInterval);
        
        fadeOutInterval = setInterval(() => {
            if (bgm.volume > 0.05) {
                bgm.volume -= 0.05;
            } else {
                clearInterval(fadeOutInterval);
                bgm.pause();
                bgm.volume = 0.4; // ë‹¤ìŒì„ ìœ„í•´ ë³µêµ¬
            }
        }, 200); 
    }

    const audioBtn = document.getElementById('btn-audio');
    audioBtn.addEventListener('click', () => {
        if (isBgmOn) {
            // ì†Œë¦¬ ë„ê¸°
            audioFiles['bgm'].pause(); 
            audioFiles['carol'].pause();
            if(audioFiles['correct']) audioFiles['correct'].pause();
            audioBtn.innerText = 'ğŸ”‡'; isBgmOn = false;
        } else {
            // ì†Œë¦¬ ì¼œê¸° (í˜„ì¬ ìƒíƒœì— ë”°ë¼ ê²°ì •)
            const targetAudio = isLogoComplete ? audioFiles['carol'] : audioFiles['bgm'];
            targetAudio.play().then(() => { audioBtn.innerText = 'ğŸ”Š'; isBgmOn = true; })
            .catch(e => { alert("ì†Œë¦¬ íŒŒì¼ì„ ë¡œë”© ì¤‘ì´ê±°ë‚˜ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); });
        }
    });
    
    function playSound(name) {
        if (isBgmOn && audioFiles[name]) { audioFiles[name].currentTime = 0; audioFiles[name].play().catch(e => {}); }
    }

    // [NEW] ëª¨ë°”ì¼ ê°€ì´ë“œ í† ê¸€ í•¨ìˆ˜
    function toggleGuideText() {
        const guideText = document.getElementById('guide-text');
        const btn = document.getElementById('btn-guide-toggle');
        
        guideText.classList.toggle('show');
        btn.classList.toggle('active');
        
        if (guideText.classList.contains('show')) {
            setTimeout(() => {
                guideText.classList.remove('show');
                btn.classList.remove('active');
            }, 5000); // 5ì´ˆ í›„ ìë™ ë‹«í˜
        }
    }

    // [NEW] íŠœí† ë¦¬ì–¼ ë¡œì§
    let tutoStep = 0;
    const tutorialSteps = [
        { title: "í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‘‹", desc: "ì´ê³³ì€ ë‹·ë°€ì˜ ë™ë£Œë“¤ê³¼ í•¨ê»˜í•˜ëŠ”<br>ì‹ ë…„ë§ì´ ë°©ëª…ë¡ ê³µê°„ì…ë‹ˆë‹¤.", target: null },
        { title: "ë©”ì‹œì§€ ë³´ë‚´ê¸° ğŸ“¨", desc: "ì´ê³³ì—ì„œ ë™ë£Œì˜ ì´ë¦„ì„ ì…ë ¥í•˜ê³ <br>ë”°ëœ»í•œ ìµëª… ë©”ì‹œì§€ë¥¼ ë³´ë‚´ë³´ì„¸ìš”!<br>ìºë¦­í„°ë„ ê¾¸ë°€ ìˆ˜ ìˆë‹µë‹ˆë‹¤.", target: "input-bar" },
        { title: "ìš°í¸í•¨ í™•ì¸ ğŸ“®", desc: "ë‚˜ì—ê²Œ ë„ì°©í•œ í¸ì§€ëŠ”<br>ì´ ìš°í¸í•¨ì„ ëˆŒëŸ¬ì„œ í™•ì¸í•  ìˆ˜ ìˆì–´ìš”.", target: "mailbox-icon" },
        // [NEW] ìš´ì˜ ì•ˆë‚´ ìŠ¤í… ì¶”ê°€
        { title: "âš ï¸ ìš´ì˜ ì•ˆë‚´", desc: "ìµëª…ìœ¼ë¡œ ì‘ì„±ë˜ëŠ” ë§Œí¼ ì„œë¡œì— ëŒ€í•œ<br><b>ì¡´ì¤‘ê³¼ ì˜ˆì˜</b>ë¥¼ ì§€ì¼œì£¼ì„¸ìš”.<br><br><span style='color:#ef4444; font-size:0.9em;'>ë¶€ì ì ˆí•œ ë‚´ìš©(ë¹„ë°©, ìš•ì„¤ ë“±) ë°œê²¬ ì‹œ<br>ì˜ˆê³  ì—†ì´ ì‚­ì œë˜ê±°ë‚˜ ìš´ì˜ì´ ì¤‘ë‹¨ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>", target: null },
        { title: "ì¦ê±°ìš´ ì‹œê°„ ë˜ì„¸ìš”! ğŸ‰", desc: "ë™ë£Œë“¤ì„ í´ë¦­í•´ì„œ íœ´ê°€ë¥¼ ì„ ë¬¼í•˜ì„¸ìš”!<br>ê·¸ë¦¬ê³  ì—´ì‹¬íˆ ì¼í•˜ëŠ” ë™ë£Œë“¤ì´<br>DOTì„ ëª¨ë‘ ì˜®ê²¨ ë¡œê³ ë¥¼ ì™„ì„±í•˜ë©´...<br>ë†€ë¼ìš´ ì¼ì´ ë²Œì–´ì§ˆì§€ë„ ëª°ë¼ìš”! ğŸ<br>ì, ì´ì œ ì‹œì‘í•´ë³¼ê¹Œìš”?", target: null }
    ];

    function runTutorial(force = false) {
        // ì´ë¯¸ ë³¸ ì‚¬ëŒì€ íŒ¨ìŠ¤ (localStorage ì‚¬ìš©), ë‹¨ forceê°€ trueë©´ ë¬´ì‹œí•˜ê³  ì‹¤í–‰
        if (!force && localStorage.getItem('dotmill_tutorial_seen_v1')) return;
        
        tutoStep = 0; // ì´ˆê¸°í™”
        document.getElementById('tutorial-backdrop').style.display = 'block';
        const modal = document.getElementById('tutorial-modal');
        modal.style.display = 'block';
        updateTutorialUI();
    }

    function restartTutorial() {
        runTutorial(true); // ê°•ì œ ì‹¤í–‰
    }

    function nextTutorial() {
        // ì´ì „ íƒ€ê²Ÿ í•˜ì´ë¼ì´íŠ¸ í•´ì œ
        if (tutoStep < tutorialSteps.length && tutorialSteps[tutoStep].target) {
            const prevTarget = document.getElementById(tutorialSteps[tutoStep].target);
            if(prevTarget) prevTarget.classList.remove('highlight-target');
        }
        
        tutoStep++;
        if (tutoStep >= tutorialSteps.length) {
            // ì¢…ë£Œ
            document.getElementById('tutorial-backdrop').style.display = 'none';
            document.getElementById('tutorial-modal').style.display = 'none';
            localStorage.setItem('dotmill_tutorial_seen_v1', 'true');
            playSound('pop'); 
        } else {
            updateTutorialUI();
        }
    }

    function updateTutorialUI() {
        const step = tutorialSteps[tutoStep];
        document.getElementById('tuto-title').innerHTML = step.title;
        document.getElementById('tuto-desc').innerHTML = step.desc;
        
        const modal = document.getElementById('tutorial-modal');
        
        if (step.target) {
            const targetEl = document.getElementById(step.target);
            if (targetEl) {
                targetEl.classList.add('highlight-target');
                
                // ëª¨ë‹¬ ìœ„ì¹˜ ì¡°ì • (íƒ€ê²Ÿ ê·¼ì²˜)
                const rect = targetEl.getBoundingClientRect();
                let top = rect.top - 160; // íƒ€ê²Ÿ ìœ„ìª½
                if (top < 50) top = rect.bottom + 20; // ê³µê°„ ì—†ìœ¼ë©´ ì•„ë˜ìª½
                
                modal.style.top = top + 'px';
                modal.style.left = '50%';
                modal.style.transform = 'translate(-50%, 0)';
            }
        } else {
            // íƒ€ê²Ÿ ì—†ìœ¼ë©´ ì¤‘ì•™ ì •ë ¬
            modal.style.top = '50%';
            modal.style.left = '50%';
            modal.style.transform = 'translate(-50%, -50%)';
        }
    }

    const receiverInput = document.getElementById('receiver-input'); 
    const msgInput = document.getElementById('msg-input');
    const sendBtn = document.getElementById('send-btn');
    const toAllCheck = document.getElementById('to-all-check'); 
    const myMsgModal = document.getElementById('my-msg-modal');
    const overlay = document.getElementById('modal-overlay');
    const closeBtns = document.querySelectorAll('.close-modal-btn');
    const myNameInput = document.getElementById('my-name-input');
    const customAlert = document.getElementById('custom-alert');
    const loadingOverlay = document.getElementById('loading-overlay');
    const serverErrorModal = document.getElementById('server-error-modal');

    // [ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ë°ì´í„°]
    const CUSTOM_SHIRT_COLORS = [
        '#3b82f6', '#1e293b', '#64748b', // Blue, Black, Gray (ê¸°ì¡´)
        '#ef4444', '#f97316', '#eab308', // Red, Orange, Yellow
        '#22c55e', '#0ea5e9', '#6366f1', '#a855f7' // Green, Sky, Indigo, Purple
    ];
    // [NEW] íŒŒìŠ¤í…”í†¤ ë°°ê²½ìƒ‰ (í¸ì§€ì§€ìš©)
    const CUSTOM_SHIRT_LIGHT_COLORS = [
        '#dbeafe', '#f1f5f9', '#f8fafc', 
        '#fee2e2', '#ffedd5', '#fef9c3', 
        '#dcfce7', '#e0f2fe', '#e0e7ff', '#f3e8ff' 
    ];

    const HAIR_ICONS = ['ğŸ§‘', 'ğŸ¦±', 'ğŸ‘±', 'ğŸ‘©']; // 4 styles
    const ACC_ICONS = ['âŒ', 'ğŸ„', 'ğŸŒ¸']; // 3 styles (Lantern -> Flower)

    let currentStyle = { hair: 0, shirt: 0, acc: 0 };

    const styleToggleBtn = document.getElementById('style-toggle-btn');
    const styleOptions = document.getElementById('style-options');
    const indHair = document.getElementById('ind-hair');
    const indShirt = document.getElementById('ind-shirt');
    const indAcc = document.getElementById('ind-acc');

    styleToggleBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        styleOptions.classList.toggle('show');
        styleToggleBtn.classList.toggle('active');
    });

    window.addEventListener('click', (e) => {
        if (!e.target.closest('#style-group')) {
            styleOptions.classList.remove('show');
            styleToggleBtn.classList.remove('active');
        }
    });

    function cycleStyle(type) {
        if (type === 'hair') {
            currentStyle.hair = (currentStyle.hair + 1) % HAIR_ICONS.length;
            indHair.innerText = HAIR_ICONS[currentStyle.hair];
        } else if (type === 'shirt') {
            currentStyle.shirt = (currentStyle.shirt + 1) % CUSTOM_SHIRT_COLORS.length;
            indShirt.style.backgroundColor = CUSTOM_SHIRT_COLORS[currentStyle.shirt];
        } else if (type === 'acc') {
            currentStyle.acc = (currentStyle.acc + 1) % ACC_ICONS.length;
            indAcc.innerText = ACC_ICONS[currentStyle.acc];
        }
    }

    let currentMailboxTab = 'MY'; // 'MY' or 'ALL'

    window.setMailboxTab = (tab) => {
        currentMailboxTab = tab;
        const tabMy = document.getElementById('tab-my');
        const tabAll = document.getElementById('tab-all');
        const contentMy = document.getElementById('tab-content-my');
        const contentAll = document.getElementById('tab-content-all');

        if (tab === 'MY') {
            tabMy.classList.add('active');
            tabAll.classList.remove('active');
            contentMy.style.display = 'flex';
            contentAll.style.display = 'none';
        } else {
            tabMy.classList.remove('active');
            tabAll.classList.add('active');
            contentMy.style.display = 'none';
            contentAll.style.display = 'flex';
            renderAllMessages();
        }
    }

    const mbPlaceholder = document.getElementById('mailbox-placeholder');
    const mbGrid = document.getElementById('my-msg-grid');

    toAllCheck.addEventListener('change', (e) => {
        if (e.target.checked) {
            receiverInput.disabled = true; receiverInput.value = ''; receiverInput.placeholder = 'ì „ì²´';
        } else {
            receiverInput.disabled = false; receiverInput.placeholder = 'ë°›ëŠ”ë¶„';
        }
    });

    function showCustomAlert() {
        customAlert.style.display = 'block'; setTimeout(() => { customAlert.style.display = 'none'; }, 2500);
    }

    function showServerError() {
        loadingOverlay.style.display = 'none';
        serverErrorModal.style.display = 'flex';
        overlay.style.display = 'block';
    }

    async function sendMessage() {
        let receiver = '';
        const rawName = receiverInput.value.trim();

        if (toAllCheck.checked) {
            receiver = 'ALL';
        } else {
            const namePattern = /^[ê°€-í£]{3}$/;
            if (!namePattern.test(rawName)) return alert("ë°›ëŠ” ë¶„ì˜ ì •í™•í•œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(í•œê¸€ 3ê¸€ì)");
            receiver = rawName;
        }

        const text = msgInput.value.trim();
        if (!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        
        sendBtn.disabled = true; 
        const originalPlaceholder = msgInput.placeholder;
        msgInput.value = ''; msgInput.placeholder = 'ì „ì†¡ ì¤‘... ğŸš€';
        
        const styleData = JSON.stringify(currentStyle);
        const finalPayload = { name: receiver, text: text, style: styleData };

        // [NEW] ì „ì†¡ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        const inputBar = document.getElementById('input-bar');
        const inputChildren = inputBar.children;
        const flyingEnv = document.getElementById('flying-envelope');
        const mailboxIcon = document.getElementById('mailbox-icon');

        // 1. ì…ë ¥ë°” ì ‘ê¸°
        for(let c of inputChildren) c.classList.add('input-elements-hidden');
        inputBar.classList.add('input-bar-folding');

        // 2. í¸ì§€ ë‚ ë¦¬ê¸° ì• ë‹ˆë©”ì´ì…˜
        // ì…ë ¥ë°” ìœ„ì¹˜ì—ì„œ ì‹œì‘
        const startRect = inputBar.getBoundingClientRect();
        const endRect = mailboxIcon.getBoundingClientRect();
        
        // ì‹œì‘ì : ì…ë ¥ë°”ì˜ ì¤‘ì•™
        const startX = startRect.left + startRect.width / 2;
        const startY = startRect.top;

        // ë„ì°©ì : ìš°í¸í•¨ ì•„ì´ì½˜ì˜ ì¤‘ì•™
        const endX = endRect.left + endRect.width / 2;
        const endY = endRect.top + endRect.height / 2;

        const envWidth = 60; // í¸ì§€ ë„ˆë¹„ (CSSì™€ ì¼ì¹˜)
        
        flyingEnv.style.display = 'block';
        // í¸ì§€ ìš”ì†Œ ìì²´ë¥¼ ì‹œì‘ì  ì¤‘ì•™ì— ë°°ì¹˜
        flyingEnv.style.left = (startX - envWidth/2) + 'px';
        flyingEnv.style.top = (startY) + 'px';
        flyingEnv.style.transform = 'scale(1)';
        flyingEnv.style.opacity = '1';
        
        // ì´ë™ ê±°ë¦¬ ê³„ì‚°
        const deltaX = endX - startX;
        const deltaY = endY - startY;
        
        // ì• ë‹ˆë©”ì´ì…˜ ì •ì˜ (JSë¡œ ë™ì  ìœ„ì¹˜ ê³„ì‚°)
        const animKeyframes = [
            { transform: 'translate(0, 0) scale(1) rotate(0deg)', opacity: 1 },
            // ì¤‘ê°„ ê²½ë¡œ (ì‚´ì§ ìœ„ë¡œ ì†Ÿì•˜ë‹¤ê°€)
            { transform: `translate(${deltaX * 0.5}px, ${deltaY - 100}px) scale(0.8) rotate(10deg)`, opacity: 1, offset: 0.5 },
            // ë„ì°©ì  (ìš°í¸í•¨ ì¤‘ì•™ìœ¼ë¡œ ì™ ë“¤ì–´ê°)
            { transform: `translate(${deltaX}px, ${deltaY}px) scale(0.1) rotate(0deg)`, opacity: 0 }
        ];

        // 4ì´ˆ ë™ì•ˆ ì• ë‹ˆë©”ì´ì…˜ + Fetch ë™ì‹œ ì§„í–‰
        const animPromise = flyingEnv.animate(animKeyframes, { duration: 4000, fill: 'forwards', easing: 'ease-in-out' }).finished;
        
        const fetchPromise = (async () => {
             const performFetch = async (retries = 3, delay = 1500) => {
                try {
                    await fetch(GOOGLE_SCRIPT_URL, { 
                        method: 'POST', 
                        mode: 'no-cors', 
                        cache: 'no-cache', 
                        headers: { 'Content-Type': 'text/plain;charset=utf-8' }, 
                        body: JSON.stringify(finalPayload) 
                    });
                } catch (err) {
                    if (retries > 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return performFetch(retries - 1, delay * 2);
                    } else { throw err; }
                }
            };
            await performFetch();
        })();

        try {
            await Promise.all([animPromise, fetchPromise]);
            
            // ì „ì†¡ ì™„ë£Œ í›„
            if (window.distributeSingleMessage) {
                window.distributeSingleMessage({ 
                    name: receiver, 
                    text: text, 
                    style: { ...currentStyle } 
                });
            }
            playSound('sent'); 
            showCustomAlert();
            if (!toAllCheck.checked) receiverInput.value = ''; 

        } catch (error) { 
            console.error("Final failure:", error);
            showServerError(); 
        } finally { 
            // UI ë³µêµ¬
            sendBtn.disabled = false; 
            msgInput.placeholder = originalPlaceholder; 
            
            flyingEnv.style.display = 'none';
            inputBar.classList.remove('input-bar-folding');
            for(let c of inputChildren) c.classList.remove('input-elements-hidden');
            
            msgInput.focus(); 
        }
    }

    async function renderAllMessages() {
        const container = document.getElementById('all-msg-grid');
        container.innerHTML = '<div class="empty-msg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...<br>(ì•½ 1~2ì´ˆ ì†Œìš”)</div>';
        try {
            // [FIXED] ìºì‹œ ë°©ì§€ë¥¼ ìœ„í•œ íƒ€ì„ìŠ¤íƒ¬í”„ ì¿¼ë¦¬ ì¶”ê°€
            const response = await fetch(GOOGLE_SCRIPT_URL + '?t=' + Date.now()); 
            const data = await response.json(); 
            
            if (!data || data.length === 0) { container.innerHTML = '<div class="empty-msg">ë©”ì‹œì§€ ì—†ìŒ</div>'; return; }
            
            container.innerHTML = '';
            // ì—­ìˆœ ì •ë ¬ (ìµœì‹ ìˆœ)
            // [FIXED] 'ëª¨ë‘ì—ê²Œ(ALL)' ë³´ë‚¸ ë©”ì‹œì§€ë§Œ ì „ì²´ ëª©ë¡ì— ë…¸ì¶œ
            const publicOnly = data.filter(row => row[1] === 'ALL');
            const sortedData = [...publicOnly].reverse();

            sortedData.forEach(row => {
                const card = createPostItElement(row);
                container.appendChild(card);
                
                // ì•„ë°”íƒ€ ê·¸ë¦¬ê¸°
                let style = { hair: 0, shirt: 0, acc: 0 };
                try { style = JSON.parse(row[3]); } catch(e) {}
                const canvas = card.querySelector('.mini-avatar-canvas');
                drawMiniAvatar(canvas, style);
            });
        } catch (error) { container.innerHTML = '<div class="empty-msg">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨!</div>'; }
    }

    // [NEW] í¬ìŠ¤íŠ¸ì‡ ìš”ì†Œ ìƒì„± í—¬í¼ í•¨ìˆ˜
    function createPostItElement(row) {
        const dateRaw = new Date(row[0]); 
        const dateStr = (dateRaw.getMonth()+1) + '/' + dateRaw.getDate() + ' ' + dateRaw.getHours() + ':' + String(dateRaw.getMinutes()).padStart(2,'0');
        
        let text = row[2] || "";
        let styleJson = row[3];
        let style = { hair: 0, shirt: 0, acc: 0 };
        if (styleJson) { try { style = JSON.parse(styleJson); } catch(e) {} }

        // ë°°ê²½ìƒ‰ ê²°ì • (ì˜· ìƒ‰ê¹”ì˜ ì—°í•œ ë²„ì „)
        let bgColor = CUSTOM_SHIRT_LIGHT_COLORS[style.shirt] || '#f8fafc';
        
        const card = document.createElement('div');
        card.className = 'post-it-card';
        card.style.backgroundColor = bgColor;
        
        let senderNameDisplay = row[1] === 'ALL' ? 'To. ëª¨ë‘' : `To. ${row[1]}`;

        card.innerHTML = `
            <div class="post-it-header">
                <div class="sender-info">
                    <canvas class="mini-avatar-canvas" width="30" height="30"></canvas>
                    <span class="sender-name">${senderNameDisplay}</span>
                </div>
                <span class="post-date">${dateStr}</span>
            </div>
            <div class="post-body">${text}</div>
        `;
        return card;
    }

    // [NEW] ë¯¸ë‹ˆ ì•„ë°”íƒ€ ê·¸ë¦¬ê¸° í•¨ìˆ˜
    function drawMiniAvatar(canvas, style) {
        const ctx = canvas.getContext('2d');
        const w = canvas.width;
        const h = canvas.height;
        
        ctx.clearRect(0,0,w,h);
        
        // ë°°ê²½
        ctx.fillStyle = '#fce4d4'; // ì–¼êµ´ìƒ‰
        ctx.beginPath(); ctx.arc(w/2, h/2 + 2, w/2 - 4, 0, Math.PI*2); ctx.fill();

        // í—¤ì–´
        ctx.fillStyle = '#4a3b2a';
        ctx.save(); ctx.translate(w/2, h/2 + 2); ctx.scale(0.8, 0.8);
        
        const hr = style.hair;
        if (hr === 0) { 
            ctx.fillRect(-7, -12, 14, 4); 
            ctx.beginPath(); ctx.moveTo(-7, -10); ctx.lineTo(7, -10); ctx.quadraticCurveTo(8, -10, 8, -6); ctx.lineTo(-8, -6); ctx.quadraticCurveTo(-8, -10, -7, -10); ctx.fill();
        } else if (hr === 1) { 
            ctx.beginPath(); ctx.arc(0, -11, 8, Math.PI, 0); ctx.fill();
            ctx.beginPath(); ctx.arc(-6, -9, 4, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(6, -9, 4, 0, Math.PI*2); ctx.fill();
        } else if (hr === 2) { 
            ctx.fillRect(-7, -12, 14, 4); ctx.beginPath(); ctx.arc(0, -14, 3.5, 0, Math.PI*2); ctx.fill();
        } else { 
            ctx.fillRect(-8, -12, 16, 6); ctx.fillRect(-9, -8, 4, 12); ctx.fillRect(5, -8, 4, 12); 
        }
        
        // ì¥ì‹
        const ac = style.acc;
        if (ac === 1) { // ë£¨ëŒí”„
            ctx.strokeStyle = '#8B4513'; ctx.lineWidth = 2; 
            ctx.beginPath(); ctx.moveTo(-3, -11); ctx.lineTo(-8, -18); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(3, -11); ctx.lineTo(8, -18); ctx.stroke();
            ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(0, -4, 1.5, 0, Math.PI*2); ctx.fill();
        } else if (ac === 2) { // ê½ƒ
            ctx.fillStyle = '#ff69b4'; ctx.beginPath(); ctx.arc(6, -14, 3, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = '#fff'; ctx.beginPath(); ctx.arc(6, -14, 1, 0, Math.PI*2); ctx.fill();
        }
        
        ctx.restore();
    }

    async function checkMyMessages() {
        const myName = myNameInput.value.trim();
        if (!myName) return alert("ë³¸ì¸ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        
        mbPlaceholder.style.display = 'block'; mbPlaceholder.innerHTML = 'âœ¨ ìš°í¸í•¨ íŒŒí‹°ì¥ ì…ì¥ ì¤‘... âœ¨';
        mbGrid.style.display = 'none';
        mbGrid.innerHTML = '';

        try {
            const response = await fetch(GOOGLE_SCRIPT_URL); const data = await response.json(); 
            if (!data || data.length === 0) { 
                const emptyText = 'ì•„ì§ ë„ì°©í•œ í¸ì§€ê°€ ì—†ì–´ìš” ğŸ˜¢';
                mbPlaceholder.innerHTML = emptyText; return; 
            }

            // [FIXED] 'ëª¨ë‘'ì—ê²Œ(ALL) ë³´ë‚¸ ë©”ì‹œì§€ ì œì™¸, ì˜¤ì§ ë‚´ ì´ë¦„ ì¼ì¹˜ë§Œ
            const myMessages = data.filter(row => row[1].replace(/\s/g, '') === myName.replace(/\s/g, ''));
            // ìµœì‹ ìˆœ ì •ë ¬ (ì—­ìˆœ)
            myMessages.reverse();

            if (myMessages.length === 0) {
                const emptyText = `'${myName}'ë‹˜ì—ê²Œ ë„ì°©í•œ<br>ë©”ì‹œì§€ê°€ ì•„ì§ ì—†ë„¤ìš”. í……~`;
                mbPlaceholder.innerHTML = emptyText; return;
            }

            mbPlaceholder.style.display = 'none';
            mbGrid.style.display = 'grid';
            
            myMessages.forEach(row => {
                const card = createPostItElement(row);
                mbGrid.appendChild(card);
                
                // ì•„ë°”íƒ€ ê·¸ë¦¬ê¸°
                let style = { hair: 0, shirt: 0, acc: 0 };
                try { style = JSON.parse(row[3]); } catch(e) {}
                const canvas = card.querySelector('.mini-avatar-canvas');
                drawMiniAvatar(canvas, style);
            });

        } catch (error) { 
            console.error(error);
            mbPlaceholder.innerHTML = 'ì…ì¥ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'; 
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
    closeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetId = btn.getAttribute('data-target');
            document.getElementById(targetId).style.display = 'none'; overlay.style.display = 'none';
        });
    });
    function hideAllModals() {
        myMsgModal.style.display = 'none'; overlay.style.display = 'none';
    }
    overlay.addEventListener('click', hideAllModals);
    
    // ëª¨ë‹¬ ì—´ê¸° (ê¸°ë³¸ê°’: ë‚´ ìš°í¸í•¨)
    window.openMyMsgModal = () => {
        myMsgModal.style.display = 'flex'; 
        overlay.style.display = 'block'; 
        
        // íƒ­ ì´ˆê¸°í™” (ë‚´ ìš°í¸í•¨)
        setMailboxTab('MY');
        
        // ë‚´ ìš°í¸í•¨ ì´ˆê¸°í™”
        myNameInput.focus();
        mbPlaceholder.style.display = 'block'; mbPlaceholder.innerHTML = 'ì´ë¦„ì„ ì…ë ¥í•˜ê³  í™•ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
        mbGrid.style.display = 'none';
        mbGrid.innerHTML = '';
    };

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    
    // Config
    const CONFIG = { 
        text: 'dotmill', font: '900 120px "Pretendard", Arial', pixelSize: 5, 
        builderCount: 19, 
        engineerCount: 3, officeCount: 50, 
        colors: ['#0ea5e9', '#334155', '#475569', '#1e293b'], 
        dropInterval: 180, // [MODIFIED] 60 -> 180 (ì†ë„ ì¡°ì ˆ)
        beltSpeed: 2 
    };

    let particles=[], fairies=[], beltOffset=0, lastDropTime=0, mouseX=0, mouseY=0, hoveredFairy=null;
    let monitorHueOffset = 0, isLogoComplete = false;
    let zones={ hopper:{x:0,y:0}, beltStart:{x:0,y:0}, beltEnd:{x:0,y:0}, storage:{x:0,y:0}, office:{x:0,y:0,w:0,h:0} };

    let vacationCounter = 0;
    let isSantaMode = false;
    let santaTimer = null;

    // ì‹œë®¬ë ˆì´ì…˜ ì†ë„ ì œì–´ ë³€ìˆ˜
    let speedLevel = 1; // í™”ë©´ í‘œì‹œìš© (1x, 2x...)
    const BASE_SPEED_FACTOR = 0.7; // ê¸°ë³¸ ì†ë„ë¥¼ ê¸°ì¡´ì˜ 70%ë¡œ ì„¤ì •
    let GAME_SPEED = speedLevel * BASE_SPEED_FACTOR; // ì‹¤ì œ ì—°ì‚°ìš© ì†ë„
    let isGamePaused = false;

    // ì´ìŠ¤í„° ì—ê·¸ ê´€ë ¨ ë³€ìˆ˜
    let clickCount = 0;
    let clickTimer = null;

    // [New Objects for Night Mode]
    let mainSnowflakes = [];
    let santaObj = { x: -200, y: 100, active: false };

    window.togglePause = () => {
        isGamePaused = !isGamePaused;
        const btn = document.getElementById('btn-pause');
        btn.innerText = isGamePaused ? 'â–¶' : 'â¸';
    };

    window.toggleSpeed = () => {
        if (speedLevel === 1) speedLevel = 2;
        else if (speedLevel === 2) speedLevel = 4;
        else if (speedLevel === 4) speedLevel = 8;
        else speedLevel = 1;
        GAME_SPEED = speedLevel * BASE_SPEED_FACTOR;
        document.getElementById('btn-speed').innerText = speedLevel + 'x';
    };

    let isHelpOpen = false;
    window.toggleHelp = () => {
        isHelpOpen = !isHelpOpen;
        const btn = document.getElementById('btn-help');
        const popup = document.getElementById('help-popup');
        if (isHelpOpen) {
            btn.classList.add('active');
            popup.style.display = 'block';
        } else {
            btn.classList.remove('active');
            popup.style.display = 'none';
        }
    };

    window.handleGuideClick = () => {
        const guideText = document.getElementById('guide-text');
        
        // ì‰ì´í¬ ì• ë‹ˆë©”ì´ì…˜ ì ìš©
        guideText.classList.remove('shake');
        void guideText.offsetWidth; // ë¦¬í”Œë¡œìš° ê°•ì œ (ì• ë‹ˆë©”ì´ì…˜ ì¬ì‹œì‘ìš©)
        guideText.classList.add('shake');
        
        // í´ë¦­ ì¹´ìš´íŠ¸ ì¦ê°€
        clickCount++;
        
        // íƒ€ì´ë¨¸ ë¦¬ì…‹ (1ì´ˆ ì•ˆì— ì—°ì† í´ë¦­í•´ì•¼ í•¨)
        if (clickTimer) clearTimeout(clickTimer);
        clickTimer = setTimeout(() => {
            clickCount = 0;
        }, 1000);
        
        // 10íšŒ ë„ë‹¬ ì‹œ
        if (clickCount >= 10) {
            clickCount = 0; // ë¦¬ì…‹
            triggerDotPour();
        }
    };

    function triggerDotPour() {
        const guideText = document.getElementById('guide-text');
        const rect = guideText.getBoundingClientRect();
        // Adjust for canvas scale if needed, but assuming full screen canvas matches client coords
        const startX = rect.left + rect.width / 2;
        const startY = rect.bottom; 
        
        for(let i=0; i<10; i++) {
             // ê¸°ì¡´ particles ë°°ì—´ì—ì„œ ëœë¤í•œ íƒ€ê²Ÿ ì¢Œí‘œë¥¼ ê°€ì ¸ì˜´ (ë¡œê³ ë¥¼ êµ¬ì„±í•˜ëŠ” í”½ì…€ ì¤‘ í•˜ë‚˜)
            let targetP = null;
            if (particles.length > 0) {
                 targetP = particles[Math.floor(Math.random() * particles.length)];
            }
            
            // ìƒˆ íŒŒí‹°í´ ìƒì„±
            const p = new Particle(0, 0, CONFIG.colors[Math.floor(Math.random() * CONFIG.colors.length)]);
            
            // ì´ˆê¸° ìœ„ì¹˜ ì„¤ì • (ë°•ìŠ¤ ë°‘)
            p.x = startX + (Math.random() - 0.5) * 50;
            p.y = startY;
            
            // ìƒíƒœ ì„¤ì •: 'FALLING_FROM_TEXT'
            p.state = 'FALLING_FROM_TEXT';
            
            // ëª©í‘œ ì§€ì  ì„¤ì • (ë¡œê³ ì˜ í”½ì…€ ìœ„ì¹˜)
            if (targetP) {
                p.targetX = targetP.targetX;
                p.targetY = targetP.targetY;
            } else {
                p.targetX = canvas.width/2 + (Math.random()-0.5)*100;
                p.targetY = canvas.height/2 + (Math.random()-0.5)*50;
            }
            
            particles.push(p);
        }
    }
    
    // ë¦¬ì…‹ í•¨ìˆ˜ ì¶”ê°€
    window.resetSimulation = () => {
        particles.forEach(p => { 
            if (p.state === 'PLACED' || p.state === 'ON_BELT' || p.state === 'IN_STORAGE' || p.state === 'CARRIED' || p.state === 'DELIVERING' || p.state === 'FALLING' || p.state === 'FALLING_FROM_TEXT') {
                p.reset(); 
            }
        });
        fairies.forEach(f => { 
            if(!f.isPaused) { 
                if(f.targetItem) { 
                    f.targetItem.reset(); 
                    f.targetItem = null; 
                } 
                // [NEW] ë§Œì•½ ëˆˆ ì¹˜ìš°ê¸° ëª¨ë“œì˜€ë‹¤ë©´ IDLEë¡œ ë³µê·€
                if (f.busyState === 'SWEEPING' || f.busyState === 'MOVING_TO_SWEEP') {
                    f.busyState = 'NONE'; 
                }
                f.state = 'IDLE'; 
            } 
        });
        isLogoComplete = false;
        mainSnowflakes = [];
        santaObj.active = false;
        starlightCache = null; // Reset cache
        
        // [NEW] ìŒì•… ë¦¬ì…‹
        if (fadeOutInterval) clearInterval(fadeOutInterval);
        
        audioFiles['carol'].pause();
        audioFiles['carol'].currentTime = 0;
        
        // Correct ì‚¬ìš´ë“œë„ ì •ì§€
        if(audioFiles['correct']) {
            audioFiles['correct'].pause();
            audioFiles['correct'].currentTime = 0;
        }
        
        const bgm = audioFiles['bgm'];
        bgm.volume = 0.4; 
        
        if (isBgmOn) {
            if (bgm.paused) bgm.play().catch(e => console.log(e));
        } else {
            bgm.pause();
        }

        playSound('reset');
    };

    function triggerSantaMode() {
        isSantaMode = true;
        if(santaTimer) clearTimeout(santaTimer);
        santaTimer = setTimeout(() => {
            isSantaMode = false;
        }, 7000); 
    }

    class MainSnowflake {
        constructor(w, h) {
            this.x = Math.random() * w;
            this.y = Math.random() * h;
            this.size = Math.random() * 3 + 1;
            this.speed = Math.random() * 2 + 1;
            this.opacity = Math.random() * 0.7 + 0.3;
        }
        update(w, h, speed) {
            this.y += this.speed * speed;
            this.x += Math.sin(this.y * 0.02) * 0.5 * speed;
            if (this.y > h) {
                this.y = -10;
                this.x = Math.random() * w;
            }
        }
        draw(ctx) {
            ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
            ctx.fillRect(this.x, this.y, this.size, this.size); // Pixel style
        }
    }

    function drawPixelSanta(ctx, x, y) {
        ctx.save();
        ctx.translate(x, y);
        const scale = 3;
        ctx.scale(scale, scale);

        // Reindeer
        ctx.fillStyle = '#8B4513'; // Body
        ctx.fillRect(0, 5, 8, 5); 
        ctx.fillRect(0, 10, 2, 4); // Legs
        ctx.fillRect(6, 10, 2, 4);
        ctx.fillRect(6, 3, 3, 3); // Head
        ctx.fillStyle = '#D2691E'; // Antlers
        ctx.fillRect(7, 1, 1, 2);
        ctx.fillStyle = 'red'; // Nose
        ctx.fillRect(9, 4, 1, 1);

        // Sleigh connection
        ctx.strokeStyle = '#555';
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(0, 7); ctx.lineTo(-5, 7); ctx.stroke();

        // Sleigh
        ctx.fillStyle = '#A52A2A';
        ctx.fillRect(-15, 8, 12, 4);
        ctx.fillRect(-15, 6, 2, 2);
        ctx.fillStyle = '#FFD700'; // Runner
        ctx.fillRect(-16, 12, 14, 1);
        
        // Santa
        ctx.fillStyle = 'red'; // Suit
        ctx.fillRect(-12, 4, 6, 6);
        ctx.fillStyle = '#fce4d4'; // Face
        ctx.fillRect(-11, 2, 4, 3);
        ctx.fillStyle = 'white'; // Beard
        ctx.fillRect(-11, 4, 4, 2);
        ctx.fillStyle = 'red'; // Hat
        ctx.fillRect(-11, 0, 4, 2);

        ctx.restore();
    }
    
    // [OPTIMIZED] Starlight Text with Caching
    let starlightCache = null;

    function drawStarlightText(ctx, text, x, y) {
        // 1. Generate Cache if not exists or if text/position significantly changed (logic simplified to single use case here)
        if (!starlightCache) {
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = 600; 
            tempCanvas.height = 100;
            
            tempCtx.font = '900 50px "Pretendard", sans-serif';
            tempCtx.fillStyle = '#fff';
            tempCtx.textAlign = 'center';
            tempCtx.textBaseline = 'middle';
            tempCtx.fillText(text, tempCanvas.width / 2, tempCanvas.height / 2);
            
            const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
            const data = imageData.data;
            const points = [];
            
            const step = 4; // Skip pixels for performance
            
            for (let py = 0; py < tempCanvas.height; py += step) {
                for (let px = 0; px < tempCanvas.width; px += step) {
                    const index = (py * tempCanvas.width + px) * 4;
                    if (data[index + 3] > 128) {
                        points.push({
                            x: px - tempCanvas.width / 2,
                            y: py - tempCanvas.height / 2
                        });
                    }
                }
            }
            starlightCache = points;
        }

        // 2. Draw from Cache
        ctx.save();
        ctx.translate(x, y);
        
        const colors = ['#ffffff', '#fffacd', '#ffd700', '#c0c0c0'];
        
        starlightCache.forEach(pt => {
             // ë°˜ì§ì´ëŠ” íš¨ê³¼ (Math.random() calls are still needed per frame but much cheaper than getImageData)
            if (Math.random() > 0.9) {
                 const twinkle = Math.random() > 0.8 ? 1.5 : 1;
                 const size = Math.random() * 2 * twinkle;
                 ctx.fillStyle = colors[Math.floor(Math.random() * colors.length)];
                 ctx.beginPath();
                 ctx.arc(pt.x, pt.y, size, 0, Math.PI * 2);
                 ctx.fill();
            } else if (Math.random() > 0.5) {
                // Static dim stars to keep shape visible
                 ctx.fillStyle = 'rgba(255,255,255,0.3)';
                 ctx.beginPath();
                 ctx.arc(pt.x, pt.y, 1, 0, Math.PI * 2);
                 ctx.fill();
            }
        });

        ctx.restore();
    }

    class Particle {
        constructor(tx,ty,c){
            this.targetX=tx;
            this.targetY=ty;
            this.baseColor=c;
            
            // [FIXED] Use logical width/height instead of canvas.width/height (physical)
            const w = window.innerWidth;
            const h = window.innerHeight;
            
            this.x=zones.hopper.x+(Math.random()-0.5)*40;
            this.y=zones.hopper.y-20;
            this.state='WAITING';
            this.carrier=null;

            // [NEW] íŠ¸ë¦¬ íŒ¨í„´ ìƒ‰ìƒ ë¯¸ë¦¬ ì§€ì •
            const rand = Math.random();
            if (rand < 0.85) {
                this.treeColor = '#22c55e'; // Green (Tree)
            } else if (rand < 0.90) {
                this.treeColor = '#eab308'; // Yellow (Ornament)
            } else if (rand < 0.95) {
                this.treeColor = '#ef4444'; // Red (Ornament)
            } else {
                this.treeColor = '#854d0e'; // Brown (Branch/Ornament)
            }
        }
        update(){
            // ì¼ì‹œì •ì§€ ì‹œ ì—…ë°ì´íŠ¸ ê±´ë„ˆëœ€
            if (isGamePaused) return;
            
            if (this.state === 'FALLING_FROM_TEXT') {
                this.y += 5 * GAME_SPEED; // ë¹¨ë¦¬ ë–¨ì–´ì§
                // ë°”ë‹¥(storage y ìœ„ì¹˜ ì •ë„)ì— ë‹¿ìœ¼ë©´ IN_STORAGEë¡œ ë³€ê²½
                if (this.y >= zones.storage.y) {
                    this.state = 'IN_STORAGE';
                    // x ìœ„ì¹˜ë¥¼ ì•½ê°„ ëœë¤í•˜ê²Œ í¼íŠ¸ë¦¼ (ë°”ë‹¥ì— ìŒ“ì¸ ëŠë‚Œ)
                    this.y = zones.storage.y + (Math.random()-0.5)*20;
                }
                return;
            }

            if(this.state==='WAITING')return;
            if(this.state==='FALLING'){
                this.y+=4 * GAME_SPEED; // ì†ë„ ì ìš©
                if(this.y>=zones.beltStart.y-10){this.y=zones.beltStart.y-10+Math.random()*5;this.state='ON_BELT';}
            } else if(this.state==='ON_BELT'){
                const dx=zones.beltEnd.x-zones.beltStart.x,dy=zones.beltEnd.y-zones.beltStart.y,d=Math.sqrt(dx*dx+dy*dy);
                this.x+=(dx/d)*CONFIG.beltSpeed * GAME_SPEED; // ì†ë„ ì ìš©
                this.y+=(dy/d)*CONFIG.beltSpeed * GAME_SPEED; // ì†ë„ ì ìš©
                if(this.x>=zones.beltEnd.x){this.state='IN_STORAGE';this.x=zones.storage.x+(Math.random()-0.5)*30;this.y=zones.storage.y+(Math.random()-0.5)*20;}
            } else if(this.state==='RETURNING'){
                const dx=zones.hopper.x-this.x,dy=zones.hopper.y-this.y;
                this.x+=dx*0.1 * GAME_SPEED; // ì†ë„ ì ìš©
                this.y+=dy*0.1 * GAME_SPEED; // ì†ë„ ì ìš©
                if(Math.abs(dy)<5)this.state='WAITING';
            }
        }
        // [MODIFIED] Draw function to handle glowing particles when logo is complete
        draw(){
            if(this.state==='WAITING') return;

            // [CHANGED] ë¡œê³  ì™„ì„± ì‹œ íŠ¸ë¦¬ íŒ¨í„´ ìƒ‰ìƒ ì‚¬ìš©
            if (typeof isLogoComplete !== 'undefined' && isLogoComplete && this.state === 'PLACED') {
                 ctx.fillStyle = this.treeColor;
            } else {
                 ctx.fillStyle = this.baseColor;
            }

            if(this.state==='PLACED') {
                ctx.fillRect(this.x,this.y,CONFIG.pixelSize,CONFIG.pixelSize);
            } else {
                ctx.beginPath();
                ctx.arc(this.x,this.y,CONFIG.pixelSize/2+1,0,Math.PI*2);
                ctx.fill();
            }
        }
        reset(){this.state='RETURNING';this.carrier=null;}
    }

    class Fairy {
        constructor(role, idx) {
            this.role = role; this.x = window.innerWidth/2; this.y = window.innerHeight/2; this.targetItem = null; this.state = 'IDLE';
            this.colorShirt = ['#a3d2ca', '#ffc3a0', '#fff'][Math.floor(Math.random()*3)]; this.animFrame = Math.random()*100;
            this.isPaused=false; this.pauseTimer=null; this.busyState='NONE'; this.busyTimer=Math.random()*500;
            this.busyTargetX=0; this.busyTargetY=0; this.seatX=0; this.seatY=0;
            this.assignedMessage = null; this.assignmentTime = 0; 
            this.customStyle = null; 

            // Caching for text bubble
            this._cachedLines = null;

            if(role==='ENGINEER'){this.x=zones.beltStart.x+(zones.beltEnd.x-zones.beltStart.x)*0.5;this.y=zones.beltStart.y+30;}
            else if(role==='OFFICE'){ 
                // [FIXED] 2ì¤„ ê³ ì • ì¤‘ì•™ ì •ë ¬ (ìë™ ì¤„ë°”ê¿ˆ ì œê±°)
                const totalCount = CONFIG.officeCount; // 50
                const cols = Math.ceil(totalCount / 2); // 25ì—´ ê³ ì •
                const colWidth = 60;
                const rowHeight = 60;
                
                // ì „ì²´ ê·¸ë¦¬ë“œ ë„ˆë¹„ ê³„ì‚°
                const gridWidth = cols * colWidth;
                
                // í™”ë©´ ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•œ ì‹œì‘ì  ê³„ì‚° (í™”ë©´ë³´ë‹¤ ë„“ì–´ë„ ì¤‘ì•™ ê¸°ì¤€)
                const startX = (window.innerWidth - gridWidth) / 2 + colWidth / 2;
                
                const r = Math.floor(idx / cols); // 0 ë˜ëŠ” 1 (2ì¤„)
                const c = idx % cols;
                
                this.seatX = startX + c * colWidth;
                this.seatY = zones.office.y + 50 + r * rowHeight;
                
                this.x = this.seatX;
                this.y = this.seatY;
                this.busyState='TYPING';
            } 
            else if(role==='FOREMAN'){ 
                // [FIXED] Foreman Position Adjustment
                this.x = window.innerWidth/2 - 250; 
                this.y = window.innerHeight/2 - 70; // Stand on top of scaffold (scaffold top is roughly center - 60)
            }
        }
        giveVacation() { 
            this.isPaused=true; playSound('rest'); 
            if(this.pauseTimer)clearTimeout(this.pauseTimer); 
            this.pauseTimer=setTimeout(()=>{this.isPaused=false;},5000); 
            
            vacationCounter++;
            if(vacationCounter >= 5) {
                triggerSantaMode();
                vacationCounter = 0;
            }
        }
        
        update() { 
            if(this.isPaused) return; 
            
            // ì¼ì‹œì •ì§€ ì‹œ ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„ ì—…ë°ì´íŠ¸ ì¤‘ë‹¨
            if (!isGamePaused) {
                this.animFrame += 0.1 * GAME_SPEED; // ì• ë‹ˆë©”ì´ì…˜ ì†ë„ë„ ë°˜ì˜
                
                // ë¡œê³  ì™„ì„± ì‹œ ì²­ì†Œ ëª¨ë“œ (BUILDERë§Œ)
                if (isLogoComplete && this.role === 'BUILDER') {
                    this.updateSweeper();
                } else {
                    if(this.role==='BUILDER') this.updateBuilder(); 
                    else if(this.role==='OFFICE') this.updateOffice(); 
                }
            }
        }
        
        updateSweeper() {
             // ë¹—ìë£¨ì§ˆ ë¡œì§: ëœë¤í•˜ê²Œ ëŒì•„ë‹¤ë‹ˆë©° ì²­ì†Œ
             if (this.busyState !== 'SWEEPING' && this.busyState !== 'MOVING_TO_SWEEP') {
                 this.busyState = 'MOVING_TO_SWEEP';
                 // Use logical width
                 this.busyTargetX = window.innerWidth * 0.1 + Math.random() * window.innerWidth * 0.8;
                 this.busyTargetY = window.innerHeight * 0.5 + Math.random() * window.innerHeight * 0.4;
             }
             
             if (this.busyState === 'MOVING_TO_SWEEP') {
                 if(this.moveTo(this.busyTargetX, this.busyTargetY)) {
                     this.busyState = 'SWEEPING';
                     this.busyTimer = 100 + Math.random() * 100;
                 }
             } else if (this.busyState === 'SWEEPING') {
                 this.busyTimer -= 1 * GAME_SPEED;
                 if (this.busyTimer <= 0) {
                     this.busyState = 'MOVING_TO_SWEEP';
                     this.busyTargetX = window.innerWidth * 0.1 + Math.random() * window.innerWidth * 0.8;
                     this.busyTargetY = window.innerHeight * 0.5 + Math.random() * window.innerHeight * 0.4;
                 }
             }
        }

        updateOffice(){
            if(this.busyState==='TYPING'){
                this.busyTimer -= 1 * GAME_SPEED; // íƒ€ì´ë¨¸ ê°ì†Œ ì†ë„ ì ìš©
                if(this.busyTimer<=0){
                    if(Math.random()<0.05){this.busyState='PATROL';this.busyTargetX=zones.office.x+Math.random()*zones.office.w;this.busyTargetY=zones.office.y+Math.random()*zones.office.h;}
                    else{this.busyTimer=200+Math.random()*400;}
                }
            } else if(this.busyState==='PATROL'){
                if(this.moveTo(this.busyTargetX,this.busyTargetY)){
                    this.busyState='WAITING_TO_RETURN';this.busyTimer=50+Math.random()*100;
                }
            } else if(this.busyState==='WAITING_TO_RETURN'){
                this.busyTimer -= 1 * GAME_SPEED;
                if(this.busyTimer<=0)this.busyState='RETURN';
            } else if(this.busyState==='RETURN'){
                if(this.moveTo(this.seatX,this.seatY)){
                    this.busyState='TYPING';this.busyTimer=300+Math.random()*500;
                }
            }
        }

        updateBuilder(){
            if(!this.targetItem){
                const job=particles.find(p=>p.state==='IN_STORAGE'&&!p.carrier);
                if(job){ this.busyState='NONE';this.targetItem=job;job.carrier=this;this.state='MOVING_TO_STORAGE'; } else { this.performBusyAction(); }
            } else {
                if(this.targetItem.state==='RETURNING'){this.targetItem=null;this.state='IDLE';return;}
                if(this.state==='MOVING_TO_STORAGE'){if(this.moveTo(this.targetItem.x,this.targetItem.y)){this.targetItem.state='CARRIED';this.state='DELIVERING';}}
                else if(this.state==='DELIVERING'){this.targetItem.x=this.x;this.targetItem.y=this.y-12;if(this.moveTo(this.targetItem.targetX,this.targetItem.targetY)){this.targetItem.state='PLACED';this.targetItem.x=this.targetItem.targetX;this.targetItem.y=this.targetItem.targetY;this.targetItem.carrier=null;this.targetItem=null;this.state='IDLE';}}
            }
        }

        performBusyAction(){
            if(this.busyTimer<=0){
                const r=Math.random();
                if(r<0.5){this.busyState='PATROL';this.busyTargetX=window.innerWidth/2+(Math.random()-0.5)*400;this.busyTargetY=window.innerHeight/2+(Math.random()-0.5)*150;}
                else if(r<0.8)this.busyState='CLEAN'; else this.busyState='HAMMER';
                this.busyTimer=60+Math.random()*120;
            }
            this.busyTimer -= 1 * GAME_SPEED; // íƒ€ì´ë¨¸ ê°ì†Œ ì†ë„ ì ìš©
            
            if(this.busyState==='PATROL')this.moveTo(this.busyTargetX,this.busyTargetY);
            else if(this.busyState==='CLEAN')this.x+=Math.sin(Date.now()*0.02 * GAME_SPEED)*0.5 * GAME_SPEED;
            else if(this.busyState==='HAMMER'){if(Math.abs(this.x-window.innerWidth/2)>300)this.moveTo(window.innerWidth/2,window.innerHeight/2);}
        }

        moveTo(tx,ty){
            const dx=tx-this.x,dy=ty-this.y,d=Math.sqrt(dx*dx+dy*dy);
            const baseSpeed = this.role==='OFFICE'?1.5:4;
            const moveStep = baseSpeed * GAME_SPEED; // ì†ë„ ì ìš©

            if(d < moveStep || d < 4){this.x=tx;this.y=ty;return true;}
            
            this.x+=(dx/d)*moveStep;
            this.y+=(dy/d)*moveStep;
            return false;
        }
        
        drawBroom(ctx) {
            ctx.save();
            const angle = Math.sin(Date.now() * 0.01 * GAME_SPEED) * 0.5;
            ctx.rotate(angle);
            ctx.fillStyle = '#8d6e63'; // Handle
            ctx.fillRect(4, -5, 2, 20);
            ctx.fillStyle = '#fbc02d'; // Bristles
            ctx.beginPath();
            ctx.moveTo(3, 15);
            ctx.lineTo(7, 15);
            ctx.lineTo(9, 22);
            ctx.lineTo(1, 22);
            ctx.fill();
            ctx.restore();
        }

        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            
            let shirtColor = this.colorShirt;
            if (this.customStyle) {
                shirtColor = CUSTOM_SHIRT_COLORS[this.customStyle.shirt] || CUSTOM_SHIRT_COLORS[0];
            }

            let indicatorColor = null;
            if (this.isPaused) { ctx.shadowColor = '#ffd700'; ctx.shadowBlur = 20; } 
            else if (this.assignedMessage) {
                const timeDiff = Date.now() - this.assignmentTime;
                if (timeDiff < 2000) { ctx.shadowColor = '#00e676'; ctx.shadowBlur = 25; indicatorColor = '#00e676'; } 
                else { indicatorColor = '#2979ff'; ctx.shadowBlur = 0; }
            } else { ctx.shadowBlur = 0; }
            
            // ì¼ì‹œì •ì§€ ì•„ë‹ ë•Œë§Œ ì›€ì§ì„ íš¨ê³¼ ì ìš©
            const sway = isGamePaused ? 0 : Math.sin(Date.now()*0.05 * GAME_SPEED);
            if(!this.isPaused && (this.busyState==='HAMMER'||(this.role==='OFFICE'&&this.busyState==='TYPING') || this.busyState==='SWEEPING')) ctx.translate(0, sway);
            
            if (indicatorColor) { ctx.fillStyle = indicatorColor; ctx.beginPath(); ctx.arc(0, -18, 3.5, 0, Math.PI*2); ctx.fill(); }
            
            const w=12,h=20; 
            ctx.fillStyle='#333';ctx.fillRect(-w/2,0,w,h/2); // Pants
            ctx.fillStyle=shirtColor;ctx.fillRect(-w/2,-h/2,w,h/2); // Shirt
            ctx.fillStyle='#fce4d4';ctx.fillRect(-w/2+2,-h/2-6,8,8); // Face

            if (this.customStyle) {
                ctx.save();
                ctx.translate(0, 8); 

                ctx.fillStyle = '#4a3b2a';
                const hr = this.customStyle.hair;
                if (hr === 0) { // ê¸°ë³¸
                    ctx.fillRect(-7, -26, 14, 4); 
                    ctx.beginPath(); ctx.moveTo(-7, -24); ctx.lineTo(7, -24); ctx.quadraticCurveTo(8, -24, 8, -20); ctx.lineTo(-8, -20); ctx.quadraticCurveTo(-8, -24, -7, -24); ctx.fill();
                } else if (hr === 1) { // ë”ë²…(íŒŒë§ˆ)
                    ctx.beginPath(); 
                    ctx.arc(0, -25, 8, Math.PI, 0); 
                    ctx.arc(-6, -23, 4, 0, Math.PI*2);
                    ctx.arc(6, -23, 4, 0, Math.PI*2);
                    ctx.arc(0, -28, 4, 0, Math.PI*2);
                    ctx.fill();
                } else if (hr === 2) { // ê½ì§€
                    ctx.fillRect(-7, -26, 14, 4); 
                    ctx.beginPath(); ctx.arc(0, -28, 3.5, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.moveTo(0, -28); ctx.quadraticCurveTo(5, -32, 6, -26); ctx.stroke();
                } else { // ê¸´ë¨¸ë¦¬
                    ctx.fillRect(-8, -26, 16, 6); 
                    ctx.fillRect(-9, -22, 4, 12); ctx.fillRect(5, -22, 4, 12); 
                }

                const ac = this.customStyle.acc;
                if (ac === 1) { // ë£¨ëŒí”„
                    ctx.strokeStyle = '#8B4513'; ctx.lineWidth = 2; ctx.lineCap = 'round';
                    ctx.beginPath(); ctx.moveTo(-3, -25); ctx.lineTo(-8, -32); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(-6, -29); ctx.lineTo(-4, -33); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(3, -25); ctx.lineTo(8, -32); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(6, -29); ctx.lineTo(4, -33); ctx.stroke();
                    ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(0, -18, 1.5, 0, Math.PI*2); ctx.fill();
                } else if (ac === 2) { // í•œë³µ ë°°ì -> ê½ƒ
                    ctx.fillStyle = '#ff69b4'; // Pink petals
                    for(let i=0; i<5; i++) {
                        const angle = (i * 2 * Math.PI) / 5;
                        const r = 3;
                        ctx.beginPath();
                        ctx.arc(6 + Math.cos(angle)*r, -28 + Math.sin(angle)*r, 2, 0, Math.PI*2);
                        ctx.fill();
                    }
                    ctx.fillStyle = '#fff'; // Center
                    ctx.beginPath(); ctx.arc(6, -28, 2, 0, Math.PI*2); ctx.fill();
                }
                ctx.restore();
            }

            if (isSantaMode) {
                ctx.fillStyle = '#ef4444'; 
                ctx.beginPath(); ctx.moveTo(-6, -16); ctx.lineTo(0, -26); ctx.lineTo(6, -16); ctx.fill();
                ctx.fillStyle = '#fff'; 
                ctx.fillRect(-7, -16, 14, 3);
                ctx.beginPath(); ctx.arc(0, -26, 2, 0, Math.PI*2); ctx.fill();
            }

            if(this.role==='FOREMAN'){ctx.fillStyle='#ffcc00';ctx.fillRect(-w/2,-h/2-8,w,4);ctx.strokeStyle='red';ctx.beginPath();ctx.moveTo(w/2,-h/2);ctx.lineTo(w/2+10,-h/2-5);ctx.stroke();}
            else if(this.role==='ENGINEER'){ctx.save();ctx.translate(w/2,0);ctx.rotate(Math.sin(this.animFrame)*0.5);ctx.fillStyle='#888';ctx.fillRect(0,-2,10,4);ctx.restore();}
            else if(this.role==='OFFICE'){ctx.fillStyle='#333';ctx.fillRect(-w/2+3,-h/2-3,6,2);}
            else if(this.role==='BUILDER'&&this.state==='DELIVERING'){ctx.fillStyle='#fce4d4';ctx.fillRect(-w/2-2,-h/2,2,6);ctx.fillRect(w/2,-h/2,2,6);}
            
            // ë¹—ìë£¨ ê·¸ë¦¬ê¸° ì ìš©
            if (this.busyState === 'SWEEPING' || this.busyState === 'MOVING_TO_SWEEP') {
                this.drawBroom(ctx);
            } else if (this.role === 'BUILDER' && !this.isPaused) {
                if (this.busyState === 'CLEAN') {
                    ctx.save(); ctx.strokeStyle = '#8d6e63'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(4, 5); ctx.lineTo(4 + Math.sin(Date.now()*0.02 * GAME_SPEED)*8, 18); ctx.stroke();
                    ctx.fillStyle='#d7ccc8'; ctx.beginPath(); ctx.arc(4 + Math.sin(Date.now()*0.02 * GAME_SPEED)*8, 18, 3, 0, Math.PI); ctx.fill(); ctx.restore();
                } else if (this.busyState === 'HAMMER') {
                    ctx.save(); ctx.translate(6, 0); ctx.rotate(Math.sin(Date.now() * 0.2 * GAME_SPEED) * 0.8);
                    ctx.fillStyle = '#5d4037'; ctx.fillRect(0, -10, 2, 12); ctx.fillStyle = '#555'; ctx.fillRect(-3, -12, 8, 4); ctx.restore();
                }
            }
            ctx.restore();
        }
        drawBubble() {
            if (!this.assignedMessage) return;
            const msg = this.assignedMessage;
            
            // Use cached calculation if available and text matches
            if (!this._cachedLines || this._lastText !== msg.text) {
                 ctx.save();
                 // We need a dummy context measure here to populate cache
                 // Assuming standard font size for measurement
                 ctx.font = 'bold 14px "Pretendard", sans-serif'; 
                 const tm = ctx.measureText(msg.text);
                 const nm = ctx.measureText(msg.name);
                 
                 this._cachedWidth = Math.min(Math.max(tm.width, nm.width) + 24, 220);
                 
                 const words = msg.text.split('');
                 this._cachedLines = [];
                 let currentLine = words[0];
                 for (let i = 1; i < words.length; i++) {
                    const width = ctx.measureText(currentLine + words[i]).width;
                    if (width < 200) {
                        currentLine += words[i];
                    } else {
                        this._cachedLines.push(currentLine);
                        currentLine = words[i];
                    }
                 }
                 this._cachedLines.push(currentLine);
                 this._cachedHeight = this._cachedLines.length * 18 + 30;
                 this._lastText = msg.text;
                 ctx.restore();
            }

            const w = this._cachedWidth;
            const h = this._cachedHeight;

            ctx.save(); ctx.translate(this.x, this.y - 35);

            let bubbleX = 0;
            const canvasW = window.innerWidth;
            if (this.x - w/2 < 10) bubbleX = 10 - (this.x - w/2);
            if (this.x + w/2 > canvasW - 10) bubbleX = (canvasW - 10) - (this.x + w/2);
            
            ctx.translate(bubbleX, 0);

            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)'; ctx.shadowColor = 'rgba(0,0,0,0.2)'; ctx.shadowBlur = 10;
            ctx.beginPath(); ctx.roundRect(-w/2, -h, w, h, 12); ctx.fill();
            
            ctx.beginPath(); 
            ctx.moveTo(-bubbleX, 0); 
            ctx.lineTo(-bubbleX - 6, -6); 
            ctx.lineTo(-bubbleX + 6, -6); 
            ctx.fill();

            ctx.shadowBlur = 0; ctx.fillStyle = '#334155'; ctx.textAlign = 'center'; 
            
            ctx.font = 'bold 14px "Pretendard", sans-serif';
            this._cachedLines.forEach((line, i) => {
                ctx.fillText(line, 0, -h + 20 + (i * 18));
            });

            ctx.font = '500 12px "Pretendard"'; ctx.fillStyle = '#64748b'; 
            let displayName = msg.name;
            if (displayName === 'ALL') {
                ctx.fillStyle = '#00e676';
                displayName = 'ëª¨ë‘ì—ê²Œ';
            } else {
                ctx.fillStyle = '#ec4899';
            }
            ctx.fillText(`To. ${displayName}`, 0, -10);
            ctx.restore();
        }
    }

    function init() {
        // High DPI support
        const dpr = window.devicePixelRatio || 1;
        canvas.width = window.innerWidth * dpr;
        canvas.height = window.innerHeight * dpr;
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
        
        ctx.scale(dpr, dpr);
        
        // Use logical dimensions for game logic
        const width = window.innerWidth;
        const height = window.innerHeight;

        if (width === 0 || height === 0) return;
        
        // [FIXED] ì´ˆê¸° ë²„ì „ zones ì„¤ì • (ê³ ì • ë†’ì´)
        zones.hopper = { x: 100, y: 100 }; 
        zones.beltStart = { x: 100, y: 180 }; 
        zones.beltEnd = { x: width * 0.3, y: height * 0.6 }; 
        zones.storage = { x: width * 0.3 + 20, y: height * 0.6 + 20 }; 
        zones.office = { x: 0, y: height - 200, w: width, h: 200 };
        
        // Resize ì‹œ ìºì‹œ ë¦¬ì…‹
        starlightCache = null;

        particles=[]; fairies=[];
        
        // Analyze text pixels
        const tempCanvas = document.createElement('canvas');
        const tempCtx = tempCanvas.getContext('2d');
        tempCanvas.width = width;
        tempCanvas.height = height;
        
        tempCtx.font = CONFIG.font; 
        tempCtx.textAlign = 'center'; 
        tempCtx.textBaseline = 'middle'; 
        tempCtx.fillStyle = 'white'; 
        tempCtx.fillText(CONFIG.text, width / 2, height / 2);
        
        const data = tempCtx.getImageData(0, 0, width, height);
        
        for(let y=0; y<height; y+=CONFIG.pixelSize) {
            for(let x=0; x<width; x+=CONFIG.pixelSize) {
                if(data.data[(y * 4 * width) + (x * 4) + 3] > 128) {
                    particles.push(new Particle(x, y, CONFIG.colors[Math.floor(Math.random() * CONFIG.colors.length)]));
                }
            }
        }
        
        fairies.push(new Fairy('FOREMAN'));
        for(let i=0; i<CONFIG.builderCount; i++) fairies.push(new Fairy('BUILDER'));
        for(let i=0; i<CONFIG.engineerCount; i++) fairies.push(new Fairy('ENGINEER'));
        for(let i=0; i<CONFIG.officeCount; i++) fairies.push(new Fairy('OFFICE', i));
        
        // [NEW] íŠœí† ë¦¬ì–¼ ì‹¤í–‰ ì²´í¬
        setTimeout(runTutorial, 500); // 0.5ì´ˆ í›„ ì‹œì‘
    }

    function isVisible(f) { return f.x > 20 && f.x < canvas.width/(window.devicePixelRatio||1) - 20 && f.y > 0 && f.y < canvas.height/(window.devicePixelRatio||1); }

    window.distributeSingleMessage = (newMsg) => {
        let target = fairies.find(f => f.assignedMessage === null && isVisible(f));
        if (!target) {
            const visibleFairies = fairies.filter(f => isVisible(f));
            if (visibleFairies.length > 0) { target = visibleFairies[Math.floor(Math.random() * visibleFairies.length)]; } 
            else { target = fairies[Math.floor(Math.random() * fairies.length)]; }
        }
        if (target) { 
            target.assignedMessage = newMsg; 
            target.assignmentTime = Date.now();
            if(newMsg.style) target.customStyle = newMsg.style;
        }
    };

    function drawEnvironment() {
        const width = window.innerWidth;
        const height = window.innerHeight;
        // [NEW] ëª¨ë°”ì¼ ê°ì§€ (í™”ë©´ ë„ˆë¹„ 768px ì´í•˜)
        const isMobile = width <= 768;

        if (isLogoComplete) {
            // [NEW] Night Mode Background
            const grad = ctx.createLinearGradient(0, 0, 0, height);
            grad.addColorStop(0, '#0f172a'); 
            grad.addColorStop(1, '#1e1b4b');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, width, height);
        } else {
             ctx.clearRect(0, 0, width, height); 
        }

        // [NEW] ëª¨ë°”ì¼ì´ ì•„ë‹ ë•Œë§Œ ê¹”ë•Œê¸°(Hopper)ì™€ ë²¨íŠ¸ ê·¸ë¦¬ê¸°
        if (!isMobile) {
            ctx.fillStyle = '#999'; ctx.beginPath(); ctx.moveTo(zones.hopper.x - 30, zones.hopper.y - 50); ctx.lineTo(zones.hopper.x + 30, zones.hopper.y - 50); ctx.lineTo(zones.hopper.x + 10, zones.hopper.y); ctx.lineTo(zones.hopper.x - 10, zones.hopper.y); ctx.fill();
            ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 40; ctx.lineCap = 'round'; ctx.beginPath(); ctx.moveTo(zones.beltStart.x, zones.beltStart.y); ctx.lineTo(zones.beltEnd.x, zones.beltEnd.y); ctx.stroke();
            
            if (!isGamePaused) {
                beltOffset -= CONFIG.beltSpeed * GAME_SPEED;
            }
            
            ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 30; ctx.setLineDash([10, 20]); ctx.lineDashOffset = beltOffset; ctx.beginPath(); ctx.moveTo(zones.beltStart.x, zones.beltStart.y); ctx.lineTo(zones.beltEnd.x, zones.beltEnd.y); ctx.stroke(); ctx.setLineDash([]);
            ctx.lineWidth = 5; ctx.strokeStyle = '#64748b'; ctx.beginPath(); ctx.moveTo(zones.beltEnd.x, zones.beltEnd.y); ctx.lineTo(zones.beltEnd.x, height); ctx.moveTo(zones.beltStart.x, zones.beltStart.y); ctx.lineTo(zones.beltStart.x, height); ctx.stroke();
            
            // [FIXED] ê°ë…ê´€ ë¹„ê³„ ìœ„ì¹˜ (ì´ˆê¸° ê³ ì •ê°’) - ëª¨ë°”ì¼ ì•„ë‹ ë•Œë§Œ ê·¸ë¦¬ê¸°
            const lx = width/2 - 250; 
            const ly = height/2 + 60; 
            ctx.strokeStyle = '#8d6e63'; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(lx, ly); ctx.lineTo(lx, ly - 120); ctx.moveTo(lx + 30, ly); ctx.lineTo(lx + 30, ly - 120); for(let i=0; i<5; i++) { ctx.moveTo(lx, ly - 20 - (i*20)); ctx.lineTo(lx+30, ly - 20 - (i*20)); } ctx.stroke();
        }
        
        // [FIXED] ì‚¬ë¬´ì‹¤ ë°”ë‹¥ ì˜ì—­ ê·¸ë¦¬ê¸° (ì´ˆê¸° zones.office ì‚¬ìš©)
        ctx.fillStyle = '#f8fafc'; ctx.fillRect(zones.office.x, zones.office.y, zones.office.w, zones.office.h); 
        ctx.fillStyle = '#e2e8f0'; ctx.fillRect(zones.office.x, height - 50, zones.office.w, 50);
        
        fairies.forEach((f, i) => {
            if (f.role === 'OFFICE') {
                const deskX = f.seatX; const deskY = f.seatY;
                ctx.fillStyle = '#cbd5e1'; ctx.fillRect(deskX - 25, deskY + 10, 50, 30); ctx.fillStyle = '#475569'; ctx.fillRect(deskX - 15, deskY - 20, 30, 25); 
                
                // [NEW] Warm White/Silver Glow for Logo Complete state
                if (isLogoComplete) {
                      const phase = Date.now() * 0.003;
                      const b = Math.floor(150 + 105 * (Math.sin(phase) + 1) / 2);
                      ctx.fillStyle = `rgb(255, 255, ${b})`;
                      ctx.shadowColor = `rgb(255, 255, ${b})`; 
                      ctx.shadowBlur = 10; 
                } else {
                    const hue = (monitorHueOffset + i * 10) % 360;
                    ctx.fillStyle = `hsl(${hue}, 70%, 80%)`;
                    ctx.shadowBlur = 0;
                }
                ctx.fillRect(deskX - 13, deskY - 18, 26, 20); ctx.shadowBlur = 0;
            }
        });
        ctx.fillStyle = isLogoComplete ? 'rgba(255,255,255,0.5)' : '#94a3b8'; 
        ctx.font = 'bold 15px "Pretendard", sans-serif'; ctx.textAlign='right'; ctx.fillText('Â©shimhayeon', width - 50, height - 30);
    }
    
    function animate() {
        if (!isGamePaused) {
            const now = Date.now(); 
            if (now - lastDropTime > CONFIG.dropInterval / GAME_SPEED) { 
                const p = particles.find(p => p.state === 'WAITING'); 
                if (p) { p.state = 'FALLING'; lastDropTime = now; } 
            }
        }

        const placedCount = particles.filter(p => p.state === 'PLACED').length;
        // [NEW] Logo Completion Trigger
        if (!isLogoComplete && placedCount > 0 && placedCount === particles.length) {
            isLogoComplete = true;
            mainSnowflakes = [];
            const width = window.innerWidth;
            const height = window.innerHeight;
            for(let i=0; i<100; i++) mainSnowflakes.push(new MainSnowflake(width, height));
            santaObj.active = true;
            santaObj.x = -100;
            santaObj.y = 100;
            
            // ìŒì•… ì „í™˜
            switchBgmToCarol();
        }
        
        const width = window.innerWidth;
        const height = window.innerHeight;

        // Clear handled in drawEnvironment
        // ctx.clearRect(0, 0, width, height); 
        drawEnvironment(); 
        
        // [NEW] Draw snow and santa if logo complete
        if (isLogoComplete) {
            if (!isGamePaused) {
                mainSnowflakes.forEach(s => s.update(width, height, GAME_SPEED));
            }
            mainSnowflakes.forEach(s => s.draw(ctx));
            
            if (santaObj.active) {
                if (!isGamePaused) santaObj.x += 2 * GAME_SPEED;
                drawPixelSanta(ctx, santaObj.x, santaObj.y);
                if (santaObj.x > width + 100) santaObj.x = -100; 
            }

            drawStarlightText(ctx, "Happy New Year!", width/2, 150);
        }

        fairies.forEach(f => { f.update(); f.draw(); }); 
        
        // [MODIFIED] Draw Particles (Glow effect when complete)
        if (isLogoComplete) {
            ctx.save();
            const phase = Date.now() * 0.003;
            // ë¹›ì˜ ìƒ‰ìƒ: White <-> Warm Yellowish (Bê°’ë§Œ ì¡°ì ˆ)
            const b = Math.floor(150 + 105 * (Math.sin(phase) + 1) / 2);
            ctx.shadowColor = `rgb(255, 255, ${b})`;
            ctx.shadowBlur = 20 + 10 * Math.sin(phase * 1.5);
            particles.forEach(p => { p.update(); p.draw(); });
            ctx.restore();
        } else {
             particles.forEach(p => { p.update(); p.draw(); });
        }
        
        if (hoveredFairy) { hoveredFairy.drawBubble(); canvas.style.cursor = 'pointer'; } else { canvas.style.cursor = 'default'; }
        
        if (!isGamePaused) {
            monitorHueOffset += (isLogoComplete ? 5 : 1) * GAME_SPEED; 
        }

        // Logo text (guide) disappears when complete
        if (!isLogoComplete) { 
            ctx.save();
            ctx.globalAlpha = 0.05; 
            ctx.fillStyle = '#000'; 
            ctx.font = CONFIG.font; 
            ctx.textAlign='center'; 
            ctx.textBaseline = 'middle'; // [FIX] ê¸°ì¤€ì„ ì„ ì¤‘ì•™ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ë„íŠ¸ ìœ„ì¹˜ì™€ ì¼ì¹˜ì‹œí‚´
            ctx.fillText(CONFIG.text, width/2, height/2); 
            ctx.restore();
        }

        requestAnimationFrame(animate);
    }
    
    // Initial Load function definition
    async function loadInitialMessages() {
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL);
            const data = await response.json(); 
            if (data && data.length > 0) {
                const recent10 = [...data].reverse().slice(0, 10);
                const shuffledFairies = [...fairies].sort(() => 0.5 - Math.random());
                recent10.forEach((row, idx) => {
                    if (idx < shuffledFairies.length) {
                        const f = shuffledFairies[idx];
                        f.assignedMessage = { name: row[1], text: row[2] };
                        f.assignmentTime = Date.now(); 
                        let styleJson = row[3];
                        if (styleJson) { try { f.customStyle = JSON.parse(styleJson); } catch(e) {} }
                    }
                });
            }
        } catch (e) { console.error("Initial fetch failed:", e); }
    }

    // Touch Handling - Optimized
    canvas.addEventListener('touchstart', (e) => {
        if (e.target.closest('#input-bar') || e.target.closest('#modal-overlay') || e.target.closest('#audio-btn') || e.target.closest('.modal-window')) return;
        
        // Prevent mouse emulation events if handled here
        // e.preventDefault(); 
        
        const touch = e.touches[0]; const rect = canvas.getBoundingClientRect(); 
        const tx = touch.clientX - rect.left; const ty = touch.clientY - rect.top;
        
        let touchedFairy = false;
        fairies.forEach(f => {
            if (Math.abs(tx - f.x) < 40 && Math.abs(ty - f.y) < 50) {
                touchedFairy = true;
                if (f.assignedMessage) { hoveredFairy = f; playSound('pop'); setTimeout(() => { hoveredFairy = null; }, 3000); } 
                else { f.giveVacation(); }
            }
        });
    }, { passive: false });

    window.addEventListener('mousedown', (e) => {
        if (e.target.closest('#input-bar') || e.target.closest('#modal-overlay') || e.target.closest('.modal-window') || e.target.closest('#view-all-btn') || e.target.closest('#audio-btn')) return;
        
        const rect = canvas.getBoundingClientRect(); const cx = e.clientX - rect.left; const cy = e.clientY - rect.top;
        let clickedFairy = false; fairies.forEach(f => { if (Math.sqrt(Math.pow(cx-f.x,2)+Math.pow(cy-f.y,2)) < 30) { f.giveVacation(); clickedFairy = true; } }); 
    });

    let prevHoveredFairy = null; 
    window.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect(); mouseX = e.clientX - rect.left; mouseY = e.clientY - rect.top;
        let closest = null; let minDist = 30; 
        fairies.forEach(f => { const dx = mouseX - f.x; const dy = mouseY - f.y; const dist = Math.sqrt(dx*dx + dy*dy); if (dist < minDist) { minDist = dist; closest = f; } }); 
        hoveredFairy = closest;
        if (hoveredFairy) { canvas.style.cursor = 'pointer'; } else { canvas.style.cursor = 'default'; }
        if (closest !== prevHoveredFairy) { if (closest && closest.assignedMessage) { playSound('pop'); } prevHoveredFairy = closest; }
    });
    
    // [FIX] ì•ˆì „í•œ ì´ˆê¸°í™”: ëª¨ë“  ë¦¬ì†ŒìŠ¤ ë¡œë”© í›„ ì‹¤í–‰
    window.onload = function() {
        init(); 
        loadInitialMessages(); 
        animate();
    };

    // Resize handling with debounce
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(init, 200);
    });
    
</script>
</body>
</html>
