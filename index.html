<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOTMILL Guestbook</title>
    
    <!-- Pretendard Web Font -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { 
            margin: 0; overflow: hidden; background-color: #ffffff; 
            font-family: 'Pretendard', sans-serif; 
            user-select: none; -webkit-user-select: none; 
        }
        canvas { display: block; }
        
        /* UI ë ˆì´ì•„ì›ƒ */
        #ui { position: absolute; top: 30px; left: 30px; pointer-events: none; color: #333; z-index: 10; transition: all 0.3s; }
        h1 { margin: 0 0 5px 0; font-size: 1.8rem; color: #2c3e50; font-weight: 800; letter-spacing: -0.02em; } 
        
        /* ìš°í¸í•¨ ì•„ì´ì½˜ */
        #mailbox-icon {
            position: absolute; right: 30px; bottom: 210px; width: 40px; height: 50px;
            background: #ef4444; border: 4px solid #7f1d1d; border-radius: 8px 8px 0 0;
            cursor: pointer; z-index: 25; box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        #mailbox-icon:active { transform: scale(0.95); }
        #mailbox-icon::after { content: ''; position: absolute; top: 12px; left: 50%; transform: translateX(-50%); width: 20px; height: 6px; background: #7f1d1d; border-radius: 2px; }
        #mailbox-icon::before { content: ''; position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%); width: 8px; height: 20px; background: #333; z-index: -1; }
        #mailbox-text {
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px;
            font-size: 11px; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }
        #mailbox-icon:hover #mailbox-text { opacity: 1; }

        .desc { font-size: 0.8rem; color: #555; background: rgba(255,255,255,0.8); padding: 12px 18px; border-radius: 12px; backdrop-filter: blur(5px); box-shadow: 0 2px 10px rgba(0,0,0,0.05); line-height: 1.6; letter-spacing: -0.01em; margin-top: 5px; }
        .sub-desc { margin-top: 8px; font-size: 0.85rem; color: #475569; background: rgba(255, 255, 255, 0.9); padding: 12px 18px; border-radius: 12px; backdrop-filter: blur(5px); box-shadow: 0 2px 10px rgba(0,0,0,0.05); line-height: 1.5; font-weight: 500; }

        .green-txt { color: #00e676; font-weight: 700; }
        .blue-txt { color: #2979ff; font-weight: 700; }
        .yellow-txt { color: #ef4444; font-weight: 700; } 
        .gray-txt { color: #555; font-weight: 700; }

        /* ì•ˆë‚´ ë©˜íŠ¸ & ë²„íŠ¼ */
        #guide-text {
            position: absolute; top: 30px; right: 30px; text-align: right; color: #444; pointer-events: none; z-index: 10;
            background: rgba(255,255,255,0.85); padding: 15px 20px; border-radius: 12px; backdrop-filter: blur(5px); box-shadow: 0 2px 10px rgba(0,0,0,0.05); letter-spacing: -0.01em;
        }
        #guide-text h2 { margin: 0 0 8px 0; font-size: 1.1rem; color: #2c3e50; font-weight: 700; }
        #guide-text p { margin: 0; font-size: 0.9rem; line-height: 1.5; color: #666; font-weight: 400; }

        #view-all-btn {
            position: absolute; top: 140px; right: 30px; background: #2c3e50; color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s, background 0.2s; z-index: 20; pointer-events: auto; font-family: 'Pretendard', sans-serif; 
        }
        #view-all-btn:hover { background: #0056b3; transform: scale(1.05); }

        #audio-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; background-color: #2c3e50; color: white; border: 3px solid white; border-radius: 50%; cursor: pointer; z-index: 1000; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3); transition: transform 0.2s; }
        #audio-btn:active { transform: scale(0.9); }

        /* ì•Œë¦¼ì°½ */
        #custom-alert { display: none; position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px 40px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 200; text-align: center; border: 1px solid #eee; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); width: 80%; max-width: 320px; }
        #custom-alert h3 { margin: 0 0 10px 0; color: #2c3e50; font-weight: 700; font-size: 1.3rem; }
        #pc-toast { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(30, 41, 59, 0.9); color: white; padding: 12px 24px; border-radius: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 300; text-align: center; font-size: 0.9rem; pointer-events: none; animation: fadeInOut 2.5s ease forwards; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-window { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 800px; height: 600px; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.2); z-index: 100; flex-direction: column; overflow: hidden; border: 1px solid #f1f1f1; animation: fadeIn 0.3s ease; max-width: 90%; max-height: 90%; }
        #list-modal { width: 400px; height: 600px; }
        .modal-header { padding: 20px 25px; background: #fff; border-bottom: 1px solid #f1f1f1; font-weight: 700; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; color: #1e293b; z-index: 10; position: relative;}
        .view-toggle { display: flex; background: #f1f5f9; border-radius: 20px; padding: 4px; gap: 4px; font-size: 0.85rem; font-weight: 600; margin-left: auto; margin-right: 15px; }
        .view-toggle label { cursor: pointer; padding: 6px 12px; border-radius: 16px; color: #64748b; transition: all 0.2s; display: flex; align-items: center; gap: 4px; }
        .view-toggle label.active { background: white; color: #0ea5e9; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .close-modal-btn { cursor: pointer; font-size: 1.5rem; color: #94a3b8; margin-left: 0; }
        .msg-list-container { flex: 1; overflow-y: auto; padding: 0; background: #f8fafc; }
        .list-item { padding: 20px 25px; border-bottom: 1px solid #f1f5f9; background: white; }
        .list-date { font-size: 0.8rem; color: #94a3b8; margin-bottom: 6px; }
        .list-receiver { font-weight: 700; color: #0ea5e9; margin-right: 6px; font-size: 0.95rem; }
        .list-text { color: #334155; font-size: 1rem; word-break: break-all; line-height: 1.5; }
        .empty-msg { text-align: center; padding: 40px; color: #94a3b8; font-size: 0.95rem; }
        
        #my-msg-auth { padding: 20px; background: #fff; border-bottom: 1px solid #e2e8f0; display: flex; gap: 10px; z-index: 10; position: relative; }
        #my-name-input { flex: 1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; font-family: 'Pretendard'; }
        #my-msg-btn { background: #0ea5e9; color: white; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: 'Pretendard'; }
        #mailbox-content-area { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; }
        #mailbox-canvas-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: #0f172a; overflow: hidden; display: none; }
        #mailbox-bg-canvas { width: 100%; height: 100%; cursor: pointer; }
        #mailbox-placeholder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #94a3b8; text-align: center; width: 100%; pointer-events: none; line-height: 1.6; }
        #my-msg-list-container { flex: 1; overflow-y: auto; background: #f8fafc; display: none; }
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 90; backdrop-filter: blur(4px); }

        /* ì…ë ¥ë°” ìŠ¤íƒ€ì¼ */
        #input-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 620px; background: rgba(255, 255, 255, 0.95); padding: 8px 12px; border-radius: 50px; box-shadow: 0 10px 40px rgba(0,0,0,0.12); display: flex; align-items: center; gap: 8px; z-index: 30; border: 1px solid #e2e8f0; backdrop-filter: blur(10px); }
        
        .to-all-wrapper { display: flex; align-items: center; white-space: nowrap; font-size: 14px; font-weight: 600; color: #475569; margin-right: 2px; cursor: pointer; user-select: none; }
        .to-all-wrapper input { margin-right: 4px; accent-color: #0ea5e9; width: 16px; height: 16px; cursor: pointer; }

        #receiver-input { width: 80px; padding: 12px; border: none; border-radius: 25px; background: #e0f2fe; text-align: center; outline: none; font-size: 15px; font-family: 'Pretendard', sans-serif; font-weight: 600; color: #0369a1; transition: all 0.2s; } 
        #receiver-input::placeholder { color: #7dd3fc; font-weight: 500; }
        #receiver-input:disabled { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; }

        #msg-input { flex: 1; padding: 12px 16px; border: none; border-radius: 25px; background: #f1f5f9; outline: none; font-size: 16px; font-family: 'Pretendard', sans-serif; color: #334155; }
        #send-btn { background: #0ea5e9; color: white; border: none; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: background 0.2s, transform 0.1s; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3); flex-shrink: 0; }
        #send-btn:hover { background: #0284c7; transform: scale(1.05); }
        #send-btn:active { transform: scale(0.95); }
        #send-btn:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; }

        /* ìŠ¤íƒ€ì¼ ë²„íŠ¼ ê·¸ë£¹ */
        #style-group { position: relative; display: flex; align-items: center; }
        #style-toggle-btn {
            width: 42px; height: 42px; border-radius: 50%; border: 1px solid #cbd5e1; background: #fff;
            color: #64748b; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
        }
        #style-toggle-btn:hover { background: #f1f5f9; color: #334155; }
        #style-toggle-btn.active { background: #e0f2fe; color: #0ea5e9; border-color: #0ea5e9; }

        #style-options {
            position: absolute; bottom: 55px; left: 0; 
            background: white; padding: 8px; border-radius: 16px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); border: 1px solid #e2e8f0;
            display: none; flex-direction: column; gap: 8px;
            animation: popIn 0.2s ease;
        }
        #style-options.show { display: flex; }
        
        .style-opt-btn {
            width: 40px; height: 40px; border-radius: 12px; border: 1px solid #e2e8f0;
            background: #f8fafc; cursor: pointer; font-size: 1.2rem;
            display: flex; align-items: center; justify-content: center;
            position: relative;
        }
        .style-opt-btn:hover { background: #f1f5f9; }
        
        /* ìŠ¤íƒ€ì¼ ì¸ë””ì¼€ì´í„° */
        .style-indicator {
            position: absolute; bottom: -2px; right: -2px;
            width: 16px; height: 16px; border-radius: 50%;
            background: #333; border: 2px solid white;
            font-size: 10px; color: white; display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-family: 'Pretendard', sans-serif;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -45%); } to { opacity: 1; transform: translate(-50%, -50%); } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translate(-50%, -40%); } 10% { opacity: 1; transform: translate(-50%, -50%); } 90% { opacity: 1; transform: translate(-50%, -50%); } 100% { opacity: 0; transform: translate(-50%, -60%); } }

        @media (max-width: 768px) {
            #guide-text { display: block; top: 10px; left: 50%; right: auto; transform: translateX(-50%); width: 90%; text-align: center; }
            #view-all-btn { top: auto; bottom: 90px; right: auto; left: 50%; transform: translateX(-50%); padding: 8px 16px; font-size: 0.8rem; }
            #audio-btn { bottom: auto; top: 20px; right: 20px; width: 40px; height: 40px; font-size: 1.2rem; }
            #ui { top: 95px; width: 92%; }
            #ui h1 { display: none; } 
            #mailbox-icon { right: 20px; bottom: 210px; }
            .desc { font-size: 0.7rem; }
            .sub-desc { font-size: 0.75rem; }
            #input-bar { bottom: 20px; width: 95%; padding: 8px; gap: 6px; }
            .to-all-wrapper { font-size: 13px; }
            #receiver-input { width: 50px; font-size: 13px; }
            #msg-input { font-size: 14px; }
            #send-btn { width: 36px; height: 36px; font-size: 1rem; }
            #style-toggle-btn { width: 36px; height: 36px; font-size: 1.1rem; }
            .modal-window { width: 380px; height: 550px; }
            #list-modal { width: 380px; height: 550px; }
        }
    </style>
</head>
<body>

    <div id="ui">
        <h1>DOTMILL</h1>
        <div class="desc">
            <span class="green-txt">â— ë°©ê¸ˆ ë„ì°©í•œ ë©”ì‹œì§€ ì•Œë¦¼</span>
            <span class="blue-txt">â— íŒŒë€ ì˜·ì„ ì…ì€ ë™ë£Œë“¤ í™•ì¸</span>
            <span class="yellow-txt">â— ë¹¨ê°„ ìš°í¸í•¨ í´ë¦­: ë‚´ ìš°í¸í•¨</span> 
            <span class="gray-txt">â— ë¡œê³  í´ë¦­: ì‘ì—… ë¦¬ì…‹</span>
        </div>
        <div class="sub-desc">
            ì—¬ê¸°ëŠ” Dotì„ êµ´ë ¤ì„œ ë©‹ì§„ ê±¸ ë§Œë“œëŠ” ë°©ì•—ê°„ì´ì—ìš”.<br>
            ì§ì›ì„ ëˆŒëŸ¬ì„œ íœ´ì‹ì„ ì„ ë¬¼í•´ì£¼ì„¸ìš”.
        </div>
    </div>

    <div id="mailbox-icon" title="ë‚´ ìš°í¸í•¨ í™•ì¸í•˜ê¸°" onclick="openMyMsgModal()">
        <div id="mailbox-text">ë‚´ ìš°í¸í•¨</div>
    </div>

    <div id="guide-text">
        <h2>2026 ìƒˆí•´ ë§ì´ ë‹·ë°€ ë¡¤ë§í˜ì´í¼ ğŸ“œ</h2>
        <p>
            ì˜¬ í•œ í•´ ê³ ìƒí•œ ë™ë£Œì—ê²Œ ì¹­ì°¬ê³¼ ì‘ì›ì˜ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì£¼ì„¸ìš”!<br>
            ë³´ë‚´ëŠ” ì‚¬ëŒì€ ìµëª…ìœ¼ë¡œ ì²˜ë¦¬ë˜ë©°, ë™ë£Œì˜ ì´ë¦„ìœ¼ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.
        </p>
    </div>

    <button id="view-all-btn">ğŸ“œ ì „ì²´ ë©”ì‹œì§€ ë³´ê¸°</button>
    <button id="audio-btn">ğŸ”‡</button>

    <div id="custom-alert">
        <span id="alert-check">âœ…</span>
        <h3>ì „ì†¡ ì™„ë£Œ!</h3>
        <p>ìµëª…ìœ¼ë¡œ ë©”ì‹œì§€ê°€ ë¬´ì‚¬íˆ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“¨</p>
    </div>

    <div id="pc-toast">
        PCì—ì„œ ì ‘ì†í•˜ì‹œë©´ ìµœì í™”ëœ ê²½í—˜ì„ í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤ ğŸ’»
    </div>

    <div id="modal-overlay"></div>

    <!-- ì „ì²´ ë©”ì‹œì§€í•¨ -->
    <div id="list-modal" class="modal-window">
        <div class="modal-header">ì „ì²´ ë©”ì‹œì§€í•¨ <span class="close-modal-btn" data-target="list-modal">Ã—</span></div>
        <div id="msg-list" class="msg-list-container"><div class="empty-msg">ë¡œë”© ì¤‘... â³</div></div>
    </div>

    <!-- ë‚´ ë©”ì‹œì§€ í™•ì¸í•¨ -->
    <div id="my-msg-modal" class="modal-window">
        <div class="modal-header">
            <span>ğŸ“¬ ë‚˜ì—ê²Œ ì˜¨ ë©”ì‹œì§€</span>
            <div class="view-toggle">
                <label id="toggle-list" onclick="setViewMode('list')">ğŸ“„ ëª©ë¡</label>
                <label id="toggle-scene" onclick="setViewMode('scene')" class="active">âœ¨ ì¥ë©´</label>
            </div>
            <span class="close-modal-btn" data-target="my-msg-modal">Ã—</span>
        </div>
        <div id="my-msg-auth">
            <input type="text" id="my-name-input" placeholder="ë³¸ì¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" onkeypress="if(event.key==='Enter') checkMyMessages()">
            <button id="my-msg-btn" onclick="checkMyMessages()">í™•ì¸</button>
        </div>
        <div id="mailbox-content-area">
            <div id="mailbox-placeholder">ì´ë¦„ì„ ì…ë ¥í•˜ê³  í™•ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.<br>(ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤)</div>
            <div id="my-msg-list-container"></div>
            <div id="mailbox-canvas-container">
                <canvas id="mailbox-bg-canvas"></canvas>
            </div>
        </div>
    </div>

    <div id="input-bar">
        <label class="to-all-wrapper" title="ì²´í¬í•˜ë©´ ëª¨ë‘ì—ê²Œ ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤">
            <input type="checkbox" id="to-all-check">
            <span>ëª¨ë‘</span>
        </label>
        
        <input type="text" id="receiver-input" placeholder="ë°›ëŠ”ë¶„" maxlength="5">
        
        <!-- ìŠ¤íƒ€ì¼ ì„¤ì • ë²„íŠ¼ ê·¸ë£¹ -->
        <div id="style-group">
            <button id="style-toggle-btn" title="ìºë¦­í„° ê¾¸ë¯¸ê¸°">ğŸ‘•</button>
            <div id="style-options">
                <div class="style-opt-btn" onclick="cycleStyle('hair')" title="í—¤ì–´ìŠ¤íƒ€ì¼">
                    ğŸ’‡â€â™€ï¸ <div class="style-indicator" id="ind-hair">ğŸ§‘</div>
                </div>
                <div class="style-opt-btn" onclick="cycleStyle('shirt')" title="ì˜· ìƒ‰ìƒ">
                    ğŸ¨ <div class="style-indicator" id="ind-shirt" style="background: #3b82f6;"></div>
                </div>
                <div class="style-opt-btn" onclick="cycleStyle('acc')" title="ì¥ì‹">
                    ğŸ€ <div class="style-indicator" id="ind-acc">âŒ</div>
                </div>
            </div>
        </div>

        <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ (ìµëª…)" autocomplete="off" maxlength="40">
        <button id="send-btn">â¤</button>
    </div>

    <canvas id="canvas"></canvas>

<script>
    // [ì¤‘ìš”] ì—¬ê¸°ì— ìƒˆë¡œ ë°°í¬í•˜ì‹  Google Apps Scriptì˜ URLì„ ë„£ì–´ì£¼ì„¸ìš”.
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwqwO64o1ozDYp5Gbw8NP3W0Xu4eFpEyHRoaXDXXrYlnHg8AKXR54hrlUjxtE5ZCfQ6lw/exec";

    // --- [ì‚¬ìš´ë“œ] ---
    const audioFiles = {};
    const soundNames = ['bgm', 'sent', 'rest', 'pop', 'reset'];
    let isBgmOn = false; 
    
    soundNames.forEach(name => {
        const audio = new Audio(`sounds/${name}.mp3`);
        if(name === 'bgm') { audio.loop = true; audio.volume = 0.4; } 
        else { audio.volume = name === 'reset' ? 1.0 : 0.8; if(name === 'pop') audio.volume = 0.5; }
        audioFiles[name] = audio;
    });

    const audioBtn = document.getElementById('audio-btn');
    audioBtn.addEventListener('click', () => {
        if (isBgmOn) {
            audioFiles['bgm'].pause(); audioBtn.innerText = 'ğŸ”‡'; isBgmOn = false;
        } else {
            audioFiles['bgm'].play().then(() => { audioBtn.innerText = 'ğŸ”Š'; isBgmOn = true; })
            .catch(e => { alert("ì†Œë¦¬ íŒŒì¼ì„ ë¡œë”© ì¤‘ì´ê±°ë‚˜ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); });
        }
    });
    
    function playSound(name) {
        if (isBgmOn && audioFiles[name]) { audioFiles[name].currentTime = 0; audioFiles[name].play().catch(e => {}); }
    }

    const receiverInput = document.getElementById('receiver-input'); 
    const msgInput = document.getElementById('msg-input');
    const sendBtn = document.getElementById('send-btn');
    const viewAllBtn = document.getElementById('view-all-btn');
    const toAllCheck = document.getElementById('to-all-check'); 
    
    const listModal = document.getElementById('list-modal');
    const myMsgModal = document.getElementById('my-msg-modal');
    const overlay = document.getElementById('modal-overlay');
    const closeBtns = document.querySelectorAll('.close-modal-btn');
    
    const msgList = document.getElementById('msg-list');
    const myNameInput = document.getElementById('my-name-input');
    const customAlert = document.getElementById('custom-alert');

    // [ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ ë°ì´í„°]
    // íŒŒë‘, ê²€ì •, íšŒìƒ‰ + ë¬´ì§€ê°œìƒ‰ (ë¹¨, ì£¼, ë…¸, ì´ˆ, í•˜ëŠ˜, ë‚¨, ë³´ë¼) ì´ 10ìƒ‰
    const CUSTOM_SHIRT_COLORS = [
        '#3b82f6', '#1e293b', '#64748b', // Blue, Black, Gray (ê¸°ì¡´)
        '#ef4444', '#f97316', '#eab308', // Red, Orange, Yellow
        '#22c55e', '#0ea5e9', '#6366f1', '#a855f7' // Green, Sky, Indigo, Purple
    ]; 
    const HAIR_ICONS = ['ğŸ§‘', 'ğŸ¦±', 'ğŸ‘±', 'ğŸ‘©']; // 4 styles
    const ACC_ICONS = ['âŒ', 'ğŸ„', 'ğŸŒ¸']; // 3 styles (Lantern -> Flower)

    let currentStyle = { hair: 0, shirt: 0, acc: 0 };

    const styleToggleBtn = document.getElementById('style-toggle-btn');
    const styleOptions = document.getElementById('style-options');
    const indHair = document.getElementById('ind-hair');
    const indShirt = document.getElementById('ind-shirt');
    const indAcc = document.getElementById('ind-acc');

    styleToggleBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        styleOptions.classList.toggle('show');
        styleToggleBtn.classList.toggle('active');
    });

    window.addEventListener('click', (e) => {
        if (!e.target.closest('#style-group')) {
            styleOptions.classList.remove('show');
            styleToggleBtn.classList.remove('active');
        }
    });

    function cycleStyle(type) {
        if (type === 'hair') {
            currentStyle.hair = (currentStyle.hair + 1) % HAIR_ICONS.length;
            indHair.innerText = HAIR_ICONS[currentStyle.hair];
        } else if (type === 'shirt') {
            currentStyle.shirt = (currentStyle.shirt + 1) % CUSTOM_SHIRT_COLORS.length;
            indShirt.style.backgroundColor = CUSTOM_SHIRT_COLORS[currentStyle.shirt];
        } else if (type === 'acc') {
            currentStyle.acc = (currentStyle.acc + 1) % ACC_ICONS.length;
            indAcc.innerText = ACC_ICONS[currentStyle.acc];
        }
    }

    // [ë·° ëª¨ë“œ ê´€ë¦¬]
    let currentViewMode = 'scene';
    const mbListContainer = document.getElementById('my-msg-list-container');
    const mbCanvasContainer = document.getElementById('mailbox-canvas-container');
    const mbToggleList = document.getElementById('toggle-list');
    const mbToggleScene = document.getElementById('toggle-scene');

    function setViewMode(mode) {
        currentViewMode = mode;
        if (mode === 'list') {
            mbListContainer.style.display = 'block';
            mbCanvasContainer.style.display = 'none';
            mbToggleList.classList.add('active');
            mbToggleScene.classList.remove('active');
            if (mbAnimationId) cancelAnimationFrame(mbAnimationId);
        } else {
            mbListContainer.style.display = 'none';
            mbCanvasContainer.style.display = 'block';
            mbToggleList.classList.remove('active');
            mbToggleScene.classList.add('active');
            resizeMailboxCanvas();
            animateMailbox(); 
        }
    }

    function resizeMailboxCanvas() {
        const rect = document.getElementById('mailbox-content-area').getBoundingClientRect();
        mbCanvas.width = rect.width;
        mbCanvas.height = rect.height;
    }

    const mbCanvas = document.getElementById('mailbox-bg-canvas');
    const mbCtx = mbCanvas.getContext('2d');
    const mbPlaceholder = document.getElementById('mailbox-placeholder');
    let mbDancers = [];
    let mbSnowflakes = [];
    let mbAnimationId = null;
    let mbMouse = { x: -1000, y: -1000 };

    mbCanvas.addEventListener('mousemove', (e) => {
        const rect = mbCanvas.getBoundingClientRect();
        const scaleX = mbCanvas.width / rect.width;
        const scaleY = mbCanvas.height / rect.height;
        mbMouse.x = (e.clientX - rect.left) * scaleX;
        mbMouse.y = (e.clientY - rect.top) * scaleY;
    });
    mbCanvas.addEventListener('mouseleave', () => { mbMouse.x = -1000; mbMouse.y = -1000; });

    toAllCheck.addEventListener('change', (e) => {
        if (e.target.checked) {
            receiverInput.disabled = true; receiverInput.value = ''; receiverInput.placeholder = 'ì „ì²´';
        } else {
            receiverInput.disabled = false; receiverInput.placeholder = 'ë°›ëŠ”ë¶„';
        }
    });

    function showCustomAlert() {
        customAlert.style.display = 'block'; setTimeout(() => { customAlert.style.display = 'none'; }, 2500);
    }

    async function sendMessage() {
        let receiver = '';
        const rawName = receiverInput.value.trim();

        if (toAllCheck.checked) {
            receiver = 'ALL';
        } else {
            const namePattern = /^[ê°€-í£]{3}$/;
            if (!namePattern.test(rawName)) return alert("ë°›ëŠ” ë¶„ì˜ ì •í™•í•œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(í•œê¸€ 3ê¸€ì)");
            receiver = rawName;
        }

        const text = msgInput.value.trim();
        if (!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        
        sendBtn.disabled = true; const originalPlaceholder = msgInput.placeholder;
        msgInput.value = ''; msgInput.placeholder = 'ì „ì†¡ ì¤‘... ğŸš€';
        
        const styleData = JSON.stringify(currentStyle);
        const finalPayload = { name: receiver, text: text, style: styleData };

        try {
            await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(finalPayload) });
            
            if (window.distributeSingleMessage) {
                window.distributeSingleMessage({ 
                    name: receiver, 
                    text: text, 
                    style: { ...currentStyle } 
                });
            }
            playSound('sent'); showCustomAlert();
            if (!toAllCheck.checked) receiverInput.value = ''; 
        } catch (error) { alert("ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); } finally { sendBtn.disabled = false; msgInput.placeholder = originalPlaceholder; msgInput.focus(); }
    }

    async function fetchAllMessages() {
        msgList.innerHTML = '<div class="empty-msg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...<br>(ì•½ 1~2ì´ˆ ì†Œìš”)</div>';
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL); const data = await response.json(); msgList.innerHTML = ''; 
            if (!data || data.length === 0) { msgList.innerHTML = '<div class="empty-msg">ë©”ì‹œì§€ ì—†ìŒ</div>'; return; }
            data.forEach(row => {
                const dateRaw = new Date(row[0]); const dateStr = (dateRaw.getMonth()+1) + '/' + dateRaw.getDate() + ' ' + dateRaw.getHours() + ':' + String(dateRaw.getMinutes()).padStart(2,'0');
                const div = document.createElement('div'); div.className = 'list-item';
                
                let displayMsg = row[2] || "";

                let displayReceiver = row[1];
                let receiverClass = 'list-receiver';
                if (displayReceiver === 'ALL') {
                    displayReceiver = 'ëª¨ë‘ì—ê²Œ ğŸ“¢'; receiverClass = 'list-receiver green-txt'; 
                } else {
                    displayReceiver = `To. ${displayReceiver}`;
                }
                div.innerHTML = `<div class="list-date">${dateStr}</div><div><span class="${receiverClass}">${displayReceiver}</span> <span class="list-text">${displayMsg}</span></div>`;
                msgList.appendChild(div);
            });
        } catch (error) { msgList.innerHTML = '<div class="empty-msg">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨!</div>'; }
    }

    class Snowflake {
        constructor(w, h) {
            this.x = Math.random() * w; this.y = Math.random() * h;
            this.size = Math.random() * 2 + 0.5; this.speed = Math.random() * 1 + 0.5;
            this.opacity = Math.random() * 0.5 + 0.3;
        }
        update(w, h) {
            this.y += this.speed; this.x += Math.sin(this.y * 0.05) * 0.5;
            if (this.y > h) { this.y = -10; this.x = Math.random() * w; }
        }
        draw(ctx) {
            ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
            ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
        }
    }

    // --- ìš°í¸í•¨ ë‚´ë¶€ ëŒ„ì„œ ---
    class PartyFairy {
        constructor(msg, isPrivate, w, h) {
            this.msg = msg; 
            this.isPrivate = isPrivate; 
            this.x = Math.random() * (w - 60) + 30;
            this.y = Math.random() * (h - 100) + 80; 
            
            this.style = msg.style || { hair: 0, shirt: 0, acc: 0 };
            
            this.shirtColor = CUSTOM_SHIRT_COLORS[this.style.shirt] || CUSTOM_SHIRT_COLORS[0];

            this.bodyOffset = Math.random() * 100;
            this.dir = Math.random() < 0.5 ? -1 : 1;
            this.speed = 0.5 + Math.random();
            this.blinkTimer = Math.random() * 200;
            this.isBlinking = false;
            this.isHovered = false; 
        }

        update(w, h) {
            this.bodyOffset += 0.15;
            this.x += this.dir * this.speed * 0.3;
            if (this.x < 30 || this.x > w - 30) this.dir *= -1;
            this.blinkTimer--;
            if (this.blinkTimer <= 0) {
                this.isBlinking = true;
                if (this.blinkTimer <= -10) { this.isBlinking = false; this.blinkTimer = 100 + Math.random() * 200; }
            }
        }

        draw(ctx) {
            ctx.save();
            ctx.translate(this.x, this.y);
            
            const bounce = Math.sin(this.bodyOffset) * 6;
            ctx.translate(0, bounce);

            if (this.isPrivate) { ctx.shadowColor = '#ff69b4'; ctx.shadowBlur = 20; }

            ctx.fillStyle = this.shirtColor;
            ctx.fillRect(-8, -15, 16, 20); // Body
            ctx.fillStyle = '#333';
            ctx.fillRect(-8, 5, 16, 10); // Pants

            ctx.fillStyle = '#fce4d4';
            ctx.fillRect(-6, -24, 12, 9); 
            
            ctx.shadowBlur = 0;
            ctx.fillStyle = '#333';
            if (this.isBlinking) {
                ctx.fillRect(-4, -22, 3, 1); ctx.fillRect(2, -22, 3, 1);
            } else {
                ctx.fillRect(-4, -23, 2, 2); ctx.fillRect(2, -23, 2, 2);
            }

            this.drawHair(ctx);

            ctx.strokeStyle = this.shirtColor; ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(-8, -12); ctx.lineTo(-14, -12 - Math.cos(this.bodyOffset) * 5);
            ctx.moveTo(8, -12); ctx.lineTo(14, -12 + Math.cos(this.bodyOffset) * 5);
            ctx.stroke();

            this.drawAcc(ctx);
            this.drawBubble(ctx);

            ctx.restore();
        }

        drawHair(ctx) {
            ctx.fillStyle = '#4a3b2a';
            const h = this.style.hair;
            
            if (h === 0) { // ê¸°ë³¸/ì§§ì€ë¨¸ë¦¬ (ë‹¨ì •í•œ ìˆì»·)
                ctx.fillRect(-7, -26, 14, 4); 
                ctx.beginPath(); ctx.moveTo(-7, -24); ctx.lineTo(7, -24); ctx.quadraticCurveTo(8, -24, 8, -20); ctx.lineTo(-8, -20); ctx.quadraticCurveTo(-8, -24, -7, -24); ctx.fill();
            } else if (h === 1) { // íŒŒë§ˆë¨¸ë¦¬ (ë™ê¸€ë™ê¸€)
                ctx.beginPath(); 
                ctx.arc(0, -25, 8, Math.PI, 0); 
                ctx.arc(-6, -23, 4, 0, Math.PI*2);
                ctx.arc(6, -23, 4, 0, Math.PI*2);
                ctx.arc(0, -28, 4, 0, Math.PI*2);
                ctx.fill();
            } else if (h === 2) { // ë¬¶ìŒë¨¸ë¦¬ (ê½ì§€)
                ctx.fillRect(-7, -26, 14, 4); 
                ctx.beginPath(); ctx.arc(0, -28, 3.5, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.moveTo(0, -28); ctx.quadraticCurveTo(5, -32, 6, -26); ctx.stroke();
            } else { // ê¸´ë¨¸ë¦¬ (ë‹¨ë°œ~ì¥ë°œ)
                ctx.fillRect(-8, -26, 16, 6); 
                ctx.fillRect(-9, -22, 4, 12); ctx.fillRect(5, -22, 4, 12); // ì–‘ì˜† ë¨¸ë¦¬ ê¸¸ê²Œ
            }
        }

        drawAcc(ctx) {
            const a = this.style.acc;
            if (a === 1) { // ë£¨ëŒí”„ (ë” ì…ì²´ì ì¸ ë¿”)
                ctx.strokeStyle = '#8B4513'; ctx.lineWidth = 2; ctx.lineCap = 'round';
                // ì™¼ìª½ ë¿”
                ctx.beginPath(); ctx.moveTo(-3, -25); ctx.lineTo(-8, -32); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(-6, -29); ctx.lineTo(-4, -33); ctx.stroke();
                // ì˜¤ë¥¸ìª½ ë¿”
                ctx.beginPath(); ctx.moveTo(3, -25); ctx.lineTo(8, -32); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(6, -29); ctx.lineTo(4, -33); ctx.stroke();
                // ë¹¨ê°„ ì½”
                ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(0, -18, 1.5, 0, Math.PI*2); ctx.fill();
            } else if (a === 2) { // ë¨¸ë¦¬ì— ê½ƒ (NEW)
                ctx.fillStyle = '#ff69b4'; // Pink petals
                for(let i=0; i<5; i++) {
                    const angle = (i * 2 * Math.PI) / 5;
                    const r = 3;
                    ctx.beginPath();
                    ctx.arc(6 + Math.cos(angle)*r, -28 + Math.sin(angle)*r, 2, 0, Math.PI*2);
                    ctx.fill();
                }
                ctx.fillStyle = '#fff'; // Center
                ctx.beginPath(); ctx.arc(6, -28, 2, 0, Math.PI*2); ctx.fill();
            }
        }

        drawBubble(ctx) {
            const fullText = this.msg.text;
            const summaryText = fullText.length > 8 ? fullText.substring(0, 8) + '..' : fullText;
            const text = this.isHovered ? fullText : summaryText;

            ctx.font = 'bold 12px "Pretendard", sans-serif';
            const tm = ctx.measureText(text);
            const w = tm.width + 20;
            const h = 30;

            ctx.save();
            ctx.translate(0, -45); 
            
            ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
            ctx.strokeStyle = this.isPrivate ? 'rgba(255, 105, 180, 0.8)' : 'rgba(100, 200, 255, 0.5)';
            ctx.lineWidth = 1.5;
            
            ctx.beginPath(); ctx.roundRect(-w/2, -h, w, h, 10); ctx.fill(); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(-4, 6); ctx.lineTo(4, 6); ctx.closePath();
            ctx.fillStyle = this.isPrivate ? 'rgba(255, 105, 180, 0.8)' : 'rgba(100, 200, 255, 0.5)';
            ctx.fill();

            ctx.fillStyle = '#1e293b'; ctx.textAlign = 'center'; ctx.fillText(text, 0, -10);
            
            ctx.font = 'bold 11px "Pretendard", sans-serif';
            if (!this.isPrivate) {
                ctx.fillStyle = '#67e8f9'; ctx.fillText('To. ëª¨ë‘ì—ê²Œ', 0, -h - 6);
            } else {
                ctx.fillStyle = '#ff69b4'; ctx.fillText(`To. ${this.msg.name}`, 0, -h - 6);
            }
            ctx.restore();
        }
    }

    function animateMailbox() {
        if (myMsgModal.style.display === 'none' || currentViewMode !== 'scene') return; 
        
        mbCtx.clearRect(0, 0, mbCanvas.width, mbCanvas.height);
        
        const time = Date.now() * 0.0005;
        const g = mbCtx.createLinearGradient(0, 0, 0, mbCanvas.height);
        g.addColorStop(0, '#0f172a'); g.addColorStop(1, '#312e81'); 
        mbCtx.fillStyle = g; mbCtx.fillRect(0,0, mbCanvas.width, mbCanvas.height);

        mbCtx.save(); mbCtx.globalCompositeOperation = 'screen';
        const lightX = mbCanvas.width/2 + Math.sin(time) * 100;
        const lg = mbCtx.createRadialGradient(lightX, mbCanvas.height, 10, lightX, mbCanvas.height, 200);
        lg.addColorStop(0, 'rgba(56, 189, 248, 0.3)'); lg.addColorStop(1, 'rgba(56, 189, 248, 0)');
        mbCtx.fillStyle = lg; mbCtx.fillRect(0,0, mbCanvas.width, mbCanvas.height); mbCtx.restore();

        mbSnowflakes.forEach(s => { s.update(mbCanvas.width, mbCanvas.height); s.draw(mbCtx); });

        let hoveredDancer = null;
        mbDancers.forEach(d => {
            d.update(mbCanvas.width, mbCanvas.height);
            const dx = mbMouse.x - d.x; const dy = mbMouse.y - d.y;
            if (Math.sqrt(dx*dx + dy*dy) < 30) hoveredDancer = d;
            d.isHovered = false; 
        });
        if (hoveredDancer) hoveredDancer.isHovered = true;

        mbDancers.sort((a, b) => a.y - b.y);
        mbDancers.forEach(d => { if (d !== hoveredDancer) d.draw(mbCtx); });
        if (hoveredDancer) hoveredDancer.draw(mbCtx);

        mbAnimationId = requestAnimationFrame(animateMailbox);
    }

    async function checkMyMessages() {
        const myName = myNameInput.value.trim();
        if (!myName) return alert("ë³¸ì¸ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        
        mbPlaceholder.style.display = 'block'; mbPlaceholder.innerHTML = 'âœ¨ ìš°í¸í•¨ íŒŒí‹°ì¥ ì…ì¥ ì¤‘... âœ¨';
        mbListContainer.innerHTML = '<div class="empty-msg">ë¡œë”© ì¤‘...</div>';
        mbDancers = []; mbSnowflakes = [];
        
        resizeMailboxCanvas();
        for(let i=0; i<50; i++) mbSnowflakes.push(new Snowflake(mbCanvas.width, mbCanvas.height));

        try {
            const response = await fetch(GOOGLE_SCRIPT_URL); const data = await response.json(); 
            if (!data || data.length === 0) { 
                const emptyText = 'ì•„ì§ ë„ì°©í•œ í¸ì§€ê°€ ì—†ì–´ìš” ğŸ˜¢';
                mbPlaceholder.innerHTML = emptyText; mbListContainer.innerHTML = `<div class="empty-msg">${emptyText}</div>`; return; 
            }

            const myMessages = data.filter(row => row[1] === 'ALL' || row[1].replace(/\s/g, '') === myName.replace(/\s/g, ''));
            
            if (myMessages.length === 0) {
                const emptyText = `'${myName}'ë‹˜ê³¼ ëª¨ë‘ì—ê²Œ ë„ì°©í•œ<br>ë©”ì‹œì§€ê°€ ì•„ì§ ì—†ë„¤ìš”. í……~`;
                mbPlaceholder.innerHTML = emptyText; mbListContainer.innerHTML = `<div class="empty-msg">${emptyText}</div>`; return;
            }

            mbListContainer.innerHTML = '';
            myMessages.forEach(row => {
                const dateRaw = new Date(row[0]); const dateStr = (dateRaw.getMonth()+1) + '/' + dateRaw.getDate() + ' ' + dateRaw.getHours() + ':' + String(dateRaw.getMinutes()).padStart(2,'0');
                const div = document.createElement('div'); div.className = 'list-item';
                
                let displayMsg = row[2] || "";

                let prefix = (row[1] === 'ALL') ? '<span style="color:#00e676; font-size:0.8rem; margin-right:5px; font-weight:bold;">[ì „ì²´]</span>' : '<span style="color:#ec4899; font-size:0.8rem; margin-right:5px; font-weight:bold;">[ë‚˜ì—ê²Œ]</span>';
                div.innerHTML = `<div class="list-date">${dateStr}</div><div>${prefix}<span class="list-text" style="font-weight:bold;">${displayMsg}</span></div>`;
                mbListContainer.appendChild(div);
            });

            mbPlaceholder.style.display = 'none'; 
            const displayMessages = myMessages.slice(0, 10); 
            displayMessages.forEach(row => {
                const isPrivate = (row[1] !== 'ALL');
                
                let text = row[2] || "";
                let styleJson = row[3];
                let style = { hair: 0, shirt: 0, acc: 0 };
                if (styleJson) {
                    try { style = JSON.parse(styleJson); } catch(e) {}
                }

                mbDancers.push(new PartyFairy({ name: row[1], text: text, style: style }, isPrivate, mbCanvas.width, mbCanvas.height));
            });

            if (currentViewMode === 'scene') { if (mbAnimationId) cancelAnimationFrame(mbAnimationId); animateMailbox(); }

        } catch (error) { 
            mbPlaceholder.innerHTML = 'ì…ì¥ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'; mbListContainer.innerHTML = '<div class="empty-msg">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
    viewAllBtn.addEventListener('click', () => { listModal.style.display = 'flex'; overlay.style.display = 'block'; fetchAllMessages(); });
    closeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetId = btn.getAttribute('data-target');
            document.getElementById(targetId).style.display = 'none'; overlay.style.display = 'none';
            if (targetId === 'my-msg-modal') { if (mbAnimationId) cancelAnimationFrame(mbAnimationId); }
        });
    });
    function hideAllModals() {
        listModal.style.display = 'none'; myMsgModal.style.display = 'none'; overlay.style.display = 'none';
        if (mbAnimationId) cancelAnimationFrame(mbAnimationId);
    }
    overlay.addEventListener('click', hideAllModals);
    window.openMyMsgModal = () => {
        myMsgModal.style.display = 'flex'; overlay.style.display = 'block'; myNameInput.focus();
        setViewMode('scene');
        mbPlaceholder.style.display = 'block'; mbPlaceholder.innerHTML = 'ì´ë¦„ì„ ì…ë ¥í•˜ê³  í™•ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
        mbListContainer.innerHTML = ''; mbCtx.clearRect(0,0, mbCanvas.width, mbCanvas.height);
        resizeMailboxCanvas(); mbSnowflakes = []; for(let i=0; i<30; i++) mbSnowflakes.push(new Snowflake(mbCanvas.width, mbCanvas.height));
        if (mbAnimationId) cancelAnimationFrame(mbAnimationId);
        function waitLoop() {
            if (myMsgModal.style.display === 'none' || mbDancers.length > 0 || currentViewMode !== 'scene') return;
            mbCtx.fillStyle = '#0f172a'; mbCtx.fillRect(0,0, mbCanvas.width, mbCanvas.height);
            mbSnowflakes.forEach(s => { s.update(mbCanvas.width, mbCanvas.height); s.draw(mbCtx); });
            mbAnimationId = requestAnimationFrame(waitLoop);
        }
        waitLoop();
    };
    window.addEventListener('resize', () => { if (myMsgModal.style.display === 'flex') { resizeMailboxCanvas(); } }); 
</script>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const isMobile = window.innerWidth <= 768;

    if (isMobile) {
        const toast = document.getElementById('pc-toast');
        toast.style.display = 'block'; setTimeout(() => { toast.style.display = 'none'; }, 2500);
    }

    const CONFIG = { 
        text: 'dotmill', font: '900 120px "Pretendard", Arial', pixelSize: 5, 
        builderCount: 15, engineerCount: 3, officeCount: 50, 
        colors: ['#0ea5e9', '#334155', '#475569', '#1e293b'], 
        dropInterval: 300, beltSpeed: 2 
    };

    let particles=[], fairies=[], beltOffset=0, lastDropTime=0, mouseX=0, mouseY=0, hoveredFairy=null;
    let monitorHueOffset = 0, isLogoComplete = false;
    let zones={ hopper:{x:0,y:0}, beltStart:{x:0,y:0}, beltEnd:{x:0,y:0}, storage:{x:0,y:0}, office:{x:0,y:0,w:0,h:0} };

    let vacationCounter = 0;
    let isSantaMode = false;
    let santaTimer = null;

    function triggerSantaMode() {
        isSantaMode = true;
        if(santaTimer) clearTimeout(santaTimer);
        santaTimer = setTimeout(() => {
            isSantaMode = false;
        }, 7000); // 30ì´ˆ -> 7ì´ˆ
    }

    class Particle {
        constructor(tx,ty,c){this.targetX=tx;this.targetY=ty;this.baseColor=c;this.x=zones.hopper.x+(Math.random()-0.5)*40;this.y=zones.hopper.y-20;this.state='WAITING';this.carrier=null;}
        update(){if(this.state==='WAITING')return;if(this.state==='FALLING'){this.y+=4;if(this.y>=zones.beltStart.y-10){this.y=zones.beltStart.y-10+Math.random()*5;this.state='ON_BELT';}}else if(this.state==='ON_BELT'){const dx=zones.beltEnd.x-zones.beltStart.x,dy=zones.beltEnd.y-zones.beltStart.y,d=Math.sqrt(dx*dx+dy*dy);this.x+=(dx/d)*CONFIG.beltSpeed;this.y+=(dy/d)*CONFIG.beltSpeed;if(this.x>=zones.beltEnd.x){this.state='IN_STORAGE';this.x=zones.storage.x+(Math.random()-0.5)*30;this.y=zones.storage.y+(Math.random()-0.5)*20;}}else if(this.state==='RETURNING'){const dx=zones.hopper.x-this.x,dy=zones.hopper.y-this.y;this.x+=dx*0.1;this.y+=dy*0.1;if(Math.abs(dy)<5)this.state='WAITING';}}
        draw(){if(this.state==='WAITING')return;ctx.fillStyle=this.baseColor;if(this.state==='PLACED')ctx.fillRect(this.x,this.y,CONFIG.pixelSize,CONFIG.pixelSize);else{ctx.beginPath();ctx.arc(this.x,this.y,CONFIG.pixelSize/2+1,0,Math.PI*2);ctx.fill();}}
        reset(){this.state='RETURNING';this.carrier=null;}
    }

    class Fairy {
        constructor(role, idx) {
            this.role = role; this.x = canvas.width/2; this.y = canvas.height/2; this.targetItem = null; this.state = 'IDLE';
            this.colorShirt = ['#a3d2ca', '#ffc3a0', '#fff'][Math.floor(Math.random()*3)]; this.animFrame = Math.random()*100;
            this.isPaused=false; this.pauseTimer=null; this.busyState='NONE'; this.busyTimer=Math.random()*500;
            this.busyTargetX=0; this.busyTargetY=0; this.seatX=0; this.seatY=0;
            this.assignedMessage = null; this.assignmentTime = 0; 
            this.customStyle = null; 

            if(role==='ENGINEER'){this.x=zones.beltStart.x+(zones.beltEnd.x-zones.beltStart.x)*0.5;this.y=zones.beltStart.y+30;}
            else if(role==='OFFICE'){ const c=Math.ceil(CONFIG.officeCount/2),r=Math.floor(idx/c),cl=idx%c,dw=60,dh=60,tw=c*dw,sx=(canvas.width-tw)/2+30,sy=zones.office.y+50; this.seatX=sx+cl*dw;this.seatY=sy+r*dh;this.x=this.seatX;this.y=this.seatY;this.busyState='TYPING';} 
            else if(role==='FOREMAN'){ 
                this.x = canvas.width/2 - 250; 
                this.y = canvas.height/2 - 20; 
            }
        }
        giveVacation() { 
            this.isPaused=true; playSound('rest'); 
            if(this.pauseTimer)clearTimeout(this.pauseTimer); 
            this.pauseTimer=setTimeout(()=>{this.isPaused=false;},5000); 
            
            vacationCounter++;
            if(vacationCounter >= 5) {
                triggerSantaMode();
                vacationCounter = 0;
            }
        }
        update() { if(this.isPaused)return; this.animFrame+=0.1; if(this.role==='BUILDER')this.updateBuilder(); else if(this.role==='OFFICE')this.updateOffice(); }
        updateOffice(){if(this.busyState==='TYPING'){this.busyTimer--;if(this.busyTimer<=0){if(Math.random()<0.05){this.busyState='PATROL';this.busyTargetX=zones.office.x+Math.random()*zones.office.w;this.busyTargetY=zones.office.y+Math.random()*zones.office.h;}else{this.busyTimer=200+Math.random()*400;}}}else if(this.busyState==='PATROL'){if(this.moveTo(this.busyTargetX,this.busyTargetY)){this.busyState='WAITING_TO_RETURN';this.busyTimer=50+Math.random()*100;}}else if(this.busyState==='WAITING_TO_RETURN'){this.busyTimer--;if(this.busyTimer<=0)this.busyState='RETURN';}else if(this.busyState==='RETURN'){if(this.moveTo(this.seatX,this.seatY)){this.busyState='TYPING';this.busyTimer=300+Math.random()*500;}}}
        updateBuilder(){
            if(!this.targetItem){
                const job=particles.find(p=>p.state==='IN_STORAGE'&&!p.carrier);
                if(job){ this.busyState='NONE';this.targetItem=job;job.carrier=this;this.state='MOVING_TO_STORAGE'; } else { this.performBusyAction(); }
            } else {
                if(this.targetItem.state==='RETURNING'){this.targetItem=null;this.state='IDLE';return;}
                if(this.state==='MOVING_TO_STORAGE'){if(this.moveTo(this.targetItem.x,this.targetItem.y)){this.targetItem.state='CARRIED';this.state='DELIVERING';}}
                else if(this.state==='DELIVERING'){this.targetItem.x=this.x;this.targetItem.y=this.y-12;if(this.moveTo(this.targetItem.targetX,this.targetItem.targetY)){this.targetItem.state='PLACED';this.targetItem.x=this.targetItem.targetX;this.targetItem.y=this.targetItem.targetY;this.targetItem.carrier=null;this.targetItem=null;this.state='IDLE';}}
            }
        }
        performBusyAction(){
            if(this.busyTimer<=0){
                const r=Math.random();
                if(r<0.5){this.busyState='PATROL';this.busyTargetX=canvas.width/2+(Math.random()-0.5)*400;this.busyTargetY=canvas.height/2+(Math.random()-0.5)*150;}
                else if(r<0.8)this.busyState='CLEAN'; else this.busyState='HAMMER';
                this.busyTimer=60+Math.random()*120;
            }
            this.busyTimer--;
            if(this.busyState==='PATROL')this.moveTo(this.busyTargetX,this.busyTargetY);
            else if(this.busyState==='CLEAN')this.x+=Math.sin(Date.now()*0.02)*0.5;
            else if(this.busyState==='HAMMER'){if(Math.abs(this.x-canvas.width/2)>300)this.moveTo(canvas.width/2,canvas.height/2);}
        }
        moveTo(tx,ty){const dx=tx-this.x,dy=ty-this.y,d=Math.sqrt(dx*dx+dy*dy);if(d<4){this.x=tx;this.y=ty;return true;}const s=this.role==='OFFICE'?1.5:4;this.x+=(dx/d)*s;this.y+=(dy/d)*s;return false;}

        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            
            let shirtColor = this.colorShirt;
            if (this.customStyle) {
                shirtColor = CUSTOM_SHIRT_COLORS[this.customStyle.shirt] || CUSTOM_SHIRT_COLORS[0];
            }

            let indicatorColor = null;
            if (this.isPaused) { ctx.shadowColor = '#ffd700'; ctx.shadowBlur = 20; } 
            else if (this.assignedMessage) {
                const timeDiff = Date.now() - this.assignmentTime;
                if (timeDiff < 2000) { ctx.shadowColor = '#00e676'; ctx.shadowBlur = 25; indicatorColor = '#00e676'; } 
                else { indicatorColor = '#2979ff'; ctx.shadowBlur = 0; }
            } else { ctx.shadowBlur = 0; }
            
            if(!this.isPaused && (this.busyState==='HAMMER'||(this.role==='OFFICE'&&this.busyState==='TYPING'))) ctx.translate(0,Math.sin(Date.now()*0.05));
            if (indicatorColor) { ctx.fillStyle = indicatorColor; ctx.beginPath(); ctx.arc(0, -18, 3.5, 0, Math.PI*2); ctx.fill(); }
            
            const w=12,h=20; 
            ctx.fillStyle='#333';ctx.fillRect(-w/2,0,w,h/2); // Pants
            ctx.fillStyle=shirtColor;ctx.fillRect(-w/2,-h/2,w,h/2); // Shirt
            ctx.fillStyle='#fce4d4';ctx.fillRect(-w/2+2,-h/2-6,8,8); // Face

            if (this.customStyle) {
                ctx.save();
                ctx.translate(0, 8); // [FIX] Align head parts to Fairy's lower face position

                ctx.fillStyle = '#4a3b2a';
                const hr = this.customStyle.hair;
                if (hr === 0) { // ê¸°ë³¸
                    ctx.fillRect(-7, -26, 14, 4); 
                    ctx.beginPath(); ctx.moveTo(-7, -24); ctx.lineTo(7, -24); ctx.quadraticCurveTo(8, -24, 8, -20); ctx.lineTo(-8, -20); ctx.quadraticCurveTo(-8, -24, -7, -24); ctx.fill();
                } else if (hr === 1) { // ë”ë²…(íŒŒë§ˆ)
                    ctx.beginPath(); 
                    ctx.arc(0, -25, 8, Math.PI, 0); 
                    ctx.arc(-6, -23, 4, 0, Math.PI*2);
                    ctx.arc(6, -23, 4, 0, Math.PI*2);
                    ctx.arc(0, -28, 4, 0, Math.PI*2);
                    ctx.fill();
                } else if (hr === 2) { // ê½ì§€
                    ctx.fillRect(-7, -26, 14, 4); 
                    ctx.beginPath(); ctx.arc(0, -28, 3.5, 0, Math.PI*2); ctx.fill();
                    ctx.beginPath(); ctx.moveTo(0, -28); ctx.quadraticCurveTo(5, -32, 6, -26); ctx.stroke();
                } else { // ê¸´ë¨¸ë¦¬
                    ctx.fillRect(-8, -26, 16, 6); 
                    ctx.fillRect(-9, -22, 4, 12); ctx.fillRect(5, -22, 4, 12); 
                }

                const ac = this.customStyle.acc;
                if (ac === 1) { // ë£¨ëŒí”„
                    ctx.strokeStyle = '#8B4513'; ctx.lineWidth = 2; ctx.lineCap = 'round';
                    ctx.beginPath(); ctx.moveTo(-3, -25); ctx.lineTo(-8, -32); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(-6, -29); ctx.lineTo(-4, -33); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(3, -25); ctx.lineTo(8, -32); ctx.stroke();
                    ctx.beginPath(); ctx.moveTo(6, -29); ctx.lineTo(4, -33); ctx.stroke();
                    ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(0, -18, 1.5, 0, Math.PI*2); ctx.fill();
                } else if (ac === 2) { // í•œë³µ ë°°ì -> ê½ƒ
                    ctx.fillStyle = '#ff69b4'; // Pink petals
                    for(let i=0; i<5; i++) {
                        const angle = (i * 2 * Math.PI) / 5;
                        const r = 3;
                        ctx.beginPath();
                        ctx.arc(6 + Math.cos(angle)*r, -28 + Math.sin(angle)*r, 2, 0, Math.PI*2);
                        ctx.fill();
                    }
                    ctx.fillStyle = '#fff'; // Center
                    ctx.beginPath(); ctx.arc(6, -28, 2, 0, Math.PI*2); ctx.fill();
                }
                ctx.restore();
            }

            if (isSantaMode) {
                ctx.fillStyle = '#ef4444'; 
                ctx.beginPath(); ctx.moveTo(-6, -16); ctx.lineTo(0, -26); ctx.lineTo(6, -16); ctx.fill();
                ctx.fillStyle = '#fff'; 
                ctx.fillRect(-7, -16, 14, 3);
                ctx.beginPath(); ctx.arc(0, -26, 2, 0, Math.PI*2); ctx.fill();
            }

            if(this.role==='FOREMAN'){ctx.fillStyle='#ffcc00';ctx.fillRect(-w/2,-h/2-8,w,4);ctx.strokeStyle='red';ctx.beginPath();ctx.moveTo(w/2,-h/2);ctx.lineTo(w/2+10,-h/2-5);ctx.stroke();}
            else if(this.role==='ENGINEER'){ctx.save();ctx.translate(w/2,0);ctx.rotate(Math.sin(this.animFrame)*0.5);ctx.fillStyle='#888';ctx.fillRect(0,-2,10,4);ctx.restore();}
            else if(this.role==='OFFICE'){ctx.fillStyle='#333';ctx.fillRect(-w/2+3,-h/2-3,6,2);}
            else if(this.role==='BUILDER'&&this.state==='DELIVERING'){ctx.fillStyle='#fce4d4';ctx.fillRect(-w/2-2,-h/2,2,6);ctx.fillRect(w/2,-h/2,2,6);}
            
            if (this.role === 'BUILDER' && !this.isPaused) {
                if (this.busyState === 'CLEAN') {
                    ctx.save(); ctx.strokeStyle = '#8d6e63'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(4, 5); ctx.lineTo(4 + Math.sin(Date.now()*0.02)*8, 18); ctx.stroke();
                    ctx.fillStyle='#d7ccc8'; ctx.beginPath(); ctx.arc(4 + Math.sin(Date.now()*0.02)*8, 18, 3, 0, Math.PI); ctx.fill(); ctx.restore();
                } else if (this.busyState === 'HAMMER') {
                    ctx.save(); ctx.translate(6, 0); ctx.rotate(Math.sin(Date.now() * 0.2) * 0.8);
                    ctx.fillStyle = '#5d4037'; ctx.fillRect(0, -10, 2, 12); ctx.fillStyle = '#555'; ctx.fillRect(-3, -12, 8, 4); ctx.restore();
                }
            }
            ctx.restore();
        }
        drawBubble() {
            if (!this.assignedMessage) return;
            const msg = this.assignedMessage;
            ctx.save(); ctx.translate(this.x, this.y - 35);
            ctx.font = 'bold 14px "Pretendard", sans-serif'; const tm = ctx.measureText(msg.text), nm = ctx.measureText(msg.name);
            const w = Math.max(tm.width, nm.width) + 24, h = 48;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)'; ctx.shadowColor = 'rgba(0,0,0,0.2)'; ctx.shadowBlur = 10;
            ctx.beginPath(); ctx.roundRect(-w/2, -h, w, h, 12); ctx.fill();
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(-6, -6); ctx.lineTo(6, -6); ctx.fill();
            ctx.shadowBlur = 0; ctx.fillStyle = '#334155'; ctx.textAlign = 'center'; ctx.fillText(msg.text, 0, -26);
            ctx.font = '500 12px "Pretendard"'; ctx.fillStyle = '#64748b'; 
            let displayName = msg.name;
            if (displayName === 'ALL') {
                ctx.fillStyle = '#00e676';
                displayName = 'ëª¨ë‘ì—ê²Œ';
            } else {
                ctx.fillStyle = '#ec4899';
            }
            ctx.fillText(`To. ${displayName}`, 0, -10);
            ctx.restore();
        }
    }

    function init() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        if (canvas.width === 0 || canvas.height === 0) return;
        zones.hopper = { x: 100, y: 100 }; zones.beltStart = { x: 100, y: 180 }; zones.beltEnd = { x: canvas.width * 0.3, y: canvas.height * 0.6 }; zones.storage = { x: canvas.width * 0.3 + 20, y: canvas.height * 0.6 + 20 }; zones.office = { x: 0, y: canvas.height - 200, w: canvas.width, h: 200 };
        particles=[]; fairies=[];
        ctx.font = CONFIG.font; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = 'white'; ctx.fillText(CONFIG.text, canvas.width / 2, canvas.height / 2);
        const data = ctx.getImageData(0, 0, canvas.width, canvas.height); ctx.clearRect(0,0, canvas.width, canvas.height);
        for(let y=0; y<data.height; y+=CONFIG.pixelSize) for(let x=0; x<data.width; x+=CONFIG.pixelSize) if(data.data[(y * 4 * data.width) + (x * 4) + 3] > 128) particles.push(new Particle(x, y, CONFIG.colors[Math.floor(Math.random() * CONFIG.colors.length)]));
        fairies.push(new Fairy('FOREMAN'));
        for(let i=0; i<CONFIG.builderCount; i++) fairies.push(new Fairy('BUILDER'));
        for(let i=0; i<CONFIG.engineerCount; i++) fairies.push(new Fairy('ENGINEER'));
        for(let i=0; i<CONFIG.officeCount; i++) fairies.push(new Fairy('OFFICE', i));
    }

    function isVisible(f) { return f.x > 20 && f.x < canvas.width - 20 && f.y > 0 && f.y < canvas.height; }

    window.distributeSingleMessage = (newMsg) => {
        let target = fairies.find(f => f.assignedMessage === null && isVisible(f));
        if (!target) {
            const visibleFairies = fairies.filter(f => isVisible(f));
            if (visibleFairies.length > 0) { target = visibleFairies[Math.floor(Math.random() * visibleFairies.length)]; } 
            else { target = fairies[Math.floor(Math.random() * fairies.length)]; }
        }
        if (target) { 
            target.assignedMessage = newMsg; 
            target.assignmentTime = Date.now();
            if(newMsg.style) target.customStyle = newMsg.style;
        }
    };

    function drawEnvironment() {
        ctx.fillStyle = '#999'; ctx.beginPath(); ctx.moveTo(zones.hopper.x - 30, zones.hopper.y - 50); ctx.lineTo(zones.hopper.x + 30, zones.hopper.y - 50); ctx.lineTo(zones.hopper.x + 10, zones.hopper.y); ctx.lineTo(zones.hopper.x - 10, zones.hopper.y); ctx.fill();
        ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 40; ctx.lineCap = 'round'; ctx.beginPath(); ctx.moveTo(zones.beltStart.x, zones.beltStart.y); ctx.lineTo(zones.beltEnd.x, zones.beltEnd.y); ctx.stroke();
        beltOffset -= CONFIG.beltSpeed; ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 30; ctx.setLineDash([10, 20]); ctx.lineDashOffset = beltOffset; ctx.beginPath(); ctx.moveTo(zones.beltStart.x, zones.beltStart.y); ctx.lineTo(zones.beltEnd.x, zones.beltEnd.y); ctx.stroke(); ctx.setLineDash([]);
        ctx.lineWidth = 5; ctx.strokeStyle = '#64748b'; ctx.beginPath(); ctx.moveTo(zones.beltEnd.x, zones.beltEnd.y); ctx.lineTo(zones.beltEnd.x, canvas.height); ctx.moveTo(zones.beltStart.x, zones.beltStart.y); ctx.lineTo(zones.beltStart.x, canvas.height); ctx.stroke();
        const lx = canvas.width/2 - 250; const ly = canvas.height/2 + 60; ctx.strokeStyle = '#8d6e63'; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(lx, ly); ctx.lineTo(lx, ly - 120); ctx.moveTo(lx + 30, ly); ctx.lineTo(lx + 30, ly - 120); for(let i=0; i<5; i++) { ctx.moveTo(lx, ly - 20 - (i*20)); ctx.lineTo(lx+30, ly - 20 - (i*20)); } ctx.stroke();
        ctx.fillStyle = '#f8fafc'; ctx.fillRect(zones.office.x, zones.office.y, zones.office.w, zones.office.h); ctx.fillStyle = '#e2e8f0'; ctx.fillRect(zones.office.x, canvas.height - 50, zones.office.w, 50);
        fairies.forEach((f, i) => {
            if (f.role === 'OFFICE') {
                const deskX = f.seatX; const deskY = f.seatY;
                ctx.fillStyle = '#cbd5e1'; ctx.fillRect(deskX - 25, deskY + 10, 50, 30); ctx.fillStyle = '#475569'; ctx.fillRect(deskX - 15, deskY - 20, 30, 25); 
                
                const hue = (monitorHueOffset + i * 10) % 360;
                const saturation = isLogoComplete ? '100%' : '70%';
                const lightness = isLogoComplete ? '60%' : '80%';
                ctx.fillStyle = `hsl(${hue}, ${saturation}, ${lightness})`;
                if(isLogoComplete) { ctx.shadowColor = `hsl(${hue}, 100%, 50%)`; ctx.shadowBlur = 15; }
                ctx.fillRect(deskX - 13, deskY - 18, 26, 20); ctx.shadowBlur = 0;
            }
        });
        ctx.fillStyle = '#94a3b8'; ctx.font = 'bold 15px "Pretendard", sans-serif'; ctx.textAlign='right'; ctx.fillText('Â©shimhayeon', canvas.width - 50, canvas.height - 30);
    }
    
    function animate() {
        const now = Date.now(); if (now - lastDropTime > CONFIG.dropInterval) { const p = particles.find(p => p.state === 'WAITING'); if (p) { p.state = 'FALLING'; lastDropTime = now; } }
        ctx.clearRect(0, 0, canvas.width, canvas.height); drawEnvironment(); fairies.forEach(f => { f.update(); f.draw(); }); particles.forEach(p => { p.update(); p.draw(); });
        if (hoveredFairy) { hoveredFairy.drawBubble(); canvas.style.cursor = 'pointer'; } else { canvas.style.cursor = 'default'; }
        
        const placedCount = particles.filter(p => p.state === 'PLACED').length;
        isLogoComplete = (placedCount === particles.length && particles.length > 0);
        monitorHueOffset += isLogoComplete ? 5 : 1; 

        ctx.save(); 
        if (isLogoComplete) {
             const hue = (monitorHueOffset * 2) % 360;
             ctx.globalAlpha = 0.8; ctx.fillStyle = `hsl(${hue}, 100%, 60%)`; ctx.shadowColor = `hsl(${hue}, 100%, 50%)`; ctx.shadowBlur = 30;
        } else { ctx.globalAlpha = 0.05; ctx.fillStyle = '#000'; }
        ctx.font = CONFIG.font; ctx.textAlign='center'; ctx.fillText(CONFIG.text, canvas.width/2, canvas.height/2); ctx.restore();

        requestAnimationFrame(animate);
    }
    
    async function loadInitialMessages() {
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL);
            const data = await response.json(); 
            if (data && data.length > 0) {
                const recent10 = data.slice(0, 10);
                const shuffledFairies = [...fairies].sort(() => 0.5 - Math.random());
                recent10.forEach((row, idx) => {
                    if (idx < shuffledFairies.length) {
                        const f = shuffledFairies[idx];
                        f.assignedMessage = { name: row[1], text: row[2] };
                        f.assignmentTime = Date.now(); 
                        let styleJson = row[3];
                        if (styleJson) {
                            try { f.customStyle = JSON.parse(styleJson); } catch(e) {}
                        }
                    }
                });
            }
        } catch (e) { console.error("Initial fetch failed:", e); }
    }

    canvas.addEventListener('touchstart', (e) => {
        if (e.target.closest('#input-bar') || e.target.closest('#modal-overlay') || e.target.closest('#audio-btn') || e.target.closest('.modal-window')) return;
        const touch = e.touches[0]; const rect = canvas.getBoundingClientRect(); const tx = touch.clientX - rect.left; const ty = touch.clientY - rect.top;
        
        let touchedFairy = false;
        fairies.forEach(f => {
            if (Math.abs(tx - f.x) < 40 && Math.abs(ty - f.y) < 50) {
                touchedFairy = true;
                if (f.assignedMessage) {
                    hoveredFairy = f; playSound('pop'); setTimeout(() => { hoveredFairy = null; }, 3000);
                } else { f.giveVacation(); }
            }
        });
        if (!touchedFairy) {
            const cx = canvas.width / 2; const cy = canvas.height / 2;
            if (tx > cx - 200 && tx < cx + 200 && ty > cy - 80 && ty < cy + 80) {
                particles.forEach(p => { if (p.state === 'PLACED') p.reset(); });
                fairies.forEach(f => { if(!f.isPaused) { if(f.targetItem) { f.targetItem.reset(); f.targetItem = null; } f.state = 'IDLE'; } });
                playSound('reset');
            }
        }
    }, { passive: false });

    window.addEventListener('mousedown', (e) => {
        if (e.target.closest('#input-bar') || e.target.closest('#modal-overlay') || e.target.closest('.modal-window') || e.target.closest('#view-all-btn') || e.target.closest('#audio-btn')) return;
        const rect = canvas.getBoundingClientRect(); const cx = e.clientX - rect.left; const cy = e.clientY - rect.top;
        
        let clickedFairy = false; fairies.forEach(f => { if (Math.sqrt(Math.pow(cx-f.x,2)+Math.pow(cy-f.y,2)) < 30) { f.giveVacation(); clickedFairy = true; } }); if (clickedFairy) return;
        if (cx > canvas.width/2 - 250 && cx < canvas.width/2 + 250 && cy > canvas.height/2 - 80 && cy < canvas.height/2 + 80) { 
            particles.forEach(p => { if (p.state === 'PLACED') p.reset(); }); 
            fairies.forEach(f => { if(!f.isPaused) { if(f.targetItem) { f.targetItem.reset(); f.targetItem = null; } f.state = 'IDLE'; } }); 
            playSound('reset');
        }
    });

    let prevHoveredFairy = null; 
    window.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect(); mouseX = e.clientX - rect.left; mouseY = e.clientY - rect.top;
        
        let closest = null; let minDist = 30; 
        fairies.forEach(f => { const dx = mouseX - f.x; const dy = mouseY - f.y; const dist = Math.sqrt(dx*dx + dy*dy); if (dist < minDist) { minDist = dist; closest = f; } }); 
        hoveredFairy = closest;
        
        if (hoveredFairy) {
            canvas.style.cursor = 'pointer';
        } else {
            canvas.style.cursor = 'default';
        }

        if (closest !== prevHoveredFairy) {
            if (closest && closest.assignedMessage) { playSound('pop'); }
            prevHoveredFairy = closest;
        }
    });
    
    window.addEventListener('resize', init); 
    init(); 
    loadInitialMessages(); 
    animate();
</script>
</body>
</html>
