<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DOTMILL Guestbook</title>
    
    <!-- Pretendard Web Font ì¶”ê°€ -->
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />

    <style>
        /* í°íŠ¸ ì ìš©: Pretendardë¥¼ ìµœìš°ì„ ìœ¼ë¡œ ì„¤ì • */
        body { 
            margin: 0; 
            overflow: hidden; 
            background-color: #ffffff; 
            font-family: 'Pretendard', 'Apple SD Gothic Neo', 'Malgun Gothic', sans-serif; 
            user-select: none; 
            -webkit-user-select: none; 
        }
        canvas { display: block; }
        
        /* [PC ê¸°ë³¸ UI] */
        #ui { position: absolute; top: 30px; left: 30px; pointer-events: none; color: #333; z-index: 10; transition: all 0.3s; }
        h1 { margin: 0 0 5px 0; font-size: 1.8rem; color: #2c3e50; font-weight: 800; letter-spacing: -0.02em; } 
        
        /* ìš°í¸í•¨ ì•„ì´ì½˜ (ë…ë¦½ ë°°ì¹˜) */
        #mailbox-icon {
            position: absolute;
            right: 30px;
            bottom: 210px; /* ì‚¬ë¬´ì‹¤ ë†’ì´(200px) ë°”ë¡œ ìœ„ */
            width: 40px; height: 50px;
            background: #ef4444; 
            border: 4px solid #7f1d1d; 
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            z-index: 25; 
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        #mailbox-icon:active { transform: scale(0.95); }
        #mailbox-icon::after {
            content: ''; position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
            width: 20px; height: 6px; background: #7f1d1d; border-radius: 2px;
        }
        #mailbox-icon::before {
            content: ''; position: absolute; bottom: -20px; left: 50%; transform: translateX(-50%);
            width: 8px; height: 20px; background: #333; z-index: -1;
        }
        #mailbox-text {
            position: absolute; top: -25px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); color: white; padding: 4px 8px; border-radius: 4px;
            font-size: 11px; white-space: nowrap; pointer-events: none; opacity: 0; transition: opacity 0.2s;
        }
        #mailbox-icon:hover #mailbox-text { opacity: 1; }

        /* [ìˆ˜ì •] ë²”ë¡€ í°íŠ¸ ì‚¬ì´ì¦ˆ ì¶•ì†Œ (0.9rem -> 0.8rem) */
        .desc { font-size: 0.8rem; color: #555; background: rgba(255,255,255,0.8); padding: 12px 18px; border-radius: 12px; backdrop-filter: blur(5px); box-shadow: 0 2px 10px rgba(0,0,0,0.05); line-height: 1.6; letter-spacing: -0.01em; margin-top: 5px; }
        
        /* [ì‹ ê·œ] ë°©ì•—ê°„ ì•ˆë‚´ ë©˜íŠ¸ ìŠ¤íƒ€ì¼ */
        .sub-desc {
            margin-top: 8px;
            font-size: 0.85rem;
            color: #475569;
            background: rgba(255, 255, 255, 0.9);
            padding: 12px 18px;
            border-radius: 12px;
            backdrop-filter: blur(5px);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            line-height: 1.5;
            font-weight: 500;
        }

        .green-txt { color: #00e676; font-weight: 700; text-shadow: 0 0 1px rgba(0,0,0,0.1); }
        .blue-txt { color: #2979ff; font-weight: 700; }
        .yellow-txt { color: #ef4444; font-weight: 700; } 
        .gray-txt { color: #555; font-weight: 700; }

        /* ìš°ì¸¡ ìƒë‹¨ ì•ˆë‚´ ë©˜íŠ¸ */
        #guide-text {
            position: absolute; top: 30px; right: 30px; 
            text-align: right; color: #444; pointer-events: none; z-index: 10;
            background: rgba(255,255,255,0.85); padding: 15px 20px; 
            border-radius: 12px; backdrop-filter: blur(5px); 
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            letter-spacing: -0.01em;
        }
        #guide-text h2 { margin: 0 0 8px 0; font-size: 1.1rem; color: #2c3e50; font-weight: 700; }
        #guide-text p { margin: 0; font-size: 0.9rem; line-height: 1.5; color: #666; font-weight: 400; }

        /* ì „ì²´ë³´ê¸° ë²„íŠ¼ */
        #view-all-btn {
            position: absolute; top: 140px; right: 30px; 
            background: #2c3e50; color: white; border: none;
            padding: 10px 20px; border-radius: 25px; cursor: pointer;
            font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s, background 0.2s; z-index: 20; pointer-events: auto;
            font-family: 'Pretendard', sans-serif; 
        }
        #view-all-btn:hover { background: #0056b3; transform: scale(1.05); }

        /* BGM ë²„íŠ¼ */
        #audio-btn {
            position: fixed; bottom: 30px; right: 30px; 
            width: 60px; height: 60px; 
            background-color: #2c3e50; color: white; border: 3px solid white; border-radius: 50%;
            cursor: pointer; z-index: 1000; pointer-events: auto;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.8rem; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        #audio-btn:active { transform: scale(0.9); }

        /* ì»¤ìŠ¤í…€ ì•Œë¦¼ì°½ */
        #custom-alert {
            display: none; position: fixed; top: 20%; left: 50%; transform: translate(-50%, -50%);
            background: white; padding: 25px 40px; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15); z-index: 200;
            text-align: center; border: 1px solid #eee;
            animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 80%; max-width: 320px;
        }
        #custom-alert h3 { margin: 0 0 10px 0; color: #2c3e50; font-weight: 700; font-size: 1.3rem; }
        #custom-alert p { margin: 0; color: #666; font-size: 1rem; }
        #alert-check { font-size: 2rem; display: block; margin-bottom: 15px; }

        /* PC ì ‘ì† ê¶Œì¥ í† ìŠ¤íŠ¸ */
        #pc-toast {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(30, 41, 59, 0.9); color: white; padding: 12px 24px; border-radius: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 300;
            text-align: center; font-size: 0.9rem; pointer-events: none;
            animation: fadeInOut 2.5s ease forwards; width: 70%; line-height: 1.4; font-weight: 500;
        }

        /* ëª¨ë‹¬ ì°½ ê¸°ë³¸ ìŠ¤íƒ€ì¼ (PC ê¸°ì¤€) */
        .modal-window {
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 800px; height: 600px; /* ê¸°ë³¸ì€ ë„“ê²Œ */
            background: white; border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.2); z-index: 100;
            flex-direction: column; overflow: hidden; border: 1px solid #f1f1f1;
            animation: fadeIn 0.3s ease; max-width: 90%; max-height: 90%;
        }
        /* ëª©ë¡ ëª¨ë‹¬ì€ ì¡°ê¸ˆ ì‘ê²Œ ìœ ì§€ */
        #list-modal { width: 400px; height: 600px; }

        .modal-header { padding: 20px 25px; background: #fff; border-bottom: 1px solid #f1f1f1; font-weight: 700; font-size: 1.1rem; display: flex; justify-content: space-between; align-items: center; color: #1e293b; z-index: 10; position: relative;}
        
        /* ë³´ê¸° ëª¨ë“œ í† ê¸€ ìŠ¤ìœ„ì¹˜ */
        .view-toggle { display: flex; background: #f1f5f9; border-radius: 20px; padding: 4px; gap: 4px; font-size: 0.85rem; font-weight: 600; margin-left: auto; margin-right: 15px; }
        .view-toggle label { cursor: pointer; padding: 6px 12px; border-radius: 16px; color: #64748b; transition: all 0.2s; display: flex; align-items: center; gap: 4px; }
        .view-toggle label:hover { color: #334155; }
        .view-toggle input[type="radio"] { display: none; }
        .view-toggle input[type="radio"]:checked + span { color: #0f172a; }
        .view-toggle label.active { background: white; color: #0ea5e9; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .close-modal-btn { cursor: pointer; font-size: 1.5rem; color: #94a3b8; transition: color 0.2s; margin-left: 0; }
        .close-modal-btn:hover { color: #475569; }
        
        .msg-list-container { flex: 1; overflow-y: auto; padding: 0; background: #f8fafc; }
        
        .list-item { padding: 20px 25px; border-bottom: 1px solid #f1f5f9; background: white; transition: background 0.2s; }
        .list-item:hover { background: #f8fafc; }
        .list-item:last-child { border-bottom: none; }
        .list-date { font-size: 0.8rem; color: #94a3b8; margin-bottom: 6px; font-weight: 500; }
        .list-receiver { font-weight: 700; color: #0ea5e9; margin-right: 6px; font-size: 0.95rem; }
        .list-text { color: #334155; font-size: 1rem; word-break: break-all; line-height: 1.5; font-weight: 400; }
        .empty-msg { text-align: center; padding: 40px; color: #94a3b8; font-size: 0.95rem; }
        
        #my-msg-auth { padding: 20px; background: #fff; border-bottom: 1px solid #e2e8f0; display: flex; gap: 10px; z-index: 10; position: relative; }
        #my-name-input { flex: 1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 8px; outline: none; font-family: 'Pretendard'; }
        #my-msg-btn { background: #0ea5e9; color: white; border: none; padding: 0 15px; border-radius: 8px; cursor: pointer; font-weight: 600; font-family: 'Pretendard'; }
        #my-msg-btn:hover { background: #0284c7; }

        /* ë‚´ ìš°í¸í•¨ ì½˜í…ì¸  ì˜ì—­ (ë¦¬ìŠ¤íŠ¸/ìº”ë²„ìŠ¤ ìŠ¤ìœ„ì¹­ìš©) */
        #mailbox-content-area { flex: 1; position: relative; display: flex; flex-direction: column; overflow: hidden; }

        /* ë‚´ ìš°í¸í•¨ ìº”ë²„ìŠ¤ ì»¨í…Œì´ë„ˆ */
        #mailbox-canvas-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #0f172a; /* ë”¥ ë„¤ì´ë¹„ ë°°ê²½ */
            overflow: hidden;
            display: none; /* ì´ˆê¸° ìƒíƒœ */
        }
        #mailbox-bg-canvas { width: 100%; height: 100%; }
        #mailbox-placeholder {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #94a3b8; text-align: center; width: 100%; pointer-events: none; line-height: 1.6;
        }
        
        /* ë‚´ ìš°í¸í•¨ ë¦¬ìŠ¤íŠ¸ ì»¨í…Œì´ë„ˆ */
        #my-msg-list-container {
            flex: 1; overflow-y: auto; background: #f8fafc;
            display: none; /* ì´ˆê¸° ìƒíƒœ */
        }

        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); z-index: 90; backdrop-filter: blur(4px); }

        /* ì…ë ¥ë°” ìŠ¤íƒ€ì¼ */
        #input-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 550px; background: rgba(255, 255, 255, 0.95); padding: 10px 14px; border-radius: 50px; box-shadow: 0 10px 40px rgba(0,0,0,0.12); display: flex; align-items: center; gap: 8px; z-index: 30; border: 1px solid #e2e8f0; backdrop-filter: blur(10px); }
        
        .to-all-wrapper { display: flex; align-items: center; white-space: nowrap; font-size: 14px; font-weight: 600; color: #475569; margin-right: 2px; cursor: pointer; user-select: none; }
        .to-all-wrapper input { margin-right: 4px; accent-color: #0ea5e9; width: 16px; height: 16px; cursor: pointer; }

        #receiver-input { width: 90px; padding: 12px; border: none; border-radius: 25px; background: #e0f2fe; text-align: center; outline: none; font-size: 15px; font-family: 'Pretendard', sans-serif; font-weight: 600; color: #0369a1; transition: all 0.2s; } 
        #receiver-input::placeholder { color: #7dd3fc; font-weight: 500; }
        #receiver-input:disabled { background: #f1f5f9; color: #94a3b8; cursor: not-allowed; }

        #msg-input { flex: 1; padding: 12px 16px; border: none; border-radius: 25px; background: #f1f5f9; outline: none; font-size: 16px; font-family: 'Pretendard', sans-serif; color: #334155; }
        #msg-input::placeholder { color: #94a3b8; }
        #send-btn { background: #0ea5e9; color: white; border: none; width: 42px; height: 42px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; transition: background 0.2s, transform 0.1s; box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3); flex-shrink: 0; }
        #send-btn:hover { background: #0284c7; transform: scale(1.05); }
        #send-btn:active { transform: scale(0.95); }
        #send-btn:disabled { background: #cbd5e1; cursor: not-allowed; box-shadow: none; }

        @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -45%); } to { opacity: 1; transform: translate(-50%, -50%); } }
        @keyframes popIn { from { opacity: 0; transform: translate(-50%, -40%) scale(0.9); } to { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        @keyframes fadeInOut { 0% { opacity: 0; transform: translate(-50%, -40%); } 10% { opacity: 1; transform: translate(-50%, -50%); } 90% { opacity: 1; transform: translate(-50%, -50%); } 100% { opacity: 0; transform: translate(-50%, -60%); } }

        /* [ëª¨ë°”ì¼ ì „ìš© ìŠ¤íƒ€ì¼] */
        @media (max-width: 768px) {
            #guide-text { display: block; top: 10px; left: 50%; right: auto; transform: translateX(-50%); width: 90%; text-align: center; padding: 10px 15px; background: rgba(255,255,255,0.95); border-radius: 16px; border: 1px solid #f1f5f9; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
            #guide-text h2 { font-size: 0.95rem; margin-bottom: 4px; }
            #guide-text p { font-size: 0.8rem; line-height: 1.4; color: #64748b; }
            #view-all-btn { top: auto; bottom: 90px; right: auto; left: 50%; transform: translateX(-50%); padding: 8px 16px; font-size: 0.8rem; background: #334155; width: auto; white-space: nowrap; border-radius: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.15); }
            #audio-btn { bottom: auto; top: 20px; right: 20px; width: 40px; height: 40px; font-size: 1.2rem; border-width: 2px; }
            #ui { top: 95px; left: 50%; transform: translateX(-50%); width: 92%; text-align: center; }
            #ui h1 { display: none; } 
            
            /* ëª¨ë°”ì¼ì—ì„œ ìš°í¸í•¨ ìœ„ì¹˜ ë° í¬ê¸° ì¡°ì • */
            #mailbox-icon { right: 20px; bottom: 210px; }

            /* [ìˆ˜ì •] ëª¨ë°”ì¼ í°íŠ¸ ì‚¬ì´ì¦ˆ ë” ì¶•ì†Œ */
            .desc { font-size: 0.7rem; padding: 8px 12px; line-height: 1.5; background: rgba(255,255,255,0.6); border-radius: 12px; display: inline-block; text-align: left; border: none; box-shadow: none; width: 100%; box-sizing: border-box; }
            .sub-desc { font-size: 0.75rem; padding: 8px 12px; }

            .desc span { display: block; margin-bottom: 2px; }
            #input-bar { bottom: 20px; width: 95%; padding: 8px; border-radius: 30px; gap: 6px; }
            .to-all-wrapper { font-size: 13px; margin-right: 0; }
            #receiver-input { width: 60px; font-size: 13px; padding: 10px 5px; }
            #msg-input { font-size: 14px; padding: 10px 12px; }
            #send-btn { width: 36px; height: 36px; font-size: 1rem; }

            /* [ëª¨ë°”ì¼] ëª¨ë‹¬ í¬ê¸° ë³µì› (ì„¸ë¡œí˜•) */
            .modal-window { width: 380px; height: 550px; }
            #list-modal { width: 380px; height: 550px; }
        }
    </style>
</head>
<body>

    <div id="ui">
        <h1>DOTMILL</h1>
        <div class="desc">
            <span class="green-txt">â— ë°©ê¸ˆ ë„ì°©í•œ ë©”ì‹œì§€ ì•Œë¦¼</span>
            <span class="blue-txt">â— íŒŒë€ ì˜·ì„ ì…ì€ ë™ë£Œë“¤ í™•ì¸</span>
            <span class="yellow-txt">â— ë¹¨ê°„ ìš°í¸í•¨ í´ë¦­: ë‚´ ìš°í¸í•¨</span> 
            <span class="gray-txt">â— ë¡œê³  í´ë¦­: ì‘ì—… ë¦¬ì…‹</span>
        </div>
        <!-- [ì‹ ê·œ] ë°©ì•—ê°„ ì•ˆë‚´ ë©˜íŠ¸ ì¶”ê°€ -->
        <div class="sub-desc">
            ì—¬ê¸°ëŠ” Dotì„ êµ´ë ¤ì„œ ë©‹ì§„ ê±¸ ë§Œë“œëŠ” ë°©ì•—ê°„ì´ì—ìš”.<br>
            ì§ì›ì„ ëˆŒëŸ¬ì„œ íœ´ì‹ì„ ì„ ë¬¼í•´ì£¼ì„¸ìš”.
        </div>
    </div>

    <!-- ìš°í¸í•¨ ì•„ì´ì½˜ (ë…ë¦½ ë°°ì¹˜) -->
    <div id="mailbox-icon" title="ë‚´ ìš°í¸í•¨ í™•ì¸í•˜ê¸°" onclick="openMyMsgModal()">
        <div id="mailbox-text">ë‚´ ìš°í¸í•¨</div>
    </div>

    <div id="guide-text">
        <h2>2026 ìƒˆí•´ ë§ì´ ë‹·ë°€ ë¡¤ë§í˜ì´í¼ ğŸ“œ</h2>
        <p>
            ì˜¬ í•œ í•´ ê³ ìƒí•œ ë™ë£Œì—ê²Œ ì¹­ì°¬ê³¼ ì‘ì›ì˜ ë©”ì‹œì§€ë¥¼ ë³´ë‚´ì£¼ì„¸ìš”!<br>
            ë³´ë‚´ëŠ” ì‚¬ëŒì€ ìµëª…ìœ¼ë¡œ ì²˜ë¦¬ë˜ë©°, ë™ë£Œì˜ ì´ë¦„ìœ¼ë¡œ ì „ë‹¬ë©ë‹ˆë‹¤.
        </p>
    </div>

    <button id="view-all-btn">ğŸ“œ ì „ì²´ ë©”ì‹œì§€ ë³´ê¸°</button>
    <button id="audio-btn">ğŸ”‡</button>

    <div id="custom-alert">
        <span id="alert-check">âœ…</span>
        <h3>ì „ì†¡ ì™„ë£Œ!</h3>
        <p>ìµëª…ìœ¼ë¡œ ë©”ì‹œì§€ê°€ ë¬´ì‚¬íˆ ì „ë‹¬ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ“¨</p>
    </div>

    <div id="pc-toast">
        PCì—ì„œ ì ‘ì†í•˜ì‹œë©´ ìµœì í™”ëœ ê²½í—˜ì„ í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤ ğŸ’»
    </div>

    <div id="modal-overlay"></div>

    <!-- ì „ì²´ ë©”ì‹œì§€í•¨ -->
    <div id="list-modal" class="modal-window">
        <div class="modal-header">ì „ì²´ ë©”ì‹œì§€í•¨ <span class="close-modal-btn" data-target="list-modal">Ã—</span></div>
        <div id="msg-list" class="msg-list-container"><div class="empty-msg">ë¡œë”© ì¤‘... â³</div></div>
    </div>

    <!-- ë‚´ ë©”ì‹œì§€ í™•ì¸í•¨ (í™•ì¥í˜•) -->
    <div id="my-msg-modal" class="modal-window">
        <div class="modal-header">
            <span>ğŸ“¬ ë‚˜ì—ê²Œ ì˜¨ ë©”ì‹œì§€</span>
            <!-- ë³´ê¸° ëª¨ë“œ í† ê¸€ -->
            <div class="view-toggle">
                <label id="toggle-list" onclick="setViewMode('list')">ğŸ“„ ëª©ë¡</label>
                <label id="toggle-scene" onclick="setViewMode('scene')" class="active">âœ¨ ì¥ë©´</label>
            </div>
            <span class="close-modal-btn" data-target="my-msg-modal">Ã—</span>
        </div>
        
        <div id="my-msg-auth">
            <input type="text" id="my-name-input" placeholder="ë³¸ì¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" onkeypress="if(event.key==='Enter') checkMyMessages()">
            <button id="my-msg-btn" onclick="checkMyMessages()">í™•ì¸</button>
        </div>
        
        <div id="mailbox-content-area">
            <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
            <div id="mailbox-placeholder">ì´ë¦„ì„ ì…ë ¥í•˜ê³  í™•ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.<br>(ì •í™•íˆ ì¼ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤)</div>
            
            <!-- ëª©ë¡ ë³´ê¸° ì»¨í…Œì´ë„ˆ -->
            <div id="my-msg-list-container"></div>
            
            <!-- ì¥ë©´ ë³´ê¸° ì»¨í…Œì´ë„ˆ -->
            <div id="mailbox-canvas-container">
                <canvas id="mailbox-bg-canvas"></canvas>
            </div>
        </div>
    </div>

    <div id="input-bar">
        <!-- ëª¨ë‘ì—ê²Œ ì²´í¬ë°•ìŠ¤ -->
        <label class="to-all-wrapper" title="ì²´í¬í•˜ë©´ ëª¨ë‘ì—ê²Œ ë©”ì‹œì§€ë¥¼ ë³´ëƒ…ë‹ˆë‹¤">
            <input type="checkbox" id="to-all-check">
            <span>ëª¨ë‘</span>
        </label>
        
        <!-- ë°›ëŠ” ì‚¬ëŒ ì…ë ¥ -->
        <input type="text" id="receiver-input" placeholder="ë°›ëŠ”ë¶„" maxlength="5">
        
        <!-- ë©”ì‹œì§€ ì…ë ¥ -->
        <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ (ìµëª…)" autocomplete="off" maxlength="40">
        <button id="send-btn">â¤</button>
    </div>

    <canvas id="canvas"></canvas>

<script>
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwImwxFykweItZzd9OEJpssDeDKmdolp3icDNPZQFJ2-9hwYbrKyes_HY38Kq0dPnKS2g/exec";

    // --- [ì‚¬ìš´ë“œ] ---
    const audioFiles = {};
    const soundNames = ['bgm', 'sent', 'rest', 'pop', 'reset'];
    let isBgmOn = false; 
    
    soundNames.forEach(name => {
        const audio = new Audio(`sounds/${name}.mp3`);
        if(name === 'bgm') { audio.loop = true; audio.volume = 0.4; } 
        else { audio.volume = name === 'reset' ? 1.0 : 0.8; if(name === 'pop') audio.volume = 0.5; }
        audioFiles[name] = audio;
    });

    const audioBtn = document.getElementById('audio-btn');
    audioBtn.addEventListener('click', () => {
        if (isBgmOn) {
            audioFiles['bgm'].pause(); audioBtn.innerText = 'ğŸ”‡'; isBgmOn = false;
        } else {
            audioFiles['bgm'].play().then(() => { audioBtn.innerText = 'ğŸ”Š'; isBgmOn = true; })
            .catch(e => { alert("ì†Œë¦¬ íŒŒì¼ì„ ë¡œë”© ì¤‘ì´ê±°ë‚˜ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."); });
        }
    });
    
    function playSound(name) {
        if (isBgmOn && audioFiles[name]) { audioFiles[name].currentTime = 0; audioFiles[name].play().catch(e => {}); }
    }

    const receiverInput = document.getElementById('receiver-input'); 
    const msgInput = document.getElementById('msg-input');
    const sendBtn = document.getElementById('send-btn');
    const viewAllBtn = document.getElementById('view-all-btn');
    const toAllCheck = document.getElementById('to-all-check'); 
    
    const listModal = document.getElementById('list-modal');
    const myMsgModal = document.getElementById('my-msg-modal');
    const overlay = document.getElementById('modal-overlay');
    const closeBtns = document.querySelectorAll('.close-modal-btn');
    
    const msgList = document.getElementById('msg-list');
    const myNameInput = document.getElementById('my-name-input');
    const customAlert = document.getElementById('custom-alert');

    // [ì‹ ê·œ] ë·° ëª¨ë“œ ê´€ë¦¬
    let currentViewMode = 'scene'; // 'list' or 'scene'
    const mbListContainer = document.getElementById('my-msg-list-container');
    const mbCanvasContainer = document.getElementById('mailbox-canvas-container');
    const mbToggleList = document.getElementById('toggle-list');
    const mbToggleScene = document.getElementById('toggle-scene');

    function setViewMode(mode) {
        currentViewMode = mode;
        if (mode === 'list') {
            mbListContainer.style.display = 'block';
            mbCanvasContainer.style.display = 'none';
            mbToggleList.classList.add('active');
            mbToggleScene.classList.remove('active');
            // ëª©ë¡ ëª¨ë“œë¡œ ê°€ë©´ ìº”ë²„ìŠ¤ ì• ë‹ˆë©”ì´ì…˜ ì •ì§€
            if (mbAnimationId) cancelAnimationFrame(mbAnimationId);
        } else {
            mbListContainer.style.display = 'none';
            mbCanvasContainer.style.display = 'block';
            mbToggleList.classList.remove('active');
            mbToggleScene.classList.add('active');
            // ìº”ë²„ìŠ¤ í¬ê¸° ì¬ì¡°ì • ë° ì• ë‹ˆë©”ì´ì…˜ ì¬ê°œ
            resizeMailboxCanvas();
            animateMailbox(); 
        }
    }

    // ìº”ë²„ìŠ¤ í¬ê¸° ì¡°ì • í•¨ìˆ˜
    function resizeMailboxCanvas() {
        const rect = document.getElementById('mailbox-content-area').getBoundingClientRect();
        mbCanvas.width = rect.width;
        mbCanvas.height = rect.height;
    }

    // [ì‹ ê·œ] ìš°í¸í•¨ ë‚´ë¶€ ìº”ë²„ìŠ¤ ê´€ë ¨ ë³€ìˆ˜
    const mbCanvas = document.getElementById('mailbox-bg-canvas');
    const mbCtx = mbCanvas.getContext('2d');
    const mbPlaceholder = document.getElementById('mailbox-placeholder');
    let mbDancers = [];
    let mbSnowflakes = [];
    let mbAnimationId = null;

    // ëª¨ë‘ì—ê²Œ ì²´í¬ ì‹œ ì…ë ¥ì°½ ì œì–´
    toAllCheck.addEventListener('change', (e) => {
        if (e.target.checked) {
            receiverInput.disabled = true;
            receiverInput.value = '';
            receiverInput.placeholder = 'ì „ì²´';
        } else {
            receiverInput.disabled = false;
            receiverInput.placeholder = 'ë°›ëŠ”ë¶„';
        }
    });

    function showCustomAlert() {
        customAlert.style.display = 'block'; setTimeout(() => { customAlert.style.display = 'none'; }, 2500);
    }

    async function sendMessage() {
        let receiver = '';
        const rawName = receiverInput.value.trim();

        if (toAllCheck.checked) {
            receiver = 'ALL';
        } else {
            const namePattern = /^[ê°€-í£]{3}$/;
            if (!namePattern.test(rawName)) {
                return alert("ë°›ëŠ” ë¶„ì˜ ì •í™•í•œ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.\n(í•œê¸€ 3ê¸€ì)");
            }
            receiver = rawName;
        }

        const text = msgInput.value.trim();
        if (!text) return alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
        
        sendBtn.disabled = true; const originalPlaceholder = msgInput.placeholder;
        msgInput.value = ''; msgInput.placeholder = 'ì „ì†¡ ì¤‘... ğŸš€';
        
        try {
            await fetch(GOOGLE_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name: receiver, text: text }) });
            if (window.distributeSingleMessage) window.distributeSingleMessage({ name: receiver, text: text });
            playSound('sent'); showCustomAlert();
            if (!toAllCheck.checked) receiverInput.value = ''; 
        } catch (error) { alert("ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."); } finally { sendBtn.disabled = false; msgInput.placeholder = originalPlaceholder; msgInput.focus(); }
    }

    // ì „ì²´ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸° (ë¦¬ìŠ¤íŠ¸í˜•)
    async function fetchAllMessages() {
        msgList.innerHTML = '<div class="empty-msg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...<br>(ì•½ 1~2ì´ˆ ì†Œìš”)</div>';
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL); const data = await response.json(); msgList.innerHTML = ''; 
            if (!data || data.length === 0) { msgList.innerHTML = '<div class="empty-msg">ë©”ì‹œì§€ ì—†ìŒ</div>'; return; }
            data.forEach(row => {
                const dateRaw = new Date(row[0]); const dateStr = (dateRaw.getMonth()+1) + '/' + dateRaw.getDate() + ' ' + dateRaw.getHours() + ':' + String(dateRaw.getMinutes()).padStart(2,'0');
                const div = document.createElement('div'); div.className = 'list-item';
                let displayReceiver = row[1];
                let receiverClass = 'list-receiver';
                if (displayReceiver === 'ALL') {
                    displayReceiver = 'ëª¨ë‘ì—ê²Œ ğŸ“¢';
                    receiverClass = 'list-receiver green-txt'; 
                } else {
                    displayReceiver = `To. ${displayReceiver}`;
                }
                div.innerHTML = `<div class="list-date">${dateStr}</div><div><span class="${receiverClass}">${displayReceiver}</span> <span class="list-text">${row[2]}</span></div>`;
                msgList.appendChild(div);
            });
        } catch (error) { msgList.innerHTML = '<div class="empty-msg">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨!</div>'; }
    }

    // --- [ì‹ ê·œ] ì—°ë§ ê°ì„±: ëˆˆì†¡ì´ í´ë˜ìŠ¤ ---
    class Snowflake {
        constructor(w, h) {
            this.x = Math.random() * w;
            this.y = Math.random() * h;
            this.size = Math.random() * 2 + 0.5;
            this.speed = Math.random() * 1 + 0.5;
            this.opacity = Math.random() * 0.5 + 0.3;
        }
        update(w, h) {
            this.y += this.speed;
            this.x += Math.sin(this.y * 0.05) * 0.5;
            if (this.y > h) {
                this.y = -10;
                this.x = Math.random() * w;
            }
        }
        draw(ctx) {
            ctx.fillStyle = `rgba(255, 255, 255, ${this.opacity})`;
            ctx.beginPath();
            ctx.arc(this.x, this.y, this.size, 0, Math.PI*2);
            ctx.fill();
        }
    }

    // --- [ì‹ ê·œ] ìš°í¸í•¨ ë‚´ë¶€ ëŒ„ì„œ í´ë˜ìŠ¤ (ë¹›ì˜ ì •ë ¹ & íŒŒí‹° ì»¨ì…‰) ---
    class PartyFairy {
        constructor(msg, isPrivate, w, h) {
            this.msg = msg; 
            this.isPrivate = isPrivate; // trueë©´ í•‘í¬/ë¹›ë‚¨ (ë‚˜ì—ê²Œ ì˜¨ ê²ƒ)
            this.x = Math.random() * (w - 60) + 30;
            this.y = Math.random() * (h - 100) + 80; 
            // ë‹·ë°€ ì»¬ëŸ¬ ëŠë‚Œ: í•‘í¬ or ë°ì€ ë¯¼íŠ¸/ë¸”ë£¨
            this.color = isPrivate ? '#ec4899' : '#06b6d4'; 
            this.bodyOffset = Math.random() * 100;
            this.dir = Math.random() < 0.5 ? -1 : 1;
            this.speed = 0.5 + Math.random();
            this.blinkTimer = Math.random() * 200;
            this.isBlinking = false;
            
            // ëœë¤ ëª¨ì (0:ì—†ìŒ, 1:ì‚°íƒ€, 2:ê³ ê¹”, 3:ë£¨ëŒí”„ë¿”)
            this.hatType = Math.floor(Math.random() * 4);
        }

        update(w, h) {
            // ë‘ ì¹«ë‘ ì¹«
            this.bodyOffset += 0.15;
            this.x += this.dir * this.speed * 0.3;
            if (this.x < 30 || this.x > w - 30) this.dir *= -1;

            // ëˆˆ ê¹œë¹¡ì„
            this.blinkTimer--;
            if (this.blinkTimer <= 0) {
                this.isBlinking = true;
                if (this.blinkTimer <= -10) {
                    this.isBlinking = false;
                    this.blinkTimer = 100 + Math.random() * 200;
                }
            }
        }

        draw(ctx) {
            ctx.save();
            ctx.translate(this.x, this.y);
            
            // ì¶¤ì¶”ëŠ” ë°”ìš´ìŠ¤
            const bounce = Math.sin(this.bodyOffset) * 6;
            ctx.translate(0, bounce);

            // ë¹›ë‚˜ëŠ” íš¨ê³¼ (Glow)
            ctx.shadowColor = this.color;
            ctx.shadowBlur = this.isPrivate ? 25 : 15; // ë‚´ ë©”ì‹œì§€ê°€ ë” ë¹›ë‚¨

            // ëª¸í†µ (ë‘¥ê·¼ ì ¤ë¦¬ ëª¨ì–‘)
            ctx.fillStyle = this.color;
            ctx.beginPath();
            ctx.arc(0, 0, 14, Math.PI, 0); // ìœ„ìª½ ë°˜ì›
            ctx.lineTo(14, 15); // ì•„ë˜ë¡œ
            ctx.bezierCurveTo(7, 20, -7, 20, -14, 15); // ì•„ë˜ìª½ ë‘¥ê¸€ê²Œ
            ctx.fill();

            // ëˆˆ (Glow ë„ê³  ê·¸ë¦¼)
            ctx.shadowBlur = 0;
            ctx.fillStyle = '#fff';
            if (this.isBlinking) {
                ctx.fillRect(-6, -2, 4, 1);
                ctx.fillRect(2, -2, 4, 1);
            } else {
                ctx.beginPath(); ctx.arc(-4, -2, 2.5, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(4, -2, 2.5, 0, Math.PI*2); ctx.fill();
            }

            // ë³¼í„°ì¹˜
            ctx.fillStyle = 'rgba(255, 100, 100, 0.3)';
            ctx.beginPath(); ctx.arc(-7, 2, 2, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(7, 2, 2, 0, Math.PI*2); ctx.fill();

            // ëª¨ì ê·¸ë¦¬ê¸°
            this.drawHat(ctx);

            // ë§í’ì„ 
            this.drawBubble(ctx);

            ctx.restore();
        }

        drawHat(ctx) {
            ctx.shadowBlur = 0;
            if (this.hatType === 1) { // ì‚°íƒ€ ëª¨ì
                ctx.fillStyle = '#ef4444';
                ctx.beginPath(); ctx.moveTo(-14, -10); ctx.lineTo(0, -30); ctx.lineTo(14, -10); ctx.fill();
                ctx.fillStyle = '#fff';
                ctx.fillRect(-16, -10, 32, 6); // í„¸
                ctx.beginPath(); ctx.arc(0, -30, 4, 0, Math.PI*2); ctx.fill(); // ë°©ìš¸
            } else if (this.hatType === 2) { // ê³ ê¹” ëª¨ì
                ctx.fillStyle = '#facc15';
                ctx.beginPath(); ctx.moveTo(-10, -10); ctx.lineTo(0, -28); ctx.lineTo(10, -10); ctx.fill();
            } else if (this.hatType === 3) { // ë£¨ëŒí”„ ë¿”
                ctx.strokeStyle = '#b45309';
                ctx.lineWidth = 2;
                ctx.beginPath(); 
                ctx.moveTo(-5, -10); ctx.lineTo(-12, -22); ctx.lineTo(-8, -24); 
                ctx.moveTo(-12, -22); ctx.lineTo(-16, -20);
                ctx.moveTo(5, -10); ctx.lineTo(12, -22); ctx.lineTo(8, -24);
                ctx.moveTo(12, -22); ctx.lineTo(16, -20);
                ctx.stroke();
            }
        }

        drawBubble(ctx) {
            const text = this.msg.text.length > 8 ? this.msg.text.substring(0, 8) + '..' : this.msg.text;
            ctx.font = 'bold 12px "Pretendard", sans-serif';
            const tm = ctx.measureText(text);
            const w = tm.width + 20;
            const h = 30;

            ctx.save();
            ctx.translate(0, -45); // ë¨¸ë¦¬ ìœ„ìª½
            
            // Glassmorphism ë§í’ì„  (ë°˜íˆ¬ëª… + í…Œë‘ë¦¬)
            ctx.fillStyle = 'rgba(255, 255, 255, 0.2)'; // ë°˜íˆ¬ëª… ë‚´ë¶€
            ctx.strokeStyle = this.isPrivate ? 'rgba(255, 105, 180, 0.8)' : 'rgba(100, 200, 255, 0.5)'; // í•‘í¬ or ë¸”ë£¨ ë„¤ì˜¨ í…Œë‘ë¦¬
            ctx.lineWidth = 1.5;
            
            ctx.beginPath();
            ctx.roundRect(-w/2, -h, w, h, 10);
            ctx.fill();
            ctx.stroke();
            
            // ê¼¬ë¦¬
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(-4, 6); ctx.lineTo(4, 6); ctx.closePath();
            ctx.fillStyle = this.isPrivate ? 'rgba(255, 105, 180, 0.8)' : 'rgba(100, 200, 255, 0.5)';
            ctx.fill();

            // í…ìŠ¤íŠ¸
            ctx.fillStyle = '#fff';
            ctx.textAlign = 'center';
            ctx.fillText(text, 0, -10);
            
            // ìˆ˜ì‹ ì í‘œì‹œ (ë§í’ì„  ìœ„)
            ctx.font = 'bold 11px "Pretendard", sans-serif';
            if (!this.isPrivate) {
                ctx.fillStyle = '#67e8f9'; // ë°ì€ í•˜ëŠ˜ìƒ‰ (ALL)
                ctx.fillText('To. ëª¨ë‘ì—ê²Œ', 0, -h - 6);
            } else {
                ctx.fillStyle = '#ff69b4'; // í•«í•‘í¬ (ë‚˜ì—ê²Œ)
                ctx.fillText(`To. ${this.msg.name}`, 0, -h - 6);
            }

            ctx.restore();
        }
    }

    // ìš°í¸í•¨ ì• ë‹ˆë©”ì´ì…˜ ë£¨í”„ (ë°°ê²½ íš¨ê³¼ í¬í•¨)
    function animateMailbox() {
        if (myMsgModal.style.display === 'none' || currentViewMode !== 'scene') return; // ëª¨ë‹¬ ë‹«íˆê±°ë‚˜ ëª©ë¡ ë·°ë©´ ì¤‘ì§€
        
        mbCtx.clearRect(0, 0, mbCanvas.width, mbCanvas.height);
        
        // 1. ë°°ê²½ (ë‹·ë°€ ì˜¤ë¡œë¼ ëŠë‚Œ ê·¸ë¼ë°ì´ì…˜)
        const time = Date.now() * 0.0005;
        const g = mbCtx.createLinearGradient(0, 0, 0, mbCanvas.height);
        g.addColorStop(0, '#0f172a'); // Deep Navy
        g.addColorStop(1, '#312e81'); // Indigo
        mbCtx.fillStyle = g;
        mbCtx.fillRect(0,0, mbCanvas.width, mbCanvas.height);

        // 2. ì˜¤ë¡œë¼ ë¼ì´íŠ¸ íš¨ê³¼ (ë°”ë‹¥ ì¡°ëª…)
        mbCtx.save();
        mbCtx.globalCompositeOperation = 'screen';
        const lightX = mbCanvas.width/2 + Math.sin(time) * 100;
        const lg = mbCtx.createRadialGradient(lightX, mbCanvas.height, 10, lightX, mbCanvas.height, 200);
        lg.addColorStop(0, 'rgba(56, 189, 248, 0.3)');
        lg.addColorStop(1, 'rgba(56, 189, 248, 0)');
        mbCtx.fillStyle = lg;
        mbCtx.fillRect(0,0, mbCanvas.width, mbCanvas.height);
        mbCtx.restore();

        // 3. ëˆˆ ë‚´ë¦¬ëŠ” íš¨ê³¼ ì—…ë°ì´íŠ¸ ë° ê·¸ë¦¬ê¸°
        mbSnowflakes.forEach(s => {
            s.update(mbCanvas.width, mbCanvas.height);
            s.draw(mbCtx);
        });

        // 4. ì •ë ¹ë“¤ ê·¸ë¦¬ê¸° (ì •ë ¬í•´ì„œ ì•ë’¤ êµ¬ë¶„)
        mbDancers.sort((a, b) => a.y - b.y);
        mbDancers.forEach(d => {
            d.update(mbCanvas.width, mbCanvas.height);
            d.draw(mbCtx);
        });

        mbAnimationId = requestAnimationFrame(animateMailbox);
    }

    // ë‚´ ë©”ì‹œì§€ í™•ì¸í•˜ê¸° (ìº”ë²„ìŠ¤ ì´ˆê¸°í™” ë° ë°ì´í„° ë¡œë“œ)
    async function checkMyMessages() {
        const myName = myNameInput.value.trim();
        if (!myName) return alert("ë³¸ì¸ì˜ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        
        // ì´ˆê¸°í™”
        mbPlaceholder.style.display = 'block';
        mbPlaceholder.innerHTML = 'âœ¨ ìš°í¸í•¨ íŒŒí‹°ì¥ ì…ì¥ ì¤‘... âœ¨';
        mbListContainer.innerHTML = '<div class="empty-msg">ë¡œë”© ì¤‘...</div>';
        mbDancers = []; 
        mbSnowflakes = [];
        
        resizeMailboxCanvas();

        // ëˆˆì†¡ì´ 50ê°œ ìƒì„± (ì¥ë©´ ë³´ê¸°ìš©)
        for(let i=0; i<50; i++) mbSnowflakes.push(new Snowflake(mbCanvas.width, mbCanvas.height));

        try {
            const response = await fetch(GOOGLE_SCRIPT_URL); 
            const data = await response.json(); 
            
            if (!data || data.length === 0) { 
                const emptyText = 'ì•„ì§ ë„ì°©í•œ í¸ì§€ê°€ ì—†ì–´ìš” ğŸ˜¢';
                mbPlaceholder.innerHTML = emptyText; 
                mbListContainer.innerHTML = `<div class="empty-msg">${emptyText}</div>`;
                return; 
            }

            // í•„í„°ë§: ë‚´ ì´ë¦„ OR ì „ì²´(ALL)
            const myMessages = data.filter(row => 
                row[1] === 'ALL' || 
                row[1].replace(/\s/g, '') === myName.replace(/\s/g, '')
            );
            
            if (myMessages.length === 0) {
                const emptyText = `'${myName}'ë‹˜ê³¼ ëª¨ë‘ì—ê²Œ ë„ì°©í•œ<br>ë©”ì‹œì§€ê°€ ì•„ì§ ì—†ë„¤ìš”. í……~`;
                mbPlaceholder.innerHTML = emptyText;
                mbListContainer.innerHTML = `<div class="empty-msg">${emptyText}</div>`;
                return;
            }

            // 1) ë¦¬ìŠ¤íŠ¸ ë·° ì±„ìš°ê¸°
            mbListContainer.innerHTML = '';
            myMessages.forEach(row => {
                const dateRaw = new Date(row[0]); 
                const dateStr = (dateRaw.getMonth()+1) + '/' + dateRaw.getDate() + ' ' + dateRaw.getHours() + ':' + String(dateRaw.getMinutes()).padStart(2,'0');
                const div = document.createElement('div'); div.className = 'list-item';
                
                let prefix = '';
                if (row[1] === 'ALL') prefix = '<span style="color:#00e676; font-size:0.8rem; margin-right:5px; font-weight:bold;">[ì „ì²´]</span>';
                else prefix = '<span style="color:#ec4899; font-size:0.8rem; margin-right:5px; font-weight:bold;">[ë‚˜ì—ê²Œ]</span>';

                div.innerHTML = `<div class="list-date">${dateStr}</div><div>${prefix}<span class="list-text" style="font-weight:bold;">${row[2]}</span></div>`;
                mbListContainer.appendChild(div);
            });

            // 2) ì¥ë©´(ìº”ë²„ìŠ¤) ë·° ëŒ„ì„œ ìƒì„± (ìµœëŒ€ 10ëª… ì œí•œ)
            mbPlaceholder.style.display = 'none'; // ë¡œë”© ë¬¸êµ¬ ìˆ¨ê¹€
            
            const displayMessages = myMessages.slice(0, 10); // [ìˆ˜ì •] 10ê°œë§Œ ìŠ¬ë¼ì´ìŠ¤
            displayMessages.forEach(row => {
                const isPrivate = (row[1] !== 'ALL'); 
                mbDancers.push(new PartyFairy({ name: row[1], text: row[2] }, isPrivate, mbCanvas.width, mbCanvas.height));
            });

            // í˜„ì¬ ë·° ëª¨ë“œì— ë”°ë¼ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
            if (currentViewMode === 'scene') {
                if (mbAnimationId) cancelAnimationFrame(mbAnimationId);
                animateMailbox();
            }

        } catch (error) { 
            mbPlaceholder.innerHTML = 'ì…ì¥ ì‹¤íŒ¨! ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'; 
            mbListContainer.innerHTML = '<div class="empty-msg">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }

    sendBtn.addEventListener('click', sendMessage);
    msgInput.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
    
    viewAllBtn.addEventListener('click', () => { listModal.style.display = 'flex'; overlay.style.display = 'block'; fetchAllMessages(); });
    
    closeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const targetId = btn.getAttribute('data-target');
            document.getElementById(targetId).style.display = 'none';
            overlay.style.display = 'none';
            if (targetId === 'my-msg-modal') {
                if (mbAnimationId) cancelAnimationFrame(mbAnimationId); 
            }
        });
    });

    function hideAllModals() {
        listModal.style.display = 'none';
        myMsgModal.style.display = 'none';
        overlay.style.display = 'none';
        if (mbAnimationId) cancelAnimationFrame(mbAnimationId);
    }
    overlay.addEventListener('click', hideAllModals);

    window.openMyMsgModal = () => {
        myMsgModal.style.display = 'flex'; 
        overlay.style.display = 'block'; 
        myNameInput.focus();
        
        // ë·° ì´ˆê¸°í™” (ê¸°ë³¸: ì¥ë©´ ë³´ê¸°)
        setViewMode('scene');
        
        mbPlaceholder.style.display = 'block';
        mbPlaceholder.innerHTML = 'ì´ë¦„ì„ ì…ë ¥í•˜ê³  í™•ì¸ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.';
        mbListContainer.innerHTML = ''; 
        mbCtx.clearRect(0,0, mbCanvas.width, mbCanvas.height);
        
        // ëŒ€ê¸° í™”ë©´ ëˆˆë‚´ë¦¬ê¸°
        resizeMailboxCanvas();
        mbSnowflakes = [];
        for(let i=0; i<30; i++) mbSnowflakes.push(new Snowflake(mbCanvas.width, mbCanvas.height));
        
        if (mbAnimationId) cancelAnimationFrame(mbAnimationId);
        function waitLoop() {
            if (myMsgModal.style.display === 'none' || mbDancers.length > 0 || currentViewMode !== 'scene') return;
            mbCtx.fillStyle = '#0f172a'; mbCtx.fillRect(0,0, mbCanvas.width, mbCanvas.height);
            mbSnowflakes.forEach(s => { s.update(mbCanvas.width, mbCanvas.height); s.draw(mbCtx); });
            mbAnimationId = requestAnimationFrame(waitLoop);
        }
        waitLoop();
    };

    // ìœˆë„ìš° ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ìº”ë²„ìŠ¤ í¬ê¸° ëŒ€ì‘
    window.addEventListener('resize', () => {
        if (myMsgModal.style.display === 'flex') {
            resizeMailboxCanvas();
        }
    }); 
</script>

<script>
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const isMobile = window.innerWidth <= 768;

    if (isMobile) {
        const toast = document.getElementById('pc-toast');
        toast.style.display = 'block'; setTimeout(() => { toast.style.display = 'none'; }, 2500);
    }

    // [í°íŠ¸ ìˆ˜ì •] ë¡œê³  í…ìŠ¤íŠ¸ë„ Pretendard ì ìš©
    const CONFIG = { 
        text: 'dotmill', font: '900 120px "Pretendard", Arial', pixelSize: 5, 
        builderCount: 15, engineerCount: 3, officeCount: 50, 
        colors: ['#0ea5e9', '#334155', '#475569', '#1e293b'], 
        dropInterval: 300, beltSpeed: 2 
    };

    let particles=[], fairies=[], beltOffset=0, lastDropTime=0, mouseX=0, mouseY=0, hoveredFairy=null;
    let monitorHueOffset = 0, isLogoComplete = false;
    let zones={ hopper:{x:0,y:0}, beltStart:{x:0,y:0}, beltEnd:{x:0,y:0}, storage:{x:0,y:0}, office:{x:0,y:0,w:0,h:0} };

    class Particle {
        constructor(tx,ty,c){this.targetX=tx;this.targetY=ty;this.baseColor=c;this.x=zones.hopper.x+(Math.random()-0.5)*40;this.y=zones.hopper.y-20;this.state='WAITING';this.carrier=null;}
        update(){if(this.state==='WAITING')return;if(this.state==='FALLING'){this.y+=4;if(this.y>=zones.beltStart.y-10){this.y=zones.beltStart.y-10+Math.random()*5;this.state='ON_BELT';}}else if(this.state==='ON_BELT'){const dx=zones.beltEnd.x-zones.beltStart.x,dy=zones.beltEnd.y-zones.beltStart.y,d=Math.sqrt(dx*dx+dy*dy);this.x+=(dx/d)*CONFIG.beltSpeed;this.y+=(dy/d)*CONFIG.beltSpeed;if(this.x>=zones.beltEnd.x){this.state='IN_STORAGE';this.x=zones.storage.x+(Math.random()-0.5)*30;this.y=zones.storage.y+(Math.random()-0.5)*20;}}else if(this.state==='RETURNING'){const dx=zones.hopper.x-this.x,dy=zones.hopper.y-this.y;this.x+=dx*0.1;this.y+=dy*0.1;if(Math.abs(dy)<5)this.state='WAITING';}}
        draw(){if(this.state==='WAITING')return;ctx.fillStyle=this.baseColor;if(this.state==='PLACED')ctx.fillRect(this.x,this.y,CONFIG.pixelSize,CONFIG.pixelSize);else{ctx.beginPath();ctx.arc(this.x,this.y,CONFIG.pixelSize/2+1,0,Math.PI*2);ctx.fill();}}
        reset(){this.state='RETURNING';this.carrier=null;}
    }

    class Fairy {
        constructor(role, idx) {
            this.role = role; this.x = canvas.width/2; this.y = canvas.height/2; this.targetItem = null; this.state = 'IDLE';
            this.colorShirt = ['#a3d2ca', '#ffc3a0', '#fff'][Math.floor(Math.random()*3)]; this.animFrame = Math.random()*100;
            this.isPaused=false; this.pauseTimer=null; this.busyState='NONE'; this.busyTimer=Math.random()*500;
            this.busyTargetX=0; this.busyTargetY=0; this.seatX=0; this.seatY=0;
            this.assignedMessage = null; this.assignmentTime = 0; 
            if(role==='ENGINEER'){this.x=zones.beltStart.x+(zones.beltEnd.x-zones.beltStart.x)*0.5;this.y=zones.beltStart.y+30;}
            else if(role==='OFFICE'){ const c=Math.ceil(CONFIG.officeCount/2),r=Math.floor(idx/c),cl=idx%c,dw=60,dh=60,tw=c*dw,sx=(canvas.width-tw)/2+30,sy=zones.office.y+50; this.seatX=sx+cl*dw;this.seatY=sy+r*dh;this.x=this.seatX;this.y=this.seatY;this.busyState='TYPING';} 
            else if(role==='FOREMAN'){ 
                // ì‘ì—…ë°˜ì¥(ì¤‘ì•™ ì£¼ì¸ê³µ ì¹œêµ¬) ìœ„ì¹˜
                this.x = canvas.width/2 - 250; 
                this.y = canvas.height/2 - 20; 
            }
        }
        giveVacation() { 
            this.isPaused=true; playSound('rest'); 
            if(this.pauseTimer)clearTimeout(this.pauseTimer); 
            this.pauseTimer=setTimeout(()=>{this.isPaused=false;},5000); 
        }
        update() { if(this.isPaused)return; this.animFrame+=0.1; if(this.role==='BUILDER')this.updateBuilder(); else if(this.role==='OFFICE')this.updateOffice(); }
        updateOffice(){if(this.busyState==='TYPING'){this.busyTimer--;if(this.busyTimer<=0){if(Math.random()<0.05){this.busyState='PATROL';this.busyTargetX=zones.office.x+Math.random()*zones.office.w;this.busyTargetY=zones.office.y+Math.random()*zones.office.h;}else{this.busyTimer=200+Math.random()*400;}}}else if(this.busyState==='PATROL'){if(this.moveTo(this.busyTargetX,this.busyTargetY)){this.busyState='WAITING_TO_RETURN';this.busyTimer=50+Math.random()*100;}}else if(this.busyState==='WAITING_TO_RETURN'){this.busyTimer--;if(this.busyTimer<=0)this.busyState='RETURN';}else if(this.busyState==='RETURN'){if(this.moveTo(this.seatX,this.seatY)){this.busyState='TYPING';this.busyTimer=300+Math.random()*500;}}}
        updateBuilder(){
            if(!this.targetItem){
                const job=particles.find(p=>p.state==='IN_STORAGE'&&!p.carrier);
                if(job){ this.busyState='NONE';this.targetItem=job;job.carrier=this;this.state='MOVING_TO_STORAGE'; } else { this.performBusyAction(); }
            } else {
                if(this.targetItem.state==='RETURNING'){this.targetItem=null;this.state='IDLE';return;}
                if(this.state==='MOVING_TO_STORAGE'){if(this.moveTo(this.targetItem.x,this.targetItem.y)){this.targetItem.state='CARRIED';this.state='DELIVERING';}}
                else if(this.state==='DELIVERING'){this.targetItem.x=this.x;this.targetItem.y=this.y-12;if(this.moveTo(this.targetItem.targetX,this.targetItem.targetY)){this.targetItem.state='PLACED';this.targetItem.x=this.targetItem.targetX;this.targetItem.y=this.targetItem.targetY;this.targetItem.carrier=null;this.targetItem=null;this.state='IDLE';}}
            }
        }
        performBusyAction(){
            if(this.busyTimer<=0){
                const r=Math.random();
                if(r<0.5){this.busyState='PATROL';this.busyTargetX=canvas.width/2+(Math.random()-0.5)*400;this.busyTargetY=canvas.height/2+(Math.random()-0.5)*150;}
                else if(r<0.8)this.busyState='CLEAN'; else this.busyState='HAMMER';
                this.busyTimer=60+Math.random()*120;
            }
            this.busyTimer--;
            if(this.busyState==='PATROL')this.moveTo(this.busyTargetX,this.busyTargetY);
            else if(this.busyState==='CLEAN')this.x+=Math.sin(Date.now()*0.02)*0.5;
            else if(this.busyState==='HAMMER'){if(Math.abs(this.x-canvas.width/2)>300)this.moveTo(canvas.width/2,canvas.height/2);}
        }
        moveTo(tx,ty){const dx=tx-this.x,dy=ty-this.y,d=Math.sqrt(dx*dx+dy*dy);if(d<4){this.x=tx;this.y=ty;return true;}const s=this.role==='OFFICE'?1.5:4;this.x+=(dx/d)*s;this.y+=(dy/d)*s;return false;}

        draw() {
            ctx.save(); ctx.translate(this.x, this.y);
            let drawShirtColor = this.colorShirt; let indicatorColor = null;
            if (this.isPaused) { ctx.shadowColor = '#ffd700'; ctx.shadowBlur = 20; } 
            else if (this.assignedMessage) {
                const timeDiff = Date.now() - this.assignmentTime;
                if (timeDiff < 2000) { ctx.shadowColor = '#00e676'; ctx.shadowBlur = 25; indicatorColor = '#00e676'; } 
                else { drawShirtColor = '#2979ff'; indicatorColor = '#2979ff'; ctx.shadowBlur = 0; }
            } else { ctx.shadowBlur = 0; }
            if(!this.isPaused && (this.busyState==='HAMMER'||(this.role==='OFFICE'&&this.busyState==='TYPING'))) ctx.translate(0,Math.sin(Date.now()*0.05));
            if (indicatorColor) { ctx.fillStyle = indicatorColor; ctx.beginPath(); ctx.arc(0, -18, 3.5, 0, Math.PI*2); ctx.fill(); }
            const w=12,h=20; ctx.fillStyle='#333';ctx.fillRect(-w/2,0,w,h/2); ctx.fillStyle=drawShirtColor;ctx.fillRect(-w/2,-h/2,w,h/2); ctx.fillStyle='#fce4d4';ctx.fillRect(-w/2+2,-h/2-6,8,8);
            if(this.role==='FOREMAN'){ctx.fillStyle='#ffcc00';ctx.fillRect(-w/2,-h/2-8,w,4);ctx.strokeStyle='red';ctx.beginPath();ctx.moveTo(w/2,-h/2);ctx.lineTo(w/2+10,-h/2-5);ctx.stroke();}
            else if(this.role==='ENGINEER'){ctx.save();ctx.translate(w/2,0);ctx.rotate(Math.sin(this.animFrame)*0.5);ctx.fillStyle='#888';ctx.fillRect(0,-2,10,4);ctx.restore();}
            else if(this.role==='OFFICE'){ctx.fillStyle='#333';ctx.fillRect(-w/2+3,-h/2-3,6,2);}
            else if(this.role==='BUILDER'&&this.state==='DELIVERING'){ctx.fillStyle='#fce4d4';ctx.fillRect(-w/2-2,-h/2,2,6);ctx.fillRect(w/2,-h/2,2,6);}
            
            if (this.role === 'BUILDER' && !this.isPaused) {
                if (this.busyState === 'CLEAN') {
                    ctx.save(); ctx.strokeStyle = '#8d6e63'; ctx.lineWidth = 2; ctx.beginPath(); ctx.moveTo(4, 5); ctx.lineTo(4 + Math.sin(Date.now()*0.02)*8, 18); ctx.stroke();
                    ctx.fillStyle='#d7ccc8'; ctx.beginPath(); ctx.arc(4 + Math.sin(Date.now()*0.02)*8, 18, 3, 0, Math.PI); ctx.fill(); ctx.restore();
                } else if (this.busyState === 'HAMMER') {
                    ctx.save(); ctx.translate(6, 0); ctx.rotate(Math.sin(Date.now() * 0.2) * 0.8);
                    ctx.fillStyle = '#5d4037'; ctx.fillRect(0, -10, 2, 12); ctx.fillStyle = '#555'; ctx.fillRect(-3, -12, 8, 4); ctx.restore();
                }
            }
            ctx.restore();
        }
        drawBubble() {
            if (!this.assignedMessage) return;
            const msg = this.assignedMessage;
            ctx.save(); ctx.translate(this.x, this.y - 35);
            // [í°íŠ¸ ìˆ˜ì •] ë§í’ì„  ë‚´ë¶€ í°íŠ¸ êµì²´
            ctx.font = 'bold 14px "Pretendard", sans-serif'; const tm = ctx.measureText(msg.text), nm = ctx.measureText(msg.name);
            const w = Math.max(tm.width, nm.width) + 24, h = 48;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.95)'; ctx.shadowColor = 'rgba(0,0,0,0.2)'; ctx.shadowBlur = 10;
            ctx.beginPath(); ctx.roundRect(-w/2, -h, w, h, 12); ctx.fill();
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(-6, -6); ctx.lineTo(6, -6); ctx.fill();
            ctx.shadowBlur = 0; ctx.fillStyle = '#334155'; ctx.textAlign = 'center'; ctx.fillText(msg.text, 0, -26);
            
            // [ë³€ê²½] ëª¨ë‘ì—ê²Œ ë©”ì‹œì§€ì¸ ê²½ìš° í‘œì‹œ ë‹¤ë¥´ê²Œ
            let displayName = msg.name;
            if (displayName === 'ALL') displayName = 'ëª¨ë‘ì—ê²Œ';
            
            ctx.font = '500 12px "Pretendard"'; 
            ctx.fillStyle = (msg.name === 'ALL') ? '#00e676' : '#64748b'; // ëª¨ë‘ì—ê²Œë©´ ì´ˆë¡ìƒ‰
            ctx.fillText(`To. ${displayName}`, 0, -10);
            
            ctx.restore();
        }
    }

    function init() {
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        
        // [FIX] ìº”ë²„ìŠ¤ í¬ê¸°ê°€ 0ì¼ ê²½ìš° ì‹¤í–‰ ì¤‘ë‹¨ (ì˜¤ë¥˜ ë°©ì§€)
        if (canvas.width === 0 || canvas.height === 0) return;

        zones.hopper = { x: 100, y: 100 }; zones.beltStart = { x: 100, y: 180 }; zones.beltEnd = { x: canvas.width * 0.3, y: canvas.height * 0.6 }; zones.storage = { x: canvas.width * 0.3 + 20, y: canvas.height * 0.6 + 20 }; zones.office = { x: 0, y: canvas.height - 200, w: canvas.width, h: 200 };
        particles=[]; fairies=[];
        ctx.font = CONFIG.font; ctx.textAlign = 'center'; ctx.textBaseline = 'middle'; ctx.fillStyle = 'white'; ctx.fillText(CONFIG.text, canvas.width / 2, canvas.height / 2);
        const data = ctx.getImageData(0, 0, canvas.width, canvas.height); ctx.clearRect(0,0, canvas.width, canvas.height);
        for(let y=0; y<data.height; y+=CONFIG.pixelSize) for(let x=0; x<data.width; x+=CONFIG.pixelSize) if(data.data[(y * 4 * data.width) + (x * 4) + 3] > 128) particles.push(new Particle(x, y, CONFIG.colors[Math.floor(Math.random() * CONFIG.colors.length)]));
        fairies.push(new Fairy('FOREMAN'));
        for(let i=0; i<CONFIG.builderCount; i++) fairies.push(new Fairy('BUILDER'));
        for(let i=0; i<CONFIG.engineerCount; i++) fairies.push(new Fairy('ENGINEER'));
        for(let i=0; i<CONFIG.officeCount; i++) fairies.push(new Fairy('OFFICE', i));
    }

    function isVisible(f) { return f.x > 20 && f.x < canvas.width - 20 && f.y > 0 && f.y < canvas.height; }

    window.distributeSingleMessage = (newMsg) => {
        let target = fairies.find(f => f.assignedMessage === null && isVisible(f));
        if (!target) {
            const visibleFairies = fairies.filter(f => isVisible(f));
            if (visibleFairies.length > 0) { target = visibleFairies[Math.floor(Math.random() * visibleFairies.length)]; } 
            else { target = fairies[Math.floor(Math.random() * fairies.length)]; }
        }
        if (target) { target.assignedMessage = newMsg; target.assignmentTime = Date.now(); }
    };

    function drawEnvironment() {
        ctx.fillStyle = '#999'; ctx.beginPath(); ctx.moveTo(zones.hopper.x - 30, zones.hopper.y - 50); ctx.lineTo(zones.hopper.x + 30, zones.hopper.y - 50); ctx.lineTo(zones.hopper.x + 10, zones.hopper.y); ctx.lineTo(zones.hopper.x - 10, zones.hopper.y); ctx.fill();
        ctx.strokeStyle = '#e2e8f0'; ctx.lineWidth = 40; ctx.lineCap = 'round'; ctx.beginPath(); ctx.moveTo(zones.beltStart.x, zones.beltStart.y); ctx.lineTo(zones.beltEnd.x, zones.beltEnd.y); ctx.stroke();
        beltOffset -= CONFIG.beltSpeed; ctx.strokeStyle = '#cbd5e1'; ctx.lineWidth = 30; ctx.setLineDash([10, 20]); ctx.lineDashOffset = beltOffset; ctx.beginPath(); ctx.moveTo(zones.beltStart.x, zones.beltStart.y); ctx.lineTo(zones.beltEnd.x, zones.beltEnd.y); ctx.stroke(); ctx.setLineDash([]);
        ctx.lineWidth = 5; ctx.strokeStyle = '#64748b'; ctx.beginPath(); ctx.moveTo(zones.beltEnd.x, zones.beltEnd.y); ctx.lineTo(zones.beltEnd.x, canvas.height); ctx.moveTo(zones.beltStart.x, zones.beltStart.y); ctx.lineTo(zones.beltStart.x, canvas.height); ctx.stroke();
        const lx = canvas.width/2 - 250; const ly = canvas.height/2 + 60; ctx.strokeStyle = '#8d6e63'; ctx.lineWidth = 4; ctx.beginPath(); ctx.moveTo(lx, ly); ctx.lineTo(lx, ly - 120); ctx.moveTo(lx + 30, ly); ctx.lineTo(lx + 30, ly - 120); for(let i=0; i<5; i++) { ctx.moveTo(lx, ly - 20 - (i*20)); ctx.lineTo(lx+30, ly - 20 - (i*20)); } ctx.stroke();
        ctx.fillStyle = '#f8fafc'; ctx.fillRect(zones.office.x, zones.office.y, zones.office.w, zones.office.h); ctx.fillStyle = '#e2e8f0'; ctx.fillRect(zones.office.x, canvas.height - 50, zones.office.w, 50);
        fairies.forEach((f, i) => {
            if (f.role === 'OFFICE') {
                const deskX = f.seatX; const deskY = f.seatY;
                ctx.fillStyle = '#cbd5e1'; ctx.fillRect(deskX - 25, deskY + 10, 50, 30); ctx.fillStyle = '#475569'; ctx.fillRect(deskX - 15, deskY - 20, 30, 25); 
                
                const hue = (monitorHueOffset + i * 10) % 360;
                const saturation = isLogoComplete ? '100%' : '70%';
                const lightness = isLogoComplete ? '60%' : '80%';
                ctx.fillStyle = `hsl(${hue}, ${saturation}, ${lightness})`;
                if(isLogoComplete) { ctx.shadowColor = `hsl(${hue}, 100%, 50%)`; ctx.shadowBlur = 15; }
                ctx.fillRect(deskX - 13, deskY - 18, 26, 20); ctx.shadowBlur = 0;
            }
        });
        // [í°íŠ¸ ìˆ˜ì •] ì €ì‘ê¶Œ í‘œì‹œë„ Pretendard
        ctx.fillStyle = '#94a3b8'; ctx.font = 'bold 15px "Pretendard", sans-serif'; ctx.textAlign='right'; ctx.fillText('Â©shimhayeon', canvas.width - 50, canvas.height - 30);
    }
    
    function animate() {
        const now = Date.now(); if (now - lastDropTime > CONFIG.dropInterval) { const p = particles.find(p => p.state === 'WAITING'); if (p) { p.state = 'FALLING'; lastDropTime = now; } }
        ctx.clearRect(0, 0, canvas.width, canvas.height); drawEnvironment(); fairies.forEach(f => { f.update(); f.draw(); }); particles.forEach(p => { p.update(); p.draw(); });
        if (hoveredFairy) { hoveredFairy.drawBubble(); canvas.style.cursor = 'pointer'; } else { canvas.style.cursor = 'default'; }
        
        const placedCount = particles.filter(p => p.state === 'PLACED').length;
        isLogoComplete = (placedCount === particles.length && particles.length > 0);
        monitorHueOffset += isLogoComplete ? 5 : 1; 

        ctx.save(); 
        if (isLogoComplete) {
             const hue = (monitorHueOffset * 2) % 360;
             ctx.globalAlpha = 0.8; ctx.fillStyle = `hsl(${hue}, 100%, 60%)`; ctx.shadowColor = `hsl(${hue}, 100%, 50%)`; ctx.shadowBlur = 30;
        } else { ctx.globalAlpha = 0.05; ctx.fillStyle = '#000'; }
        ctx.font = CONFIG.font; ctx.textAlign='center'; ctx.fillText(CONFIG.text, canvas.width/2, canvas.height/2); ctx.restore();

        requestAnimationFrame(animate);
    }
    
    async function loadInitialMessages() {
        try {
            const response = await fetch(GOOGLE_SCRIPT_URL);
            const data = await response.json(); 
            if (data && data.length > 0) {
                const recent10 = data.slice(0, 10);
                const shuffledFairies = [...fairies].sort(() => 0.5 - Math.random());
                recent10.forEach((row, idx) => {
                    if (idx < shuffledFairies.length) {
                        const f = shuffledFairies[idx];
                        f.assignedMessage = { name: row[1], text: row[2] };
                        f.assignmentTime = Date.now(); 
                    }
                });
            }
        } catch (e) { console.error("Initial fetch failed:", e); }
    }

    canvas.addEventListener('touchstart', (e) => {
        if (e.target.closest('#input-bar') || e.target.closest('#modal-overlay') || e.target.closest('#audio-btn') || e.target.closest('.modal-window')) return;
        const touch = e.touches[0]; const rect = canvas.getBoundingClientRect(); const tx = touch.clientX - rect.left; const ty = touch.clientY - rect.top;
        
        // ì‘ì—…ë°˜ì¥ í´ë¦­ ë¡œì§ ì œê±° (ì´ì œ ìš°í¸í•¨ ë²„íŠ¼ ì‚¬ìš©)
        
        let touchedFairy = false;
        fairies.forEach(f => {
            if (Math.abs(tx - f.x) < 40 && Math.abs(ty - f.y) < 50) {
                touchedFairy = true;
                if (f.assignedMessage) {
                    hoveredFairy = f; playSound('pop'); setTimeout(() => { hoveredFairy = null; }, 3000);
                } else { f.giveVacation(); }
            }
        });
        if (!touchedFairy) {
            const cx = canvas.width / 2; const cy = canvas.height / 2;
            if (tx > cx - 200 && tx < cx + 200 && ty > cy - 80 && ty < cy + 80) {
                particles.forEach(p => { if (p.state === 'PLACED') p.reset(); });
                fairies.forEach(f => { if(!f.isPaused) { if(f.targetItem) { f.targetItem.reset(); f.targetItem = null; } f.state = 'IDLE'; } });
                playSound('reset');
            }
        }
    }, { passive: false });

    window.addEventListener('mousedown', (e) => {
        if (e.target.closest('#input-bar') || e.target.closest('#modal-overlay') || e.target.closest('.modal-window') || e.target.closest('#view-all-btn') || e.target.closest('#audio-btn')) return;
        const rect = canvas.getBoundingClientRect(); const cx = e.clientX - rect.left; const cy = e.clientY - rect.top;
        
        // ì‘ì—…ë°˜ì¥ í´ë¦­ ë¡œì§ ì œê±° (ì´ì œ ìš°í¸í•¨ ë²„íŠ¼ ì‚¬ìš©)

        let clickedFairy = false; fairies.forEach(f => { if (Math.sqrt(Math.pow(cx-f.x,2)+Math.pow(cy-f.y,2)) < 30) { f.giveVacation(); clickedFairy = true; } }); if (clickedFairy) return;
        if (cx > canvas.width/2 - 250 && cx < canvas.width/2 + 250 && cy > canvas.height/2 - 80 && cy < canvas.height/2 + 80) { 
            particles.forEach(p => { if (p.state === 'PLACED') p.reset(); }); 
            fairies.forEach(f => { if(!f.isPaused) { if(f.targetItem) { f.targetItem.reset(); f.targetItem = null; } f.state = 'IDLE'; } }); 
            playSound('reset');
        }
    });

    let prevHoveredFairy = null; 
    window.addEventListener('mousemove', (e) => {
        const rect = canvas.getBoundingClientRect(); mouseX = e.clientX - rect.left; mouseY = e.clientY - rect.top;
        
        // ì»¤ì„œ í¬ì¸í„° ë³€ê²½ ë¡œì§ (ì‘ì—…ë°˜ì¥ ë¶€ë¶„ ì œê±°)

        let closest = null; let minDist = 30; 
        fairies.forEach(f => { const dx = mouseX - f.x; const dy = mouseY - f.y; const dist = Math.sqrt(dx*dx + dy*dy); if (dist < minDist) { minDist = dist; closest = f; } }); 
        hoveredFairy = closest;
        
        if (hoveredFairy) {
            canvas.style.cursor = 'pointer';
        } else {
            canvas.style.cursor = 'default';
        }

        if (closest !== prevHoveredFairy) {
            if (closest && closest.assignedMessage) { playSound('pop'); }
            prevHoveredFairy = closest;
        }
    });
    
    window.addEventListener('resize', init); 
    init(); 
    loadInitialMessages(); 
    animate();
</script>
</body>
</html>
